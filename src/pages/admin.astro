---
// src/pages/admin.astro
import Layout from '../components/layout/Layout.astro';
import { supabase } from '../lib/supabase';
import { getRaidName } from '../lib/raids';

// Check for admin password
const ADMIN_PASSWORD = import.meta.env.ADMIN_PASSWORD || import.meta.env.VITE_ADMIN_PASSWORD;

// Validate that the admin password is set in production
if (import.meta.env.PROD && !ADMIN_PASSWORD) {
  console.error('Error: ADMIN_PASSWORD is not set in environment variables');
  throw new Error('Server configuration error: Admin password not set');
}

// For development, use a default password if not set
const devPassword = 'admin123'; // Change this to your preferred default dev password
const isDev = import.meta.env.DEV;

const session = Astro.cookies.get('admin_session')?.value;

// Initialize messages
let errorMessage = '';
let successMessage = '';
let registrations = [];
let isLoading = true;

// Debug: Log environment variables (remove in production)
console.log('Supabase URL:', import.meta.env.VITE_SUPABASE_URL ? 'Set' : 'Not set');

if (!session) {
  // If form was submitted
  if (Astro.request.method === 'POST') {
    const formData = await Astro.request.formData();
    const password = formData.get('password');
    const currentPassword = isDev && !ADMIN_PASSWORD ? devPassword : ADMIN_PASSWORD;
    
    if (password === currentPassword) {
      Astro.cookies.set('admin_session', 'authenticated', {
        path: '/',
        maxAge: 60 * 60 * 8, // 8 hours
        httpOnly: true,
        secure: import.meta.env.PROD
      });
      return Astro.redirect('/admin');
    } else {
      return Astro.redirect('/admin?error=invalid');
    }
  }
  
  // Set login form messages
  const error = Astro.url.searchParams.get('error');
  errorMessage = error === 'invalid' ? 'Contraseña incorrecta' : '';
  const success = Astro.url.searchParams.get('success');
  successMessage = success === 'updated' ? 'Solicitud actualizada correctamente' : '';
  isLoading = false;
} else {
  try {
    console.log('Fetching registrations...');
    const { data, error } = await supabase
      .from('raid_registrations')
      .select('*')
      .order('id', { ascending: false });

    if (error) {
      console.error('Error fetching registrations:', error);
      errorMessage = `Error al cargar las solicitudes: ${error.message}`;
    } else {
      console.log('Registrations loaded:', data?.length || 0);
      registrations = data || [];
    }
  } catch (err) {
    console.error('Unexpected error:', err);
    errorMessage = 'Error inesperado al cargar los datos';
  } finally {
    isLoading = false;
  }
}
---

{/* If not authenticated, show login form */}
{!session ? (
  <Layout title="Admin - Iniciar Sesión">
    <div class="min-h-screen bg-gray-900 flex flex-col justify-center py-12 sm:px-6 lg:px-8">
      <div class="sm:mx-auto sm:w-full sm:max-w-md">
        <h2 class="mt-6 text-center text-3xl font-extrabold text-white">Panel de Administración</h2>
        {errorMessage && (
          <div class="mt-4 bg-red-900/50 border border-red-700 text-red-200 px-4 py-3 rounded">
            {errorMessage}
          </div>
        )}
        {successMessage && (
          <div class="mt-4 bg-green-900/50 border border-green-700 text-green-200 px-4 py-3 rounded">
            {successMessage}
          </div>
        )}
      </div>

      <div class="mt-8 sm:mx-auto sm:w-full sm:max-w-md">
        <div class="bg-gray-800/50 backdrop-blur-sm py-8 px-4 shadow sm:rounded-lg sm:px-10">
          <form class="space-y-6" method="POST">
            <div>
              <label for="password" class="block text-sm font-medium text-gray-300">
                Contraseña de administrador
              </label>
              <div class="mt-1">
                <input
                  id="password"
                  name="password"
                  type="password"
                  required
                  class="appearance-none block w-full px-3 py-2 border border-gray-700 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-amber-500 focus:border-amber-500 sm:text-sm bg-gray-900 text-white"
                >
              </div>
            </div>

            <div>
              <button
                type="submit"
                class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-amber-600 hover:bg-amber-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-amber-500"
              >
                Iniciar sesión
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </Layout>
) : (
  <Layout title="Admin - Gestión de Solicitudes">
    <div class="min-h-screen bg-gradient-to-br from-gray-900 via-gray-800 to-gray-900 py-12 px-4 sm:px-6 lg:px-8">
      <div class="max-w-7xl mx-auto">
        <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-8 p-6 rounded-xl bg-gradient-to-r from-gray-800/80 to-gray-900/80 border border-gray-700/50 shadow-xl space-y-4 md:space-y-0">
          <div>
            <div class="flex items-center space-x-4">
              <h1 class="text-3xl font-bold bg-gradient-to-r from-amber-400 to-amber-600 bg-clip-text text-transparent">
                Gestión de Solicitudes
              </h1>
              <form method="POST" action="/api/admin/logout" class="inline">
                <button 
                  type="submit"
                  class="px-3 py-1.5 text-sm font-medium text-amber-400 hover:text-white bg-amber-900/30 hover:bg-amber-800/50 border border-amber-700/50 rounded-lg transition-all duration-200 flex items-center space-x-1.5"
                >
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
                  </svg>
                  <span>Cerrar sesión</span>
                </button>
              </form>
            </div>
            <p class="text-gray-400 mt-2">Administra las solicitudes de registro a las raids</p>
          </div>
        </div>

        {errorMessage && (
          <div class="mb-4 bg-red-900/50 border border-red-700 text-red-200 px-4 py-3 rounded">
            {errorMessage}
          </div>
        )}

        {isLoading ? (
          <div class="flex justify-center items-center h-64">
            <div class="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-amber-500"></div>
          </div>
        ) : (
          <div class="bg-gray-800/50 backdrop-blur-sm shadow overflow-hidden sm:rounded-lg">
            {registrations.length === 0 ? (
              <div class="text-center py-12">
                <p class="text-gray-400">No hay solicitudes para mostrar</p>
              </div>
            ) : (
              <div class="space-y-6">
                {Array.from(new Set(registrations.map(r => r.raid_id))).sort().map(raidId => {
                  const raidName = getRaidName(raidId);
                  const raidRegistrations = registrations.filter(r => r.raid_id === raidId);
                  
                  return (
                    <div class="raid-group backdrop-blur-sm bg-gradient-to-br from-gray-800/60 to-gray-900/60 rounded-xl overflow-hidden border border-gray-700/50 shadow-2xl">
                      <button 
                        type="button"
                        class="w-full px-6 py-4 text-left text-lg font-medium bg-gradient-to-r from-amber-500/10 to-amber-600/10 hover:from-amber-500/20 hover:to-amber-600/20 transition-all duration-200 focus:outline-none group"
                        onclick="this.nextElementSibling.classList.toggle('hidden')"
                      >
                        <div class="flex flex-col w-full">
                          <div class="flex justify-between items-center w-full">
                            <div class="relative">
                              <span class="text-amber-400 group-hover:text-amber-300 transition-colors font-bold">
                                {raidName}
                              </span>
                              <span class="absolute -bottom-1 left-0 w-0 h-0.5 bg-amber-400 group-hover:w-full transition-all duration-300"></span>
                            </div>
                            <div class="flex items-center space-x-2">
                              <div class="flex items-center space-x-1">
                                <span class="status-count-en_revision px-2 py-0.5 rounded-full text-[10px] font-medium bg-blue-500/20 text-blue-300">
                                  {raidRegistrations.filter(r => r.status === 'en_revision').length} Revisión
                                </span>
                                <span class="status-count-aceptado px-2 py-0.5 rounded-full text-[10px] font-medium bg-green-900/30 text-green-300">
                                  {raidRegistrations.filter(r => r.status === 'aceptado').length} Aceptado
                                </span>
                                <span class="status-count-en_espera px-2 py-0.5 rounded-full text-[10px] font-medium bg-amber-500/20 text-amber-300">
                                  {raidRegistrations.filter(r => r.status === 'en_espera').length} En espera
                                </span>
                              </div>
                              <svg class="w-4 h-4 text-amber-400 transform transition-transform group-hover:rotate-180" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                              </svg>
                            </div>
                          </div>
                          
                          <div class="mt-2 w-full bg-gray-700/30 rounded-full h-1.5 overflow-hidden">
                            <div 
                              class="progress-bar-fill h-full bg-gradient-to-r from-blue-500 to-green-500 transition-all duration-500"
                              style={`width: ${(raidRegistrations.filter(r => r.status === 'aceptado').length / Math.max(1, raidRegistrations.length)) * 100}%`}
                            ></div>
                          </div>
                          
                          <div class="flex justify-between mt-1">
                            <span class="text-xs text-gray-400">
                              {raidRegistrations.length} total
                            </span>
                            <span class="text-xs text-amber-400">
                              {Math.round((raidRegistrations.filter(r => r.status === 'aceptado').length / Math.max(1, raidRegistrations.length)) * 100)}% completado
                            </span>
                          </div>
                        </div>
                      </button>
                      <div class="hidden overflow-x-auto">
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 p-4">
                          {raidRegistrations.map((reg) => (
                            <div class="registration-card backdrop-blur-sm bg-gradient-to-br from-gray-800/60 to-gray-900/60 rounded-xl p-4 border border-gray-700/50 hover:border-amber-500/30 hover:shadow-lg hover:shadow-amber-500/10 transition-all duration-300">
                              <div class="flex justify-between items-start">
                                <div>
                                  <div class="font-bold text-white">{reg.player_name}</div>
                                  <div class="text-xs text-amber-100/80 mt-1">
                                    <span class="text-amber-400">{reg.player_class}</span> • 
                                    <span class="text-blue-300">{reg.player_role}</span> • 
                                    <span class="text-green-300">GS: {reg.gear_score}</span>
                                  </div>
                                  <div class="text-xs text-gray-400 mt-1 flex items-center space-x-2">
                                    <span class="px-2 py-0.5 bg-gray-700/50 rounded-full">{reg.day_of_week}</span>
                                    <span class="px-2 py-0.5 bg-gray-700/50 rounded-full">{reg.start_time}</span>
                                    {reg.raid_role && <span class="px-2 py-0.5 bg-amber-900/30 text-amber-300 rounded-full">{reg.raid_role}</span>}
                                  </div>
                                </div>
                                <span class={`status-badge px-2.5 py-1 text-xs font-semibold rounded-full shadow-md ${
                                  reg.status === 'aceptado' ? 'bg-gradient-to-r from-green-600/90 to-green-700/90 text-green-100' : 
                                  reg.status === 'en_espera' ? 'bg-gradient-to-r from-amber-600/90 to-amber-700/90 text-amber-100' : 
                                  'bg-gradient-to-r from-blue-600/90 to-blue-700/90 text-blue-100'
                                }`}>
                                  {reg.status.replace('_', ' ').replace(/\b\w/g, (l: string) => l.toUpperCase())}
                                </span>
                              </div>
                              
                              <div class="flex justify-between items-center mt-3 pt-3 border-t border-gray-700/50">
                                <div class="flex space-x-1">
                                  <form method="post" action="/api/admin/update-status" class="inline update-status-form">
                                    <input type="hidden" name="id" value={reg.id} />
                                    <input type="hidden" name="status" value="aceptado" />
                                    <button
                                      type="submit"
                                      data-status="aceptado"
                                      class={`p-1.5 rounded-lg transition-all ${reg.status === 'aceptado' ? 'bg-green-600/20 text-green-300' : 'text-green-400 hover:bg-green-900/40 hover:text-green-300'}`}
                                      disabled={reg.status === 'aceptado'}
                                      title="Aprobar"
                                    >
                                      <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                                        <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
                                      </svg>
                                    </button>
                                  </form>
                                  <form method="post" action="/api/admin/update-status" class="inline update-status-form">
                                    <input type="hidden" name="id" value={reg.id} />
                                    <input type="hidden" name="status" value="en_espera" />
                                    <button
                                      type="submit"
                                      data-status="en_espera"
                                      class={`p-1.5 rounded-lg transition-all ${reg.status === 'en_espera' ? 'bg-amber-600/20 text-amber-300' : 'text-amber-400 hover:bg-amber-900/40 hover:text-amber-300'}`}
                                      disabled={reg.status === 'en_espera'}
                                      title="Poner en espera"
                                    >
                                      <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd" />
                                      </svg>
                                    </button>
                                  </form>
                                  <form method="post" action="/api/admin/update-status" class="inline update-status-form">
                                    <input type="hidden" name="id" value={reg.id} />
                                    <input type="hidden" name="status" value="en_revision" />
                                    <button
                                      type="submit"
                                      data-status="en_revision"
                                      class={`p-1.5 rounded-lg transition-all ${reg.status === 'en_revision' ? 'bg-blue-600/20 text-blue-300' : 'text-blue-400 hover:bg-blue-900/40 hover:text-blue-300'}`}
                                      disabled={reg.status === 'en_revision'}
                                      title="Marcar para revisión"
                                    >
                                      <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                                        <path d="M10 12a2 2 0 100-4 2 2 0 000 4z" />
                                        <path fill-rule="evenodd" d="M.458 10C1.732 5.943 5.522 3 10 3s8.268 2.943 9.542 7c-1.274 4.057-5.064 7-9.542 7S1.732 14.057.458 10zM14 10a4 4 0 11-8 0 4 4 0 018 0z" clip-rule="evenodd" />
                                      </svg>
                                    </button>
                                  </form>
                                </div>
                                <form method="post" action="/api/admin/delete" class="inline delete-form" id="delete-form-{reg.id}">
                                  <input type="hidden" name="id" value={reg.id} />
                                  <button
                                    type="button"
                                    class="p-1.5 rounded-lg text-red-400 hover:bg-red-900/40 hover:text-red-300 transition-all"
                                    onclick="if(confirm('¿Estás seguro de eliminar esta solicitud?')) { this.closest('form').submit(); }"
                                    title="Eliminar"
                                  >
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                                      <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" />
                                    </svg>
                                  </button>
                                </form>
                              </div>
                            </div>
                          ))}
                        </div>
                      </div>
                    </div>
                  );
                })}
              </div>
            )}
          </div>
        )}
      </div>
    </div>
  </Layout>
)
