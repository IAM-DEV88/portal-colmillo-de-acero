---
import Layout from '../components/layout/Layout.astro';
import { supabase } from '../lib/supabase';
// Import components

// Función auxiliar para contar jugadores por rol
type PlayerRole = 'tank' | 'heal' | 'melee' | 'ranged';

function countPlayersByRole(players) {
  return (
    players?.reduce(
      (acc, player) => {
        const role = player.role?.toLowerCase() || '';
        const playerRole = player.player_role?.toLowerCase() || '';
        const className = player.player_class?.toLowerCase() || '';

        // Verificar si es tanque
        if (
          role.includes('tank') ||
          playerRole.includes('tank') ||
          role.includes('tanque') ||
          playerRole.includes('tanque')
        ) {
          acc.tank = (acc.tank || 0) + 1;
        }
        // Verificar si es sanador
        else if (
          role.includes('heal') ||
          role.includes('sanador') ||
          role.includes('sanación') ||
          playerRole.includes('heal') ||
          playerRole.includes('sanador') ||
          playerRole.includes('sanación')
        ) {
          acc.heal = (acc.heal || 0) + 1;
        }
        // Verificar DPS (cuerpo a cuerpo o a distancia)
        else {
          // Verificar si el rol específico es 'cuerpo a cuerpo' o 'melee'
          if (
            role.includes('cuerpo a cuerpo') ||
            playerRole.includes('cuerpo a cuerpo') ||
            role.includes('melee') ||
            playerRole.includes('melee')
          ) {
            acc.melee = (acc.melee || 0) + 1;
          }
          // Verificar si es 'a distancia' o 'ranged'
          else if (
            role.includes('a distancia') ||
            playerRole.includes('a distancia') ||
            role.includes('ranged') ||
            playerRole.includes('ranged') ||
            role.includes('rango') ||
            playerRole.includes('rango')
          ) {
            acc.ranged = (acc.ranged || 0) + 1;
          }
          // Si no está especificado, intentar determinarlo por clase
          else {
            // Clases que siempre son cuerpo a cuerpo (o mayoritariamente)
            const meleeClasses = [
              'warrior',
              'paladin',
              'deathknight',
              'death-knight',
              'rogue',
              'guerrero',
              'paladín',
              'pícaro',
              'caballero de la muerte',
            ];
            // Especializaciones que son cuerpo a cuerpo
            const meleeSpecs = [
              'feral',
              'enhancement',
              'retribution',
              'combat',
              'assassination',
              'fury',
              'arms',
              'subtlety',
              'protection', // Should be tank but just in case
              'unholy',
              'frost',
              'blood',
            ];

            const isMelee =
              meleeClasses.some((c) => className.includes(c)) ||
              meleeSpecs.some((s) => role.includes(s) || playerRole.includes(s));

            if (isMelee) {
              acc.melee = (acc.melee || 0) + 1;
            } else {
              // Por defecto, considerar como ranged si no es tanque ni sanador
              acc.ranged = (acc.ranged || 0) + 1;
            }
          }
        }
        return acc;
      },
      { tank: 0, heal: 0, melee: 0, ranged: 0 }
    ) || { tank: 0, heal: 0, melee: 0, ranged: 0 }
  );
}

// Define types
interface Raid {
  id: number;
  name: string;
  image: string;
  description: string;
  minGearScore: number;
}

interface Player {
  name: string;
  class: string;
  role: string;
  status?: string; // Optional status field
  raid_status?: string; // Optional raid_status field
}

interface RaidSchedule {
  id: number;
  raid_id: number;
  raid_name: string;
  difficulty: string;
  day_of_week: string;
  start_time: string;
  players: Player[];
}

// WotLK Raid Information
const wotlkRaids: Raid[] = [
  {
    id: 1,
    name: 'TOC 10N FARM',
    image: '/images/raids/tocfarm.jpg',
    description:
      'Se ponen a prueba el conocimiento de mecanicas de grupo y habilidad para el combate.',
    minGearScore: 4700,
  },
  {
    id: 2,
    name: 'ICC 10N FARM',
    image: '/images/raids/iccfarm.jpg',
    description:
      'Se ponen a prueba el conocimiento de mecanicas de grupo y habilidad para el combate.',
    minGearScore: 5000,
  },
  {
    id: 3,
    name: 'ICC 25N FARM',
    image: '/images/raids/iccfarm.jpg',
    description:
      'Se ponen a prueba el conocimiento de mecanicas de grupo y habilidad para el combate.',
    minGearScore: 5300,
  },
  {
    id: 4,
    name: 'ICC 10N POR LK',
    image: '/images/raids/icclk.jpg',
    description: 'Jugadores con experiencia que buscan el logro de ICC10N.',
    minGearScore: 5600,
  },
  {
    id: 5,
    name: 'SAGRARIO RUBY',
    image: '/images/raids/sr.jpg',
    description: 'Jugadores con experiencia que buscan el logro de SR.',
    minGearScore: 5700,
  },
  {
    id: 6,
    name: 'ICC 25N POR LK',
    image: '/images/raids/icclk.jpg',
    description: 'Jugadores con experiencia que buscan el logro de ICC25N.',
    minGearScore: 5700,
  },
  {
    id: 7,
    name: 'ICC 10H FARM',
    image: '/images/raids/iccfarm.jpg',
    description:
      'Se ponen a prueba el conocimiento de mecanicas de grupo y habilidad para el combate.',
    minGearScore: 5900,
  },
  {
    id: 8,
    name: 'ICC 25H FARM',
    image: '/images/raids/iccfarm.jpg',
    description:
      'Se ponen a prueba el conocimiento de mecanicas de grupo y habilidad para el combate.',
    minGearScore: 6000,
  },
];

// Fetch raid schedules from Supabase
let raidSchedules: RaidSchedule[] = [];
let error: string | null = null;

// Function to get the next upcoming schedule
// Function to get sorted schedules including the 1 hour buffer
function getSortedSchedules(schedules) {
  if (!schedules || schedules.length === 0) return [];

  const dayOrder = {
    lunes: 1,
    martes: 2,
    miercoles: 3,
    miércoles: 3,
    jueves: 4,
    viernes: 5,
    sabado: 6,
    sábado: 6,
    domingo: 7,
  };

  return schedules
    .filter((schedule) => {
      if (!schedule.players || schedule.players.length === 0) return false;
      return schedule.players.some(
        (player) =>
          ['aceptado', 'accepted', 'confirmed'].includes(player.status) ||
          ['aceptado', 'accepted', 'confirmed'].includes(player.raid_status) ||
          ['aceptado', 'accepted', 'confirmed'].includes(player.registration_status)
      );
    })
    .sort((a, b) => {
      const dayA = a.day_of_week
        .toLowerCase()
        .normalize('NFD')
        .replace(/[\u0300-\u036f]/g, '');
      const dayB = b.day_of_week
        .toLowerCase()
        .normalize('NFD')
        .replace(/[\u0300-\u036f]/g, '');

      const orderA = dayOrder[dayA] || 99;
      const orderB = dayOrder[dayB] || 99;

      if (orderA !== orderB) {
        return orderA - orderB;
      }

      return a.start_time.localeCompare(b.start_time);
    });
}

// Group schedules by day and raid
try {
  // Handle form submission
  if (Astro.request.method === 'POST') {
    console.log('POST request received');
    try {
      const formData = await Astro.request.formData();
      console.log('Raw form data entries:');
      for (const [key, value] of formData.entries()) {
        console.log(`- ${key}:`, value);
      }

      const formDataObj = Object.fromEntries(formData.entries());
      console.log('Processed form data:', formDataObj);

      // Define registration data with index signature
      const registrationData: {
        player_name: string;
        player_class: string;
        player_role: string;
        raid_role: string;
        day_of_week: string;
        start_time: string;
        raid_id: string;
        [key: string]: string; // Index signature
      } = {
        player_name: formDataObj.player_name?.toString() || '',
        player_class: formDataObj.player_class?.toString() || '',
        player_role: formDataObj.player_role?.toString() || '',
        raid_role: formDataObj.raid_role?.toString() || '',
        day_of_week: formDataObj.day_of_week?.toString() || '',
        start_time: formDataObj.start_time?.toString() || '',
        raid_id: formDataObj.raid_id?.toString() || '',
      };

      console.log('Processed registration data:', registrationData);

      // Validate required fields
      const requiredFields = [
        'player_name',
        'player_class',
        'player_role',
        'raid_role',
        'day_of_week',
        'start_time',
        'raid_id',
      ];
      const missingFields = requiredFields.filter((field) => !registrationData[field]);

      if (missingFields.length > 0) {
        return new Response(
          JSON.stringify({
            error: 'Faltan campos requeridos',
            missingFields,
          }),
          {
            status: 400,
            headers: {
              'Content-Type': 'application/json',
            },
          }
        );
      }

      // Check for existing registrations within the time window
      const startTime = new Date(`1970-01-01T${registrationData.start_time}:00`);
      const minTime = new Date(startTime);
      minTime.setHours(minTime.getHours() - 3);
      const maxTime = new Date(startTime);
      maxTime.setHours(maxTime.getHours() + 3);

      // Format times for Supabase query
      const formatTime = (date) => date.toTimeString().substring(0, 5);

      const { data: existingRegistrations, error: checkError } = await supabase
        .from('raid_registrations')
        .select('*')
        .eq('player_name', registrationData.player_name)
        .eq('day_of_week', registrationData.day_of_week)
        .gte('start_time', formatTime(minTime))
        .lte('start_time', formatTime(maxTime));

      if (checkError) {
        console.error('Error checking existing registrations:', checkError);
        throw new Error('Error al verificar registros existentes');
      }

      if (existingRegistrations && existingRegistrations.length > 0) {
        const existing = existingRegistrations[0];
        return new Response(
          JSON.stringify({
            error: 'Ya tienes un registro en este horario',
            details: `Ya estás registrado en una raid el ${existing.day_of_week} a las ${existing.start_time}. No puedes registrarte en otra raid 3 horas antes o después.`,
          }),
          {
            status: 400,
            headers: { 'Content-Type': 'application/json' },
          }
        );
      }

      // If we get here, all validations passed
      console.log('Attempting to insert into Supabase...');

      // Prepare the data to insert
      const insertData = {
        player_name: registrationData.player_name,
        player_class: registrationData.player_class,
        player_role: registrationData.player_role,
        raid_role: registrationData.raid_role,
        day_of_week: registrationData.day_of_week,
        start_time: registrationData.start_time,
        raid_id: parseInt(registrationData.raid_id) || 0,
        status: 'en_revision',
      };

      console.log('Data to insert:', insertData);

      // Insert into Supabase
      console.log('Attempting to insert into Supabase table: raid_registrations');
      console.log('Insert data:', JSON.stringify(insertData, null, 2));

      try {
        const { data: result, error: insertError } = await supabase
          .from('raid_registrations')
          .insert([insertData])
          .select();

        if (insertError) {
          console.error('Supabase error details:', insertError);
          throw insertError;
        }

        console.log('Insert successful, result:', result);

        // Return success response
        return new Response(
          JSON.stringify({
            success: true,
            data: result[0],
          }),
          {
            status: 200,
            headers: {
              'Content-Type': 'application/json',
            },
          }
        );
      } catch (dbError) {
        console.error('Database error details:', {
          name: dbError.name,
          message: dbError.message,
          code: dbError.code,
          details: dbError.details,
          hint: dbError.hint,
          stack: dbError.stack,
        });
        throw dbError;
      }

      // El retorno de éxito ahora está dentro del bloque try
    } catch (error) {
      console.error('Error processing form submission:', error);
      return new Response(
        JSON.stringify({
          error: 'Error al procesar la solicitud',
          details: error.message,
        }),
        {
          status: 500,
          headers: {
            'Content-Type': 'application/json',
          },
        }
      );
    }

    try {
      console.log('Attempting to insert into Supabase...');

      // Prepare the data to insert
      const insertData = {
        player_name: registrationData.player_name,
        player_class: registrationData.player_class,
        player_role: registrationData.player_role,
        raid_role: registrationData.raid_role,
        day_of_week: registrationData.day_of_week,
        start_time: registrationData.start_time,
        raid_id: parseInt(registrationData.raid_id) || 0,
        status: 'en_revision',
        created_at: new Date().toISOString(),
      };

      console.log('Data to insert:', insertData);

      // Insert into Supabase
      const { data: result, error } = await supabase
        .from('raid_registrations')
        .insert([insertData])
        .select();

      if (error) {
        console.error('Supabase error details:', error);
        throw error;
      }

      // Redirect to prevent form resubmission
      return new Response(
        JSON.stringify({
          success: true,
          data: result[0],
        }),
        {
          status: 200,
          headers: {
            'Content-Type': 'application/json',
          },
        }
      );
    } catch (error) {
      console.error('Error saving registration:', error);
      return new Response(
        JSON.stringify({
          error: 'Error al guardar el registro',
          details: error.message,
        }),
        { status: 500 }
      );
    }
  }

  // Mapeo de días de la semana a números para ordenar
  const dayOrder = {
    lunes: 1,
    martes: 2,
    miercoles: 3,
    jueves: 4,
    viernes: 5,
    sabado: 6,
    domingo: 7,
  };

  // Obtener el día actual en español
  const days = ['domingo', 'lunes', 'martes', 'miercoles', 'jueves', 'viernes', 'sabado'];
  const todayIndex = new Date().getDay(); // 0 (domingo) a 6 (sábado)
  const today = days[todayIndex];

  // Get all raid schedules with different statuses
  const { data: raidSchedulesData, error: fetchError } = await supabase
    .from('raid_registrations')
    .select(
      `
      id,
      raid_id,
      player_name,
      player_class,
      player_role,
      raid_role,
      day_of_week,
      start_time,
      status
    `
    )
    .in('status', ['aceptado', 'en_revision', 'en_espera'])
    .order('day_of_week', { ascending: true })
    .order('start_time', { ascending: true });

  // Ordenar los horarios para que el próximo sea el primero
  if (raidSchedulesData) {
    raidSchedulesData.sort((a, b) => {
      // Primero por día de la semana (empezando por hoy)
      const dayDiffA = (dayOrder[a.day_of_week] + 7 - dayOrder[today]) % 7;
      const dayDiffB = (dayOrder[b.day_of_week] + 7 - dayOrder[today]) % 7;

      if (dayDiffA !== dayDiffB) {
        return dayDiffA - dayDiffB;
      }

      // Si es el mismo día, ordenar por hora
      return a.start_time.localeCompare(b.start_time);
    });
  }

  // Only show 'aceptado' status in the display
  const displaySchedules =
    raidSchedulesData?.filter((schedule) => schedule.status === 'aceptado') || [];

  // Count unique schedule slots (grouped by raid_id, day_of_week, and start_time)
  // Only count 'aceptado' status for schedule totals
  const scheduleCounts = { total: 0 };

  // Get all unique schedule slots with at least one 'aceptado' registration
  const acceptedScheduleSlots = new Set<string>();

  raidSchedulesData?.forEach((schedule) => {
    if (schedule.status === 'aceptado') {
      const slotKey = `${schedule.raid_id}-${schedule.day_of_week}-${schedule.start_time}`;
      acceptedScheduleSlots.add(slotKey);
    }
  });

  scheduleCounts.total = acceptedScheduleSlots.size;

  if (fetchError) throw fetchError;

  // Create a map to group schedules by their unique key (raid_id-day_of_week-start_time)
  const schedulesMap = new Map();

  // First, normalize and process all schedules
  raidSchedulesData?.forEach((reg) => {
    // Normalize day of week (remove accents, convert to lowercase)
    const normalizedDay =
      reg.day_of_week
        ?.toLowerCase()
        .normalize('NFD')
        .replace(/[\u0300-\u036f]/g, '')
        .replace('miércoles', 'miercoles')
        .replace('sábado', 'sabado') || '';

    // Normalize time (ensure consistent format)
    const normalizedTime = reg.start_time?.toString().padStart(5, '0') || '00:00';

    const raid = wotlkRaids.find((r) => r.id === reg.raid_id);
    if (!raid) return;

    // Create a consistent key with normalized values
    const key = `${reg.raid_id}-${normalizedDay}-${normalizedTime}`;

    if (!schedulesMap.has(key)) {
      schedulesMap.set(key, {
        id: reg.id,
        raid_id: reg.raid_id,
        raid_name: raid.name,
        difficulty: reg.difficulty || '10',
        day_of_week: reg.day_of_week || '',
        start_time: normalizedTime,
        players: [],
      });
    }

    // Only add to players list if status is 'aceptado'
    if (reg.status === 'aceptado') {
      const schedule = schedulesMap.get(key);
      schedule.players.push({
        name: reg.player_name,
        class: reg.player_class || 'Desconocida',
        role: reg.player_role || 'DPS',
        raid_role: reg.raid_role || 'asistente',
        status: reg.status,
        raid_status: reg.status,
        registration_status: reg.status,
      });
    }
  });

  // Convert the map values to an array and sort
  raidSchedules = Array.from(schedulesMap.values()).sort((a, b) => {
    // Sort by raid_id first
    if (a.raid_id !== b.raid_id) {
      return a.raid_id - b.raid_id;
    }

    // Then by day of week
    const dayOrder = {
      lunes: 1,
      martes: 2,
      miercoles: 3,
      jueves: 4,
      viernes: 5,
      sabado: 6,
      domingo: 7,
    };

    const dayA =
      a.day_of_week
        ?.toLowerCase()
        .normalize('NFD')
        .replace(/[\u0300-\u036f]/g, '') || '';
    const dayB =
      b.day_of_week
        ?.toLowerCase()
        .normalize('NFD')
        .replace(/[\u0300-\u036f]/g, '') || '';

    const dayAOrder = dayOrder[dayA] || 99;
    const dayBOrder = dayOrder[dayB] || 99;

    if (dayAOrder !== dayBOrder) {
      return dayAOrder - dayBOrder;
    }

    // Finally by start time, with '00:00 ST' always last
    const timeA = (a.start_time || '').replace(' ST', '');
    const timeB = (b.start_time || '').replace(' ST', '');

    // If one of the times is '00:00', it should come last
    if (timeA === '00:00' && timeB !== '00:00') return 1;
    if (timeA !== '00:00' && timeB === '00:00') return -1;

    // If both are '00:00', maintain their order
    if (timeA === '00:00' && timeB === '00:00') return 0;

    // Otherwise, do a normal time comparison
    return timeA.localeCompare(timeB);
  });

  // Log the data for debugging
  console.log('Fetched raid schedules:', raidSchedules);
} catch (err) {
  console.error('Error fetching raid schedules:', err);
  error = 'Error al cargar los horarios de raid. Por favor, inténtalo de nuevo más tarde.';
}
---

<Layout title="Horarios de Raid">
  <div class="text-white">
    <div class="max-w-7xl mx-auto">
      <div class="text-center mb-12">
        <h1 class="text-4xl font-extrabold tracking-tight text-white">
          <span class="block">Horarios de Raid</span>
        </h1>
      </div>

      <div class="relative">
        <div class="relative">
          {
            error && (
              <div
                class="bg-red-900/50 border border-red-700 text-red-200 px-4 py-3 rounded relative mb-6 max-w-7xl mx-auto"
                role="alert"
              >
                <div class="flex items-center">
                  <div class="py-1">
                    <svg
                      class="fill-current h-6 w-6 text-red-300 mr-4"
                      xmlns="http://www.w3.org/2000/svg"
                      viewBox="0 0 20 20"
                    >
                      <path d="M2.93 17.07A10 10 0 1 1 17.07 2.07 10 10 0 0 1 2.93 17.07zm12.73-1.41A8 8 0 1 0 4.34 4.34a8 8 0 0 0 11.32 11.32zM9 11V9h2v6H9v-4zm0-6h2v2H9V5z" />
                    </svg>
                  </div>
                  <div>
                    <p class="font-bold">¡Error!</p>
                    <p class="text-sm">{error}</p>
                  </div>
                </div>
              </div>
            )
          }

          <div class="max-w-7xl mx-auto relative">
            <!-- Custom Slider Container -->
            <div class="slider-container max-w-7xl mx-auto overflow-hidden">
              <!-- Pagination -->
              <div
                class="slider-pagination bg-gray-900/50 backdrop-blur-sm rounded-lg overflow-hidden border border-amber-600/30 transition-all duration-200 hover:border-amber-500/50 hover:shadow-lg hover:shadow-amber-500/10"
                id="slider-pagination"
              >
                {
                  wotlkRaids.map((raid, index) => {
                    const raidSchedulesForRaid = raidSchedules.filter(
                      (schedule) => schedule.raid_id === raid.id
                    );
                    const approvedSchedulesCount = raidSchedulesForRaid.filter((schedule) => {
                      if (!schedule.players) return false;
                      return schedule.players.some(
                        (player) =>
                          player.status === 'aceptado' ||
                          player.raid_status === 'aceptado' ||
                          (player as any).registration_status === 'aceptado' ||
                          player.status === 'accepted' ||
                          player.raid_status === 'accepted' ||
                          (player as any).registration_status === 'accepted' ||
                          player.status === 'confirmed' ||
                          player.raid_status === 'confirmed' ||
                          (player as any).registration_status === 'confirmed'
                      );
                    }).length;

                    return (
                      <button
                        key={raid.id}
                        class="pagination-item group relative"
                        data-index={index}
                        aria-label={`Ir a ${raid.name}`}
                      >
                        <span class="pagination-dot" />
                        <span class="pagination-label">
                          {raid.name}
                          {approvedSchedulesCount > 0 && (
                            <span class="absolute -top-1 left-1/2 transform -translate-x-1/2 -translate-y-1/2 bg-amber-500 text-white text-xs font-bold rounded-full w-5 h-5 flex items-center justify-center group-hover:bg-amber-400 transition-colors">
                              {approvedSchedulesCount}
                            </span>
                          )}
                        </span>
                      </button>
                    );
                  })
                }
              </div>
              <div class="slider-track" id="slider-track">
                {
                  wotlkRaids.map((raid, index) => {
                    const raidSchedulesForRaid = raidSchedules.filter(
                      (schedule) => schedule.raid_id === raid.id
                    );

                    // Only count players with 'aceptado' status for the total
                    const totalPlayers = raidSchedulesForRaid.reduce((sum, sched) => {
                      if (!sched.players) return sum;
                      const acceptedPlayers = sched.players.filter(
                        (player) =>
                          player.status === 'aceptado' ||
                          player.raid_status === 'aceptado' ||
                          player.registration_status === 'aceptado' ||
                          player.status === 'accepted' ||
                          player.raid_status === 'accepted' ||
                          player.registration_status === 'accepted' ||
                          player.status === 'confirmed' ||
                          player.raid_status === 'confirmed' ||
                          player.registration_status === 'confirmed'
                      );
                      return sum + acceptedPlayers.length;
                    }, 0);

                    return (
                      <div class="swiper-slide px-6">
                        <div class="w-full" data-raid-id={raid.id}>
                          <div class="h-full bg-gray-900/70 backdrop-blur-sm rounded-lg overflow-hidden flex flex-col border border-amber-600/30 transition-all duration-200 hover:border-amber-500/50 hover:shadow-lg hover:shadow-amber-500/10">
                            {/* Header with raid image and basic info */}
                            <div class="relative">
                              <img
                                src={raid.image}
                                alt={raid.name}
                                class="w-full h-36 object-cover"
                                onerror="this.onerror=null; this.src='/images/raids/default.jpg'"
                              />
                              <div class="absolute inset-0 bg-gradient-to-t from-gray-900/90 to-transparent" />
                              <div class="absolute bottom-0 left-0 right-0 p-4">
                                <div class="flex justify-between items-end">
                                  <div>
                                    <h3 class="text-xl font-bold text-white">{raid.name}</h3>
                                    <p class="text-xs text-gray-300 flex items-center">
                                      <svg
                                        class="w-3 h-3 mr-1 text-amber-400"
                                        fill="none"
                                        stroke="currentColor"
                                        viewBox="0 0 24 24"
                                      >
                                        <path
                                          stroke-linecap="round"
                                          stroke-linejoin="round"
                                          stroke-width="2"
                                          d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"
                                        />
                                      </svg>
                                      {
                                        raidSchedulesForRaid.filter((schedule) => {
                                          if (!schedule.players) return false;
                                          return schedule.players.some(
                                            (player) =>
                                              player.status === 'aceptado' ||
                                              player.raid_status === 'aceptado' ||
                                              player.registration_status === 'aceptado' ||
                                              player.status === 'accepted' ||
                                              player.raid_status === 'accepted' ||
                                              player.registration_status === 'accepted' ||
                                              player.status === 'confirmed' ||
                                              player.raid_status === 'confirmed' ||
                                              player.registration_status === 'confirmed'
                                          );
                                        }).length
                                      }{' '}
                                      {raidSchedulesForRaid.length === 1 ? 'CORE' : 'CORES'}
                                    </p>
                                  </div>
                                  <div class="flex flex-col items-end">
                                    <span class="text-amber-300 text-xs font-medium">
                                      Gear Score Mínimo
                                    </span>
                                    <span class="bg-amber-500/20 text-amber-300 text-xs font-medium px-2 py-0.5 rounded border border-amber-500/30">
                                      {raid.minGearScore} GS
                                    </span>
                                  </div>
                                </div>
                              </div>
                            </div>

                            {/* Next schedule and role info */}
                            <div class="p-4 bg-gray-900/60">
                              {/* Next schedule */}
                              {/* Schedules List */}
                              <div class="space-y-2 pr-1 max-h-[315px] sm:max-h-[270px] overflow-y-scroll">
                                {(() => {
                                  const sortedSchedules = getSortedSchedules(raidSchedulesForRaid);

                                  if (sortedSchedules.length === 0) {
                                    return (
                                      <div class="text-center text-gray-400 py-4 text-sm">
                                        No hay horarios programados
                                      </div>
                                    );
                                  }

                                  return sortedSchedules.map((schedule, idx) => {
                                    const schedulePlayers =
                                      schedule.players?.filter(
                                        (player) =>
                                          ['aceptado', 'accepted', 'confirmed'].includes(
                                            player.status
                                          ) ||
                                          ['aceptado', 'accepted', 'confirmed'].includes(
                                            player.raid_status
                                          ) ||
                                          ['aceptado', 'accepted', 'confirmed'].includes(
                                            player.registration_status
                                          )
                                      ) || [];

                                    const roleCounts = countPlayersByRole(schedulePlayers);

                                    return (
                                      <div
                                        key={`${schedule.id}-${idx}`}
                                        class="bg-gray-800/50 rounded-lg p-3 border border-gray-700/50 hover:border-amber-500/30 transition-colors"
                                      >
                                        <div class="flex justify-between items-center mb-2">
                                          <div>
                                            <span class="font-medium text-white">
                                              {schedule.day_of_week}
                                            </span>
                                            <span class="mx-2 text-gray-400">•</span>
                                            <span class="text-amber-400">
                                              {schedule.start_time}
                                            </span>
                                            <span class="mx-2 text-gray-400">•</span>
                                            <span class="text-xs text-gray-500">Server</span>
                                          </div>
                                          <div class="flex items-center space-x-2">
                                            {/* Indicators for regulars/leaders */}
                                            <button
                                              data-regulars={JSON.stringify({
                                                regulars: (schedulePlayers || [])
                                                  .filter(
                                                    (p) =>
                                                      !['raid_leader', 'lider_raid'].includes(
                                                        p.raid_role
                                                      )
                                                  )
                                                  .map((p) => ({
                                                    name: String(p.name || ''),
                                                    class: String(p.class || ''),
                                                    role: String(p.raid_role || 'asistente'),
                                                    player_role: String(
                                                      p.player_role || p.role || 'default'
                                                    ),
                                                  })),
                                              })}
                                              onclick="(function(btn) {
                                                try {
                                                  const data = JSON.parse(btn.getAttribute('data-regulars') || '{}');
                                                  const regulars = data.regulars || [];
                                                  openRegularPlayersModal(regulars);
                                                } catch (e) {
                                                  console.error('Error loading regular players:', e);
                                                  openRegularPlayersModal([]);
                                                }
                                              })(this)"
                                              class="text-xs bg-blue-600/30 hover:bg-blue-600/40 text-blue-300 px-1.5 py-0.5 rounded flex items-center transition-colors"
                                              title="Ver jugadores regulares"
                                            >
                                              <svg
                                                class="w-3 h-3 mr-1"
                                                fill="none"
                                                stroke="currentColor"
                                                viewBox="0 0 24 24"
                                              >
                                                <path
                                                  stroke-linecap="round"
                                                  stroke-linejoin="round"
                                                  stroke-width="2"
                                                  d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"
                                                />
                                              </svg>
                                              {
                                                schedulePlayers.filter(
                                                  (p) =>
                                                    !['raid_leader', 'lider_raid'].includes(
                                                      p.raid_role
                                                    )
                                                ).length
                                              }
                                            </button>
                                            <button
                                              data-leaders={JSON.stringify({
                                                leaders: (schedulePlayers || [])
                                                  .filter(
                                                    (p: any) =>
                                                      p &&
                                                      ['raid_leader', 'lider_raid'].includes(
                                                        p.raid_role
                                                      )
                                                  )
                                                  .map((p: any) => ({
                                                    name: String(p.name || ''),
                                                    class: String(p.class || ''),
                                                    role: String(p.raid_role || ''),
                                                    player_role: String(
                                                      p.player_role || p.role || 'default'
                                                    ),
                                                  })),
                                              })}
                                              onclick="(function(btn) {
                                                try {
                                                  const data = JSON.parse(btn.getAttribute('data-leaders') || '{}');
                                                  const leaders = data.leaders || [];
                                                  console.log('Leaders data:', leaders);
                                                  openRaidLeadersModal(leaders);
                                                } catch (e) {
                                                  console.error('Error loading raid leaders:', e);
                                                  openRaidLeadersModal([]);
                                                }
                                              })(this)"
                                              class="text-xs bg-amber-600/30 hover:bg-amber-600/40 text-amber-300 px-1.5 py-0.5 rounded flex items-center transition-colors"
                                              title="Ver líderes de raid"
                                            >
                                              <svg
                                                class="w-3 h-3 mr-1"
                                                fill="none"
                                                stroke="currentColor"
                                                viewBox="0 0 24 24"
                                              >
                                                <path
                                                  stroke-linecap="round"
                                                  stroke-linejoin="round"
                                                  stroke-width="2"
                                                  d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z"
                                                />
                                              </svg>
                                              {
                                                schedulePlayers.filter((p) =>
                                                  ['raid_leader', 'lider_raid'].includes(
                                                    p.raid_role
                                                  )
                                                ).length
                                              }
                                            </button>
                                          </div>
                                        </div>

                                        {/* Role Selection Buttons */}
                                        <div class="mt-3 pt-3 border-t border-gray-700/50">
                                          <div class="grid grid-cols-4 gap-2">
                                            <button
                                              type="button"
                                              class="flex flex-col items-center justify-center p-1.5 rounded bg-blue-900/20 hover:bg-blue-900/40 border border-blue-700/30 hover:border-blue-500/50 transition-all group"
                                              data-raid-name={raid.name}
                                              data-raid-id={raid.id}
                                              data-day={schedule.day_of_week}
                                              data-time={schedule.start_time}
                                              data-role="tank"
                                              onclick="openRegistrationModal(this)"
                                            >
                                              <div class="w-1.5 h-1.5 rounded-full bg-blue-500 mb-1 group-hover:scale-125 transition-transform" />
                                              <span class="text-[10px] text-blue-300 font-medium">
                                                Tank
                                              </span>
                                              <span class="text-[10px] text-gray-400">
                                                {roleCounts.tank}
                                              </span>
                                            </button>
                                            <button
                                              type="button"
                                              class="flex flex-col items-center justify-center p-1.5 rounded bg-green-900/20 hover:bg-green-900/40 border border-green-700/30 hover:border-green-500/50 transition-all group"
                                              data-raid-name={raid.name}
                                              data-raid-id={raid.id}
                                              data-day={schedule.day_of_week}
                                              data-time={schedule.start_time}
                                              data-role="healer"
                                              onclick="openRegistrationModal(this)"
                                            >
                                              <div class="w-1.5 h-1.5 rounded-full bg-green-500 mb-1 group-hover:scale-125 transition-transform" />
                                              <span class="text-[10px] text-green-300 font-medium">
                                                Heal
                                              </span>
                                              <span class="text-[10px] text-gray-400">
                                                {roleCounts.heal}
                                              </span>
                                            </button>
                                            <button
                                              type="button"
                                              class="flex flex-col items-center justify-center p-1.5 rounded bg-red-900/20 hover:bg-red-900/40 border border-red-700/30 hover:border-red-500/50 transition-all group"
                                              data-raid-name={raid.name}
                                              data-raid-id={raid.id}
                                              data-day={schedule.day_of_week}
                                              data-time={schedule.start_time}
                                              data-role="melee"
                                              onclick="openRegistrationModal(this)"
                                            >
                                              <div class="w-1.5 h-1.5 rounded-full bg-red-500 mb-1 group-hover:scale-125 transition-transform" />
                                              <span class="text-[10px] text-red-300 font-medium">
                                                Melee
                                              </span>
                                              <span class="text-[10px] text-gray-400">
                                                {roleCounts.melee}
                                              </span>
                                            </button>
                                            <button
                                              type="button"
                                              class="flex flex-col items-center justify-center p-1.5 rounded bg-purple-900/20 hover:bg-purple-900/40 border border-purple-700/30 hover:border-purple-500/50 transition-all group"
                                              data-raid-name={raid.name}
                                              data-raid-id={raid.id}
                                              data-day={schedule.day_of_week}
                                              data-time={schedule.start_time}
                                              data-role="ranged"
                                              onclick="openRegistrationModal(this)"
                                            >
                                              <div class="w-1.5 h-1.5 rounded-full bg-purple-500 mb-1 group-hover:scale-125 transition-transform" />
                                              <span class="text-[10px] text-purple-300 font-medium">
                                                Ranged
                                              </span>
                                              <span class="text-[10px] text-gray-400">
                                                {roleCounts.ranged}
                                              </span>
                                            </button>
                                          </div>
                                        </div>
                                      </div>
                                    );
                                  });
                                })()}
                              </div>
                            </div>

                            {/* Action button */}
                          </div>
                        </div>
                      </div>
                    );
                  })
                }
              </div>
              <!-- Navigation Buttons -->
              <button class="slider-nav prev" id="slider-prev" aria-label="Anterior">
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  width="24"
                  height="24"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                >
                  <path d="M15 18l-6-6 6-6"></path>
                </svg>
              </button>
              <button class="slider-nav next" id="slider-next" aria-label="Siguiente">
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  width="24"
                  height="24"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                >
                  <path d="M9 18l6-6-6-6"></path>
                </svg>
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  {/* Registration Modal */}
  <div
    id="register-modal"
    class="fixed inset-0 z-50 hidden overflow-y-auto"
    aria-labelledby="modal-title"
    role="dialog"
    aria-modal="true"
  >
    <div
      class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0"
    >
      <div
        class="fixed inset-0 bg-gray-900/80 backdrop-blur-sm transition-opacity"
        aria-hidden="true"
        onclick="closeRegistrationModal()"
      >
      </div>

      <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true"
        >&#8203;</span
      >

      <div
        class="inline-block align-bottom bg-gray-800 rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg w-full border border-gray-700"
      >
        <div class="bg-gray-800 px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
          <div class="sm:flex sm:items-start">
            <div class="mt-3 text-center sm:mt-0 sm:ml-4 sm:text-left w-full">
              <h3 class="text-lg leading-6 font-medium text-white" id="modal-title">
                Unirse a Core
              </h3>
              <div class="mt-2">
                <p class="text-sm text-gray-400 mb-4">
                  Inscribiéndote para: <span id="modal-raid-name" class="text-amber-400 font-bold"
                  ></span>
                  <br />
                  <span id="modal-schedule-info" class="text-gray-300"></span>
                  <br />
                  Rol seleccionado: <span
                    id="modal-role-display"
                    class="capitalize font-bold text-white"></span>
                </p>

                <form id="registration-form" class="space-y-4">
                  <input type="hidden" name="raid_id" id="modal-raid-id" />
                  <input type="hidden" name="day_of_week" id="modal-day" />
                  <input type="hidden" name="start_time" id="modal-time" />
                  <input type="hidden" name="player_role" id="modal-player-role" />

                  <div
                    id="form-errors"
                    class="hidden bg-red-900/50 border border-red-700 text-red-200 p-3 rounded text-sm mb-4"
                  >
                    <p id="error-message"></p>
                  </div>

                  <div>
                    <label for="player-name" class="block text-sm font-medium text-gray-300 mb-1">
                      Nombre del Personaje
                    </label>
                    <input
                      type="text"
                      id="player-name"
                      name="player_name"
                      required
                      class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-md text-white focus:outline-none focus:ring-2 focus:ring-amber-500 focus:border-transparent"
                      placeholder="Nombre exacto en el juego"
                    />
                  </div>

                  <div>
                    <label for="player-class" class="block text-sm font-medium text-gray-300 mb-1">
                      Clase
                    </label>
                    <select
                      id="player-class"
                      name="player_class"
                      required
                      class="w-full bg-gray-700 border border-gray-600 rounded-md px-3 py-2 text-white focus:ring-2 focus:ring-amber-500 focus:border-transparent"
                    >
                      <option value="" disabled selected>Selecciona tu clase</option>
                      <option value="death-knight">Caballero de la Muerte</option>
                      <option value="druid">Druida</option>
                      <option value="hunter">Cazador</option>
                      <option value="mage">Mago</option>
                      <option value="paladin">Paladín</option>
                      <option value="priest">Sacerdote</option>
                      <option value="rogue">Pícaro</option>
                      <option value="shaman">Chamán</option>
                      <option value="warlock">Brujo</option>
                      <option value="warrior">Guerrero</option>
                    </select>
                  </div>

                  <div>
                    <label for="raid-role" class="block text-sm font-medium text-gray-300 mb-1">
                      Rol en Raid
                    </label>
                    <select
                      id="raid-role"
                      name="raid_role"
                      required
                      class="w-full bg-gray-700 border border-gray-600 rounded-md px-3 py-2 text-white focus:ring-2 focus:ring-amber-500 focus:border-transparent"
                    >
                      <option value="asistente" selected>Asistente</option>
                      <option value="raid_leader">Raid Leader</option>
                    </select>
                  </div>

                  <div class="mt-5 sm:mt-4 sm:flex sm:flex-row-reverse">
                    <button
                      type="submit"
                      class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-amber-600 text-base font-medium text-white hover:bg-amber-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-amber-500 sm:ml-3 sm:w-auto sm:text-sm"
                    >
                      Confirmar
                    </button>
                    <button
                      type="button"
                      onclick="closeRegistrationModal()"
                      class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-600 shadow-sm px-4 py-2 bg-gray-700 text-base font-medium text-gray-300 hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500 sm:mt-0 sm:w-auto sm:text-sm"
                    >
                      Cancelar
                    </button>
                  </div>
                </form>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  {/* Weekly Schedule Section */}
  <div class="max-w-7xl mx-auto py-8">
    <div class="bg-gray-900/50 backdrop-blur-sm rounded-xl border border-amber-600/30 p-6">
      <div class="flex items-center justify-between mb-6">
        <h2 class="text-2xl font-bold text-amber-400">Malla Semanal</h2>
      </div>

      <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 lg:grid-cols-7 gap-3">
        {
          ['Lunes', 'Martes', 'Miércoles', 'Jueves', 'Viernes', 'Sábado', 'Domingo'].map((day) => {
            // Normalize day for comparison
            const normalizeDay = (d) =>
              d
                .toLowerCase()
                .normalize('NFD')
                .replace(/[\u0300-\u036f]/g, '');

            const targetDay = normalizeDay(day);

            const daySchedules = raidSchedules
              .filter((s) => normalizeDay(s.day_of_week) === targetDay)
              .sort((a, b) => {
                // Extract time part (remove 'ST' if present)
                const timeA = (a.start_time || '').replace(' ST', '');
                const timeB = (b.start_time || '').replace(' ST', '');

                // Handle '00:00' to appear last
                if (timeA === '00:00' && timeB !== '00:00') return 1;
                if (timeA !== '00:00' && timeB === '00:00') return -1;

                // For other times, do normal time comparison
                return timeA.localeCompare(timeB);
              });

            return (
              <div class="bg-gray-800/40 rounded-lg overflow-hidden border border-gray-700/50 flex flex-col h-full">
                <div class="bg-gray-800/80 p-2 text-center border-b border-gray-700/50">
                  <h3 class="font-bold text-gray-200 text-sm">{day}</h3>
                </div>
                <div class="p-2 space-y-2 flex-grow min-h-[100px]">
                  {daySchedules.length > 0 ? (
                    daySchedules.map((schedule) => (
                      <div class="group relative bg-gray-900/60 hover:bg-gray-800 p-2 rounded border-l-2 border-amber-500 transition-all duration-200 cursor-default">
                        <div class="flex justify-between items-center mb-1">
                          <span class="text-xs font-bold text-amber-400">
                            {schedule.start_time} hora server</span>
                        </div>
                        <div class="flex justify-between items-start">
                          <span class="text-xs text-gray-300 font-medium leading-tight whitespace-normal break-words">
                            {schedule.raid_name}
                          </span>
                        </div>
                        {schedule.raid_leader && (
                          <button
                            onclick="openRaidLeadersModal(['{schedule.raid_leader}'])"
                            class="mt-1 flex items-center text-[10px] text-amber-400 hover:text-amber-300 transition-colors"
                          >
                            <svg
                              class="w-3 h-3 mr-1"
                              fill="none"
                              viewBox="0 0 24 24"
                              stroke="currentColor"
                            >
                              <path
                                stroke-linecap="round"
                                stroke-linejoin="round"
                                stroke-width="2"
                                d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z"
                              />
                            </svg>
                            {schedule.raid_leader}
                          </button>
                        )}
                        <span class="text-[10px] text-red-400 font-bold whitespace-nowrap">
                          Min. GS {wotlkRaids.find((r) => r.id === schedule.raid_id)?.minGearScore}
                        </span>
                      </div>
                    ))
                  ) : (
                    <div class="h-full flex items-center justify-center">
                      <span class="text-xs text-gray-600 italic">-</span>
                    </div>
                  )}
                </div>
              </div>
            );
          })
        }
      </div>
    </div>
  </div>

  {/* Raid Rules Section */}
  <div class="max-w-7xl mx-auto py-8">
    <div class="bg-gray-900/50 backdrop-blur-sm rounded-xl border border-amber-600/30 p-6">
      <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between mb-6 gap-4">
        <h2 class="text-2xl font-bold text-amber-400">Reglas de Raid</h2>
        <div class="flex items-center space-x-4">
          <a 
            href="https://discord.gg/BwdpNV9sky" 
            target="_blank" 
            rel="noopener noreferrer"
            class="flex items-center text-white bg-indigo-600 hover:bg-indigo-700 px-3 py-1.5 rounded-md text-sm font-medium transition-colors"
          >
            <svg class="w-5 h-5 mr-1.5" fill="currentColor" viewBox="0 0 24 24">
              <path d="M20.317 4.37a19.791 19.791 0 00-4.885-1.515.074.074 0 00-.079.037c-.21.375-.444.864-.608 1.25a18.27 18.27 0 00-5.487 0 12.64 12.64 0 00-.617-1.25.077.077 0 00-.079-.037A19.736 19.736 0 003.677 4.37a.07.07 0 00-.032.027C.533 9.046-.32 13.58.099 18.057a.082.082 0 00.031.057 19.9 19.9 0 005.993 3.03.078.078 0 00.084-.028c.462-.63.874-1.295 1.226-1.994a.076.076 0 00-.041-.1 13.107 13.107 0 01-1.872-.892.077.077 0 01-.008-.128 10.2 10.2 0 00.372-.292.074.074 0 01.077-.01c3.928 1.8 8.18 1.8 12.062 0a.074.074 0 01.078.01c.12.098.246.198.373.292a.077.077 0 01-.006.127 12.299 12.299 0 01-1.873.891.077.077 0 00-.041.1c.36.698.772 1.362 1.225 1.993a.076.076 0 00.084.028 19.84 19.84 0 005.99-3.03.077.077 0 00.032-.054c.5-5.177-.838-9.674-3.549-13.66a.061.061 0 00-.031-.03zM8.02 15.33c-1.183 0-2.157-1.085-2.157-2.419 0-1.333.946-2.419 2.157-2.419 1.21 0 2.175 1.096 2.157 2.42 0 1.333-.946 2.418-2.157 2.418zm7.975 0c-1.183 0-2.157-1.085-2.157-2.419 0-1.333.953-2.419 2.157-2.419 1.21 0 2.175 1.096 2.157 2.42 0 1.333-.946 2.418-2.157 2.418z"/>
            </svg>
            Discord
          </a>
          <a 
            href="https://chat.whatsapp.com/BahYOaTMZfHIwYQGey3G91" 
            target="_blank" 
            rel="noopener noreferrer"
            class="flex items-center text-white bg-green-600 hover:bg-green-700 px-3 py-1.5 rounded-md text-sm font-medium transition-colors"
          >
            <svg class="w-5 h-5 mr-1.5" fill="currentColor" viewBox="0 0 24 24">
              <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.966-.273-.099-.471-.148-.67.15-.197.297-.767.963-.94 1.16-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.795-1.484-1.781-1.66-2.075-.173-.297-.018-.458.13-.606.136-.135.298-.354.446-.531.149-.174.198-.298.298-.497.099-.198.05-.367-.025-.531-.075-.174-.669-1.612-.916-2.207-.242-.579-.487-.5-.67-.508-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.79.359-.272.3-1.04 1.016-1.04 2.477s1.065 2.873 1.213 3.074c.149.198 2.096 3.2 5.076 4.49.703.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.005-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.03-1.38l-.36-.214-3.741.982.998-3.648-.235-.372a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.29A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.549 4.142 1.595 5.945L0 24l6.335-1.652a11.882 11.882 0 005.723 1.464h.006c6.553 0 11.89-5.336 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/>
            </svg>
            WhatsApp
          </a>
        </div>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        {/* Normas de Conducta */}
        <div class="bg-gray-800/50 rounded-lg p-5 border border-gray-700/50">
          <h3 class="text-lg font-semibold text-white mb-3 flex items-center">
            <svg class="w-5 h-5 text-red-400 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
            </svg>
            Normas de Conducta
          </h3>
          <ul class="space-y-2 text-gray-300">
            <li class="flex items-start">
              <span class="text-red-400 mr-2">•</span>
              <span>AFK/OFF sin avisar = Sin botín/Expulsión</span>
            </li>
            <li class="flex items-start">
              <span class="text-red-400 mr-2">•</span>
              <span>No respetar pulls/mecánicas = Sin botín/Expulsión</span>
            </li>
            <li class="flex items-start">
              <span class="text-red-400 mr-2">•</span>
              <span>DPS/Heal/Tank con bajo rendimiento = Expulsión</span>
            </li>
            <li class="flex items-start">
              <span class="text-red-400 mr-2">•</span>
              <span>PVP no permitido = Expulsión</span>
            </li>
          </ul>
        </div>

        {/* Sistema de Botín */}
        <div class="bg-gray-800/50 rounded-lg p-5 border border-gray-700/50">
          <h3 class="text-lg font-semibold text-white mb-3 flex items-center">
            <svg class="w-5 h-5 text-amber-400 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
            Sistema de Botín
          </h3>
          <ul class="space-y-2 text-gray-300">
            <li class="flex items-start">
              <span class="text-amber-400 mr-2">•</span>
              <span>No Discord = No botín</span>
            </li>
            <li class="flex items-start">
              <span class="text-amber-400 mr-2">•</span>
              <span>Desconexión = Sin botín</span>
            </li>
            <li class="flex items-start">
              <span class="text-amber-400 mr-2">•</span>
              <span>Se rollea 20 minutos antes del ligado del ítem</span>
            </li>
            <li class="flex items-start">
              <span class="text-amber-400 mr-2">•</span>
              <span>Al dar Raid Off se cierran los rolls en el orden de obtención</span>
            </li>
          </ul>
        </div>

        {/* Requisitos Generales */}
        <div class="md:col-span-2 bg-gray-800/50 rounded-lg p-5 border border-blue-700/50">
          <h3 class="text-lg font-semibold text-white mb-3 flex items-center">
            <svg class="w-5 h-5 text-blue-400 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z" />
            </svg>
            Requisitos Generales
          </h3>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <h4 class="font-medium text-blue-300 mb-2">Asistencia</h4>
              <ul class="space-y-1 text-gray-300">
                <li class="flex items-start">
                  <span class="text-blue-400 mr-2">•</span>
                  <span>Puntualidad requerida</span>
                </li>
                <li class="flex items-start">
                  <span class="text-blue-400 mr-2">•</span>
                  <span>Avisar con anticipación si no podrás asistir</span>
                </li>
              </ul>
            </div>
            <div>
              <h4 class="font-medium text-blue-300 mb-2">Equipamiento</h4>
              <ul class="space-y-1 text-gray-300">
                <li class="flex items-start">
                  <span class="text-blue-400 mr-2">•</span>
                  <span>Consumibles necesarios</span>
                </li>
                <li class="flex items-start">
                  <span class="text-blue-400 mr-2">•</span>
                  <span>Encantamientos y gemas al día</span>
                </li>
              </ul>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</Layout>

<!-- Raid Leaders Modal -->
<div
  id="raid-leaders-modal"
  class="fixed inset-0 bg-black/70 flex items-center justify-center z-50 p-4 hidden"
>
  <div
    class="bg-gray-800 rounded-lg w-full max-w-md border border-amber-600/50 overflow-hidden shadow-xl"
  >
    <div class="p-4 border-b border-amber-600/30 bg-gray-900/50">
      <div class="flex items-center justify-between">
        <h3 class="text-xl font-bold text-amber-400">
          <svg
            class="w-5 h-5 inline-block mr-2 -mt-1"
            fill="none"
            viewBox="0 0 24 24"
            stroke="currentColor"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z"
            ></path>
          </svg>
          Líderes de Raid
        </h3>
        <button id="close-leaders-modal" class="text-gray-400 hover:text-white transition-colors">
          <svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M6 18L18 6M6 6l12 12"></path>
          </svg>
        </button>
      </div>
    </div>

    <div id="raid-leaders-list" class="max-h-[60vh] overflow-y-auto p-4 custom-scrollbar">
      <!-- Raid leaders will be listed here by JavaScript -->
    </div>

    <div class="p-4 border-t border-gray-700/50 bg-gray-900/30 flex justify-end">
      <button
        id="close-leaders-modal-btn"
        class="px-4 py-2 bg-amber-600 hover:bg-amber-500 text-white rounded-md transition-colors font-medium text-sm"
      >
        Cerrar
      </button>
    </div>
  </div>
</div>

<!-- Regular Players Modal -->
<div
  id="regular-players-modal"
  class="fixed inset-0 bg-black/70 flex items-center justify-center z-50 p-4 hidden"
>
  <div
    class="bg-gray-800 rounded-lg w-full max-w-md border border-blue-600/50 overflow-hidden shadow-xl"
  >
    <div class="p-4 border-b border-blue-600/30 bg-gray-900/50">
      <div class="flex items-center justify-between">
        <h3 class="text-xl font-bold text-blue-400">
          <svg
            class="w-5 h-5 inline-block mr-2 -mt-1"
            fill="none"
            viewBox="0 0 24 24"
            stroke="currentColor"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"
            ></path>
          </svg>
          Jugadores Regulares
        </h3>
        <button id="close-regulars-modal" class="text-gray-400 hover:text-white transition-colors">
          <svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M6 18L18 6M6 6l12 12"></path>
          </svg>
        </button>
      </div>
    </div>

    <div id="regular-players-list" class="max-h-[60vh] overflow-y-auto p-4 custom-scrollbar">
      <!-- Regular players will be listed here by JavaScript -->
    </div>

    <div class="p-4 border-t border-gray-700/50 bg-gray-900/30 flex justify-end">
      <button
        id="close-regulars-modal-btn"
        class="px-4 py-2 bg-blue-600 hover:bg-blue-500 text-white rounded-md transition-colors font-medium text-sm"
      >
        Cerrar
      </button>
    </div>
  </div>
</div>

<script is:inline>
  // Raid Leaders and Regular Players Modal Functions
  document.addEventListener('DOMContentLoaded', function () {
    // Setup Raid Leaders Modal
    const leadersList = document.getElementById('raid-leaders-list');
    if (leadersList) leadersList.innerHTML = '';

    const leadersModal = document.getElementById('raid-leaders-modal');
    const leadersCloseButtons = [
      document.getElementById('close-leaders-modal'),
      document.getElementById('close-leaders-modal-btn'),
    ];

    leadersModal?.addEventListener('click', function (e) {
      if (e.target === this) leadersModal.classList.add('hidden');
    });

    leadersCloseButtons.forEach((btn) => {
      btn?.addEventListener('click', () => leadersModal?.classList.add('hidden'));
    });

    // Setup Regular Players Modal
    const regularsList = document.getElementById('regular-players-list');
    if (regularsList) regularsList.innerHTML = '';

    const regularsModal = document.getElementById('regular-players-modal');
    const regularsCloseButtons = [
      document.getElementById('close-regulars-modal'),
      document.getElementById('close-regulars-modal-btn'),
    ];

    regularsModal?.addEventListener('click', function (e) {
      if (e.target === this) regularsModal.classList.add('hidden');
    });

    regularsCloseButtons.forEach((btn) => {
      btn?.addEventListener('click', () => regularsModal?.classList.add('hidden'));
    });
  });

  // Shared class colors mapping
  const classColors = {
    warrior: 'bg-orange-900/30 text-orange-300 border-orange-800',
    paladin: 'bg-pink-900/30 text-pink-300 border-pink-800',
    hunter: 'bg-green-900/30 text-green-300 border-green-800',
    rogue: 'bg-yellow-900/30 text-yellow-300 border-yellow-800',
    priest: 'bg-white/30 text-gray-200 border-gray-400',
    deathknight: 'bg-red-900/30 text-red-300 border-red-800',
    'death-knight': 'bg-red-900/30 text-red-300 border-red-800',
    shaman: 'bg-blue-900/30 text-blue-300 border-blue-800',
    mage: 'bg-cyan-900/30 text-cyan-300 border-cyan-800',
    warlock: 'bg-purple-900/30 text-purple-300 border-purple-800',
    druid: 'bg-orange-900/30 text-orange-300 border-orange-800',
    default: 'bg-gray-700/50 text-gray-300 border-gray-600',
  };

  // Role configuration with colors and display names
  const roleConfig = {
    tank: {
      bg: 'bg-blue-900/30',
      text: 'text-blue-300',
      border: 'border-blue-700/50',
      display: 'Tanque',
    },
    healer: {
      bg: 'bg-green-900/30',
      text: 'text-green-300',
      border: 'border-green-700/50',
      display: 'Sanador',
    },
    melee: {
      bg: 'bg-red-900/30',
      text: 'text-red-300',
      border: 'border-red-700/50',
      display: 'Cuerpo a Cuerpo',
    },
    melee_dps: {
      bg: 'bg-red-900/30',
      text: 'text-red-300',
      border: 'border-red-700/50',
      display: 'Cuerpo a Cuerpo',
    },
    ranged: {
      bg: 'bg-purple-900/30',
      text: 'text-purple-300',
      border: 'border-purple-700/50',
      display: 'Distancia',
    },
    ranged_dps: {
      bg: 'bg-purple-900/30',
      text: 'text-purple-300',
      border: 'border-purple-700/50',
      display: 'Distancia',
    },
    default: {
      bg: 'bg-gray-700/30',
      text: 'text-gray-300',
      border: 'border-gray-600/50',
      display: 'Sin rol',
    },
  };

  function createPlayerElement(player, isLeader = false) {
    const name = player?.name ? String(player.name) : 'Desconocido';
    const className = player?.class ? String(player.class).toLowerCase() : 'default';
    const role = player?.role
      ? String(player.role).toLowerCase()
      : isLeader
        ? 'lider_raid'
        : 'asistente';
    // Get player_role and ensure it's a valid key, default to 'default' if not found
    const playerRole =
      player?.player_role && roleConfig[player.player_role] ? player.player_role : 'default';
    const roleInfo = roleConfig[playerRole];

    if (!name || name === 'Desconocido') return null;

    const colorClass = classColors[className] || classColors['default'];
    const borderColor = isLeader ? 'border-amber-500/50' : 'border-blue-500/50';

    const el = document.createElement('div');
    el.className =
      'bg-gray-700/40 rounded-lg p-3 border border-gray-600/30 hover:border-gray-500/50 transition-colors mb-2';

    el.innerHTML = `
      <div class="flex items-start">
        <div class="flex-shrink-0 w-10 h-10 rounded-full ${colorClass} flex items-center justify-center border-2 ${borderColor}">
          <span class="text-sm font-bold">${name.charAt(0).toUpperCase()}</span>
        </div>
        <div class="ml-3 flex-1 min-w-0">
          <p class="text-sm font-semibold text-white truncate">${name}</p>
          <div class="flex flex-wrap items-center gap-1.5 mt-1">
            <span class="text-xs px-2 py-0.5 rounded-full ${colorClass} border border-current/20">
              ${className.charAt(0).toUpperCase() + className.slice(1)}
            </span>
            <span class="text-xs px-2 py-0.5 rounded-full ${isLeader ? 'bg-amber-500/20 text-amber-300 border border-amber-500/30' : 'bg-blue-500/20 text-blue-300 border border-blue-500/30'}">
              ${isLeader ? 'Líder' : 'Asistente'}
            </span>
            <span class="text-xs px-2 py-0.5 rounded-full ${roleInfo.bg} ${roleInfo.text} border ${roleInfo.border}">
              ${roleInfo.display}
            </span>
          </div>
        </div>
      </div>
    `;
    return el;
  }

  function showNoDataMessage(container, type) {
    if (!container) return;
    const isLeader = type === 'leader';
    const color = isLeader ? 'text-amber-400' : 'text-blue-400';

    container.innerHTML = `
      <div class="text-center py-8">
        <svg class="mx-auto h-14 w-14 text-gray-500 mb-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
        </svg>
        <h3 class="text-lg font-medium text-gray-200">Sin ${isLeader ? 'líderes' : 'jugadores'}</h3>
        <p class="mt-1 text-sm text-gray-400">No hay ${isLeader ? 'líderes asignados' : 'jugadores regulares'} en este horario.</p>
      </div>
    `;
  }

  function openRaidLeadersModal(leaders) {
    const modal = document.getElementById('raid-leaders-modal');
    const list = document.getElementById('raid-leaders-list');
    if (!modal || !list) return;

    list.innerHTML = '';
    const leaderList = Array.isArray(leaders) ? leaders : [];

    if (leaderList.length > 0) {
      leaderList.forEach((leader) => {
        // Ensure player_role is properly set from the leader data
        const playerWithRole = {
          ...leader,
          player_role: leader.player_role || leader.role || 'default',
        };
        const el = createPlayerElement(playerWithRole, true);
        if (el) list.appendChild(el);
      });
    }

    if (list.children.length === 0) {
      showNoDataMessage(list, 'leader');
    }

    modal.classList.remove('hidden');
  }

  function openRegularPlayersModal(players) {
    const modal = document.getElementById('regular-players-modal');
    const list = document.getElementById('regular-players-list');
    if (!modal || !list) return;

    list.innerHTML = '';
    const playerList = Array.isArray(players) ? players : [];

    if (playerList.length > 0) {
      playerList.forEach((player) => {
        // Ensure player_role is properly set from the player data
        const playerWithRole = {
          ...player,
          player_role: player.player_role || player.role || 'default',
        };
        const el = createPlayerElement(playerWithRole, false);
        if (el) list.appendChild(el);
      });
    }

    if (list.children.length === 0) {
      showNoDataMessage(list, 'regular');
    }

    modal.classList.remove('hidden');
  }

  function closeRaidLeadersModal() {
    document.getElementById('raid-leaders-modal')?.classList.add('hidden');
  }

  function closeRegularPlayersModal() {
    document.getElementById('regular-players-modal')?.classList.add('hidden');
  }
  // Función para manejar el clic en el botón "Unirse al Raid"
  function handleJoinRaid(button) {
    const raidName = button.getAttribute('data-raid-name');
    const minGearScore = button.getAttribute('data-min-gear-score');
    const raidId = button.getAttribute('data-raid-id');

    // Actualizar el título y los campos del formulario
    document.getElementById('raid-title').textContent = raidName;
    document.getElementById('gear-score').min = minGearScore;
    document.getElementById('gear-score').value = minGearScore;
    document.getElementById('min-gear-score').textContent = minGearScore;

    // Almacenar el ID de la raid en una variable global
    window.currentRaidId = raidId;

    // Mostrar el formulario
    document.getElementById('register-section').classList.remove('hidden');

    // Desplazarse suavemente al formulario
    button.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
  }

  document.addEventListener('DOMContentLoaded', () => {
    const form = document.getElementById('registration-form');
    const formErrors = document.getElementById('form-errors');
    const errorMessage = document.getElementById('error-message');
    const raidTitle = document.getElementById('raid-title');
    let currentRaidId = null; // Variable para almacenar el ID de la raid actual

    // Función para mostrar mensajes de éxito
    function showSuccess(message) {
      formErrors.className =
        'bg-green-900/50 border border-green-700 text-green-200 p-4 rounded mb-4';
      errorMessage.textContent = message;
      formErrors.classList.remove('hidden');

      // Ocultar el mensaje después de 5 segundos
      setTimeout(() => {
        formErrors.classList.add('hidden');
      }, 5000);
    }

    // Función para mostrar errores
    function showError(message) {
      formErrors.className = 'bg-red-900/50 border border-red-700 text-red-200 p-4 rounded mb-4';
      errorMessage.textContent = message;
      formErrors.classList.remove('hidden');

      // Hacer scroll al formulario de error
      formErrors.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }

    // Función para ocultar mensajes
    function hideErrors() {
      formErrors.classList.add('hidden');
    }

    // Helper function to get form data as object
    function getFormData(formElement) {
      const formData = new FormData(formElement);
      const data = {};

      for (let [key, value] of formData.entries()) {
        // Convert string 'true'/'false' to boolean
        if (value === 'true') value = true;
        if (value === 'false') value = false;

        // Handle multiple values for the same key (like checkboxes)
        if (data[key] !== undefined) {
          if (!Array.isArray(data[key])) {
            data[key] = [data[key]];
          }
          data[key].push(value);
        } else {
          data[key] = value;
        }
      }

      return data;
    }

    // Form submission handler
    if (form) {
      form.addEventListener('submit', async (e) => {
        e.preventDefault();
        hideErrors();

        const submitButton = form.querySelector('button[type="submit"]');
        const formData = new FormData(form);

        // Agregar el ID de la raid al formulario si no está presente
        if (!formData.get('raid_id')) {
          if (window.currentRaidId) {
            formData.append('raid_id', window.currentRaidId.toString());
          } else {
            throw new Error('No se ha seleccionado ninguna raid. Por favor, inténtalo de nuevo.');
          }
        }
        const originalButtonText = submitButton?.innerHTML || 'Enviar';

        try {
          // Deshabilitar botón de envío y mostrar estado de carga
          if (submitButton) {
            submitButton.disabled = true;
            submitButton.innerHTML = `
                <svg class="animate-spin -ml-1 mr-2 h-5 w-5 text-white inline-block" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                  <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                  <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                Enviando...
              `;
          }

          // Enviar datos del formulario
          const response = await fetch(window.location.pathname, {
            method: 'POST',
            body: formData,
            headers: {
              Accept: 'application/json',
            },
          });

          const result = await response.json();

          if (!response.ok) {
            throw new Error(result.error || 'Error al procesar la solicitud');
          }

          // Mostrar mensaje de éxito
          showSuccess('¡Registro exitoso! Tu solicitud ha sido enviada para revisión.');

          // Limpiar el formulario
          form.reset();

          // Cerrar el modal después de 2 segundos
          setTimeout(() => {
            const modal = document.getElementById('register-section');
            if (modal) {
              modal.classList.add('hidden');
            }
          }, 2000);
        } catch (error) {
          console.error('Error al enviar el formulario:', error);
          showError(
            error instanceof Error
              ? error.message
              : 'No se pudo enviar la solicitud. Por favor, inténtalo de nuevo.'
          );
        } finally {
          // Restaurar el botón de envío
          if (submitButton) {
            submitButton.disabled = false;
            submitButton.innerHTML = 'Enviar solicitud';
          }
        }
      });
    }
  });

  // Modal functions
  window.openRegistrationModal = function (button) {
    const modal = document.getElementById('register-modal');
    const form = document.getElementById('registration-form');

    if (!modal || !form) return;

    // Get data from button
    const raidName = button.dataset.raidName;
    const raidId = button.dataset.raidId;
    const day = button.dataset.day;
    const time = button.dataset.time;
    const role = button.dataset.role;

    // Update modal UI
    document.getElementById('modal-raid-name').textContent = raidName;
    document.getElementById('modal-schedule-info').textContent = `${day} - ${time} hora server`;
    document.getElementById('modal-role-display').textContent = role;

    // Set hidden form fields
    document.getElementById('modal-raid-id').value = raidId;
    document.getElementById('modal-day').value = day;
    document.getElementById('modal-time').value = time;
    document.getElementById('modal-player-role').value = role;

    // Show modal
    modal.classList.remove('hidden');

    // Reset form and errors
    form.reset();
    document.getElementById('form-errors').classList.add('hidden');
  };

  window.closeRegistrationModal = function () {
    const modal = document.getElementById('register-modal');
    if (modal) {
      modal.classList.add('hidden');
    }
  };

  // Close modal when clicking outside
  window.onclick = function (event) {
    const modal = document.getElementById('register-modal');
    if (event.target == modal) {
      window.closeRegistrationModal();
    }
  };
</script>

<script is:inline>
  document.addEventListener('DOMContentLoaded', () => {
    const slider = document.querySelector('.slider-container');
    const track = document.querySelector('.slider-track');
    const slides = document.querySelectorAll('.swiper-slide');
    const prevBtn = document.getElementById('slider-prev');
    const nextBtn = document.getElementById('slider-next');
    const dots = document.querySelectorAll('.pagination-dot');

    if (!slider || !track || slides.length === 0 || !prevBtn || !nextBtn) {
      console.error('Slider elements not found');
      return;
    }

    let currentSlide = 0;
    let slideWidth = 0;

    function initSlider() {
      // Set initial slide width
      updateSlideWidth();

      // Set initial positions
      updateSlider();

      // Add event listeners
      addEventListeners();
    }

    function updateSlideWidth() {
      // Get the width of the visible area
      const containerWidth = slider.offsetWidth;
      // Set slide width to 100% of container width
      slideWidth = containerWidth;

      // Set width for each slide
      slides.forEach((slide) => {
        slide.style.width = `${slideWidth}px`;
        slide.style.flexShrink = '0';
      });

      // Set track width to fit all slides
      track.style.width = `${slideWidth * slides.length}px`;
    }

    function updateSlider() {
      // Update track position
      track.style.transform = `translateX(-${currentSlide * slideWidth}px)`;

      // Update active dot
      updateDots();

      // Update button states
      updateButtons();
    }

    function updateDots() {
      dots.forEach((dot, index) => {
        dot.classList.toggle('active', index === currentSlide);
      });
    }

    function updateButtons() {
      prevBtn.disabled = currentSlide === 0;
      nextBtn.disabled = currentSlide === slides.length - 1;
    }

    function goToSlide(index) {
      if (index >= 0 && index < slides.length) {
        currentSlide = index;
        updateSlider();
      }
    }

    function addEventListeners() {
      // Navigation buttons
      prevBtn.addEventListener('click', () => {
        if (currentSlide > 0) {
          currentSlide--;
          updateSlider();
        }
      });

      nextBtn.addEventListener('click', () => {
        if (currentSlide < slides.length - 1) {
          currentSlide++;
          updateSlider();
        }
      });

      // Dots navigation - Handle clicks on pagination items
      const paginationItems = document.querySelectorAll('.pagination-item');
      paginationItems.forEach((item, index) => {
        item.addEventListener('click', (e) => {
          e.preventDefault();
          goToSlide(index);
        });
      });

      // Keyboard navigation
      document.addEventListener('keydown', (e) => {
        if (e.key === 'ArrowLeft' && currentSlide > 0) {
          currentSlide--;
          updateSlider();
        } else if (e.key === 'ArrowRight' && currentSlide < slides.length - 1) {
          currentSlide++;
          updateSlider();
        }
      });

      // Handle window resize
      let resizeTimer;
      window.addEventListener('resize', () => {
        clearTimeout(resizeTimer);
        resizeTimer = setTimeout(() => {
          updateSlideWidth();
          updateSlider();
        }, 100);
      });
    }

    // Initialize the slider
    initSlider();
  });
</script>

<style>
  /* Slider container */
  .swiper-container {
    width: 100%;
    padding: 40px 60px 80px;
    position: relative;
    max-width: 1400px;
    margin: 0 auto;
  }

  /* Slide styles */
  .swiper-slide {
    box-sizing: border-box;
    width: calc(100% - 40px); /* Adjust width to account for padding */
  }

  /* Navigation buttons */
  .swiper-button-next,
  .swiper-button-prev {
    color: #f59e0b;
    width: 44px;
    height: 44px;
    background: rgba(31, 41, 55, 0.9);
    border-radius: 50%;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    top: 50%;
    margin-top: -22px;
    z-index: 10;
  }

  .swiper-button-next {
    right: 0;
  }

  .swiper-button-prev {
    left: 0;
  }

  .swiper-button-next:before,
  .swiper-button-prev:before {
    content: '';
    width: 12px;
    height: 12px;
    border-top: 2px solid #f59e0b;
    border-right: 2px solid #f59e0b;
    position: absolute;
  }

  .swiper-button-next:before {
    transform: rotate(45deg);
    margin-left: -4px;
  }

  .swiper-button-prev:before {
    transform: rotate(-135deg);
    margin-right: -4px;
  }

  .swiper-button-next:hover,
  .swiper-button-prev:hover {
    background: rgba(55, 65, 81, 0.8);
    transform: scale(1.1);
  }

  .swiper-button-next:after,
  .swiper-button-prev:after {
    font-size: 1.2rem;
  }

  .slider-track {
    display: flex;
    transition: transform 0.4s ease;
    will-change: transform;
  }

  .swiper-slide {
    flex-shrink: 0;
    width: 100%;
    box-sizing: border-box;
  }

  .slider-nav {
    position: absolute;
    top: 63%;
    width: 3rem;
    height: 3rem;
    border-radius: 50%;
    background: rgba(31, 41, 55, 0.9);
    color: #f59e0b;
    border: none;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 10;
    transition: all 0.3s ease;
  }

  .slider-nav:hover {
    background: #1f2937;
  }

  .slider-nav:disabled {
    opacity: 0.3;
    cursor: not-allowed;
  }

  .slider-nav.prev {
    left: 0rem;
  }

  .slider-nav.next {
    right: 0rem;
  }

  .slider-nav svg {
    width: 1.5rem;
    height: 1.5rem;
  }

  .slider-pagination {
    display: flex;
    justify-content: center;
    align-items: center;
    padding: 0.5rem;
    padding-top: 2rem;
    gap: 2rem;
    position: relative;
    z-index: 10;
    margin-bottom: 1rem;
    flex-wrap: wrap;
  }

  .pagination-item {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 0.5rem;
    cursor: pointer;
    transition: all 0.2s ease;
    background: none;
    border: none;
    color: inherit;
    padding: 0.5rem;
    margin: 0;
    font: inherit;
    outline: inherit;
  }

  .pagination-item:focus {
    outline: 2px solid #fbbf24;
    outline-offset: 2px;
    border-radius: 0.25rem;
  }

  .pagination-item:hover .pagination-dot {
    transform: scale(1.1);
  }

  .pagination-item:hover .pagination-label {
    color: #fbbf24; /* amber-400 */
  }

  .pagination-label {
    color: #ffffff; /* white */
    font-size: 0.875rem; /* text-sm */
    font-weight: 700; /* bold */
    transition: color 0.2s ease;
    text-align: center;
    white-space: nowrap;
  }

  .pagination-dot {
    width: 2.5rem;
    height: 0.5rem;
    border-radius: 0.25rem;
    background: #4b5563;
    border: none;
    cursor: pointer;
    padding: 0;
    transition: all 0.3s ease;
  }

  .pagination-dot.active {
    background: #f59e0b;
    transform: scale(1.1);
  }

  .pagination-dot:not(.active):hover {
    background: #6b7280;
  }

  @media (min-width: 768px) {
  }
</style>

<style>
  /* Slider container styles */
  .swiper-container {
    width: 100%;
    overflow: hidden;
    margin-top: 1.5rem;
    gap: 0.5rem;
    padding: 0.5rem 0;
  }

  #pagination button {
    transition: all 0.3s ease;
    border-radius: 9999px;
    cursor: pointer;
    outline: none;
    border: 2px solid transparent;
  }

  #pagination button:hover,
  #pagination button:focus-visible {
    background-color: #f59e0b !important;
    border-color: rgba(245, 158, 11, 0.5);
    transform: scale(1.1);
  }

  #pagination button:active {
    transform: scale(0.95);
  }

  #pagination button {
    transition: all 0.3s ease;
    border-radius: 0.5rem;
  }

  /* Animations */
  @keyframes fadeIn {
    from {
      opacity: 0;
      transform: translateY(10px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .fade-in {
    animation: fadeIn 0.5s ease-out forwards;
  }

  /* Custom scrollbar */
  ::-webkit-scrollbar {
    width: 8px;
    height: 8px;
  }

  ::-webkit-scrollbar-track {
    background: rgba(255, 255, 255, 0.05);
    border-radius: 4px;
  }

  ::-webkit-scrollbar-thumb {
    background: rgba(180, 83, 9, 0.5);
    border-radius: 4px;
  }

  ::-webkit-scrollbar-thumb:hover {
    background: rgba(217, 119, 6, 0.7);
  }

  /* Responsive adjustments */
  @media (max-width: 768px) {
    .container {
      padding-left: 1rem;
      padding-right: 1rem;
    }
  }
</style>
