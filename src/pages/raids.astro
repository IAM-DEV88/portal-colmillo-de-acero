---
import Layout from '../components/layout/Layout.astro';
import { supabase } from '../lib/supabase';
// Import components


// Función auxiliar para contar jugadores por rol
type PlayerRole = 'tank' | 'heal' | 'melee' | 'ranged';

function countPlayersByRole(players) {
  return players?.reduce((acc, player) => {
    const role = player.role?.toLowerCase() || '';
    const playerRole = player.player_role?.toLowerCase() || '';
    const className = player.player_class?.toLowerCase() || '';
    
    // Verificar si es tanque
    if (role.includes('tank') || playerRole.includes('tank')) {
      acc.tank = (acc.tank || 0) + 1;
    } 
    // Verificar si es sanador
    else if (role.includes('heal') || role.includes('sanador') || role.includes('sanación') || 
             playerRole.includes('heal') || playerRole.includes('sanador') || playerRole.includes('sanación')) {
      acc.heal = (acc.heal || 0) + 1;
    } 
    // Verificar DPS (cuerpo a cuerpo o a distancia)
    else {
      // Verificar si el rol específico es 'cuerpo a cuerpo' o 'a distancia'
      if (role.includes('cuerpo a cuerpo') || playerRole.includes('cuerpo a cuerpo')) {
        acc.melee = (acc.melee || 0) + 1;
      } 
      else if (role.includes('a distancia') || playerRole.includes('a distancia') || 
               role.includes('ranged') || playerRole.includes('ranged')) {
        acc.ranged = (acc.ranged || 0) + 1;
      }
      // Si no está especificado, intentar determinarlo por clase
      else {
        // Clases que siempre son cuerpo a cuerpo
        const meleeClasses = ['warrior', 'paladin', 'deathknight', 'rogue'];
        // Especializaciones que son cuerpo a cuerpo
        const meleeSpecs = ['feral', 'enhancement', 'retribution', 'combat', 'assassination', 'fury', 'arms'];
        
        const isMelee = meleeClasses.some(c => className.includes(c)) || 
                       meleeSpecs.some(s => role.includes(s) || playerRole.includes(s));
        
        if (isMelee) {
          acc.melee = (acc.melee || 0) + 1;
        } else {
          // Por defecto, considerar como ranged si no es tanque ni sanador
          acc.ranged = (acc.ranged || 0) + 1;
        }
      }
    }
    return acc;
  }, { tank: 0, heal: 0, melee: 0, ranged: 0 }) || { tank: 0, heal: 0, melee: 0, ranged: 0 };
}

// Define types
interface Raid {
  id: number;
  name: string;
  image: string;
  description: string;
  minGearScore: number;
}

interface Player {
  name: string;
  class: string;
  role: string;
  gear_score: number;
  status?: string; // Optional status field
  raid_status?: string; // Optional raid_status field
}

interface StatusCounts {
  aceptado: number;
  en_revision: number;
  en_espera: number;
}

interface RaidSchedule {
  id: number;
  raid_id: number;
  raid_name: string;
  difficulty: string;
  day_of_week: string;
  start_time: string;
  players: Player[];
  statusCounts: StatusCounts;
}

// WotLK Raid Information
const wotlkRaids: Raid[] = [
  {
    id: 1,
    name: 'TOC 10N FARM',
    image: '/images/raids/tocfarm.jpg',
    description: 'Se ponen a prueba el conocimiento de mecanicas de grupo y habilidad para el combate.',
    minGearScore: 4700
  },
  {
    id: 2,
    name: 'ICC 10N FARM',
    image: '/images/raids/iccfarm.jpg',
    description: 'Se ponen a prueba el conocimiento de mecanicas de grupo y habilidad para el combate.',
    minGearScore: 5000
  },
  {
    id: 3,
    name: 'ICC 25N FARM',
    image: '/images/raids/iccfarm.jpg',
    description: 'Se ponen a prueba el conocimiento de mecanicas de grupo y habilidad para el combate.',
    minGearScore: 5300
  },
  {
    id: 4,
    name: 'ICC 10N POR LK',
    image: '/images/raids/icclk.jpg',
    description: 'Jugadores con experiencia que buscan el logro de ICC10N.',
    minGearScore: 5600
  },
  {
    id: 5,
    name: 'SAGRARIO RUBY',
    image: '/images/raids/sr.jpg',
    description: 'Jugadores con experiencia que buscan el logro de SR.',
    minGearScore: 5700
  },
  {
    id: 6,
    name: 'ICC 25N POR LK',
    image: '/images/raids/icclk.jpg',
    description: 'Jugadores con experiencia que buscan el logro de ICC25N.',
    minGearScore: 5700
  },
  {
    id: 7,
    name: 'ICC 10H FARM',
    image: '/images/raids/iccfarm.jpg',
    description: 'Se ponen a prueba el conocimiento de mecanicas de grupo y habilidad para el combate.',
    minGearScore: 5700
  },
  {
    id: 8,
    name: 'ICC 25H FARM',
    image: '/images/raids/iccfarm.jpg',
    description: 'Se ponen a prueba el conocimiento de mecanicas de grupo y habilidad para el combate.',
    minGearScore: 5700
  }
];

// Fetch raid schedules from Supabase
let raidSchedules: RaidSchedule[] = [];
let error: string | null = null;

// Function to get the next upcoming schedule
function getNextSchedule(schedules) {
  if (!schedules || schedules.length === 0) return null;
  
  const now = new Date();
  const currentDay = now.getDay(); // 0 = Sunday, 1 = Monday, etc.
  
  // Map day names to numbers (0 = Sunday, 1 = Monday, etc.)
  const dayMap = {
    'domingo': 0,
    'lunes': 1,
    'martes': 2,
    'miercoles': 3,
    'jueves': 4,
    'viernes': 5,
    'sabado': 6
  };
  
  // Convert schedule times to Date objects for comparison
  const upcomingSchedules = schedules.map(schedule => {
    const dayName = schedule.day_of_week.toLowerCase();
    const dayNumber = dayMap[dayName];
    const [hours, minutes] = schedule.start_time.split(':').map(Number);
    
    // Create a date object for this schedule's next occurrence
    const nextOccurrence = new Date(now);
    const daysUntilNext = (dayNumber - currentDay + 7) % 7;
    
    // If the time has already passed today, schedule for next week
    const isToday = daysUntilNext === 0;
    const hasPassedToday = isToday && 
      (hours < now.getHours() || 
       (hours === now.getHours() && minutes <= now.getMinutes()));
    
    const daysToAdd = hasPassedToday ? 7 + daysUntilNext : daysUntilNext;
    
    nextOccurrence.setDate(now.getDate() + daysToAdd);
    nextOccurrence.setHours(hours, minutes, 0, 0);
    
    return {
      ...schedule,
      nextOccurrence,
      minutesUntil: (nextOccurrence - now) / (1000 * 60) // minutes until next occurrence
    };
  });
  
  // Filter out schedules with no accepted players
  const schedulesWithAcceptedPlayers = upcomingSchedules.filter(schedule => {
    if (!schedule.players || schedule.players.length === 0) return false;
    
    return schedule.players.some(player => 
      player.status === 'aceptado' || 
      player.raid_status === 'aceptado' ||
      player.registration_status === 'aceptado' ||
      player.status === 'accepted' ||
      player.raid_status === 'accepted' ||
      player.registration_status === 'accepted' ||
      player.status === 'confirmed' ||
      player.raid_status === 'confirmed' ||
      player.registration_status === 'confirmed'
    );
  });
  
  // Sort by next occurrence
  schedulesWithAcceptedPlayers.sort((a, b) => a.minutesUntil - b.minutesUntil);
  
  // Return the next schedule with accepted players (if any)
  return schedulesWithAcceptedPlayers[0] || null;
}

// Group schedules by day and raid
try {
  // Handle form submission
  if (Astro.request.method === 'POST') {
    console.log('POST request received');
    try {
      const formData = await Astro.request.formData();
      console.log('Raw form data entries:');
      for (const [key, value] of formData.entries()) {
        console.log(`- ${key}:`, value);
      }
      
      const formDataObj = Object.fromEntries(formData.entries());
      console.log('Processed form data:', formDataObj);
      
      // Define registration data with index signature
      const registrationData: {
        player_name: string;
        player_class: string;
        gear_score: string;
        player_role: string;
        raid_role: string;
        day_of_week: string;
        start_time: string;
        raid_id: string;
        [key: string]: string; // Index signature
      } = {
        player_name: formDataObj.player_name?.toString() || '',
        player_class: formDataObj.player_class?.toString() || '',
        gear_score: formDataObj.gear_score?.toString() || '',
        player_role: formDataObj.player_role?.toString() || '',
        raid_role: formDataObj.raid_role?.toString() || '',
        day_of_week: formDataObj.day_of_week?.toString() || '',
        start_time: formDataObj.start_time?.toString() || '',
        raid_id: formDataObj.raid_id?.toString() || '',
      };
      
      console.log('Processed registration data:', registrationData);

      // Validate required fields
      const requiredFields = ['player_name', 'player_class', 'gear_score', 'player_role', 'raid_role', 'day_of_week', 'start_time', 'raid_id'];
      const missingFields = requiredFields.filter(field => !registrationData[field]);
      
      if (missingFields.length > 0) {
        return new Response(
          JSON.stringify({ 
            error: 'Faltan campos requeridos',
            missingFields 
          }),
          { 
            status: 400,
            headers: {
              'Content-Type': 'application/json'
            }
          }
        );
      }

      // Check for existing registrations within the time window
      const startTime = new Date(`1970-01-01T${registrationData.start_time}:00`);
      const minTime = new Date(startTime);
      minTime.setHours(minTime.getHours() - 3);
      const maxTime = new Date(startTime);
      maxTime.setHours(maxTime.getHours() + 3);
      
      // Format times for Supabase query
      const formatTime = (date) => date.toTimeString().substring(0, 5);
      
      const { data: existingRegistrations, error: checkError } = await supabase
        .from('raid_registrations')
        .select('*')
        .eq('player_name', registrationData.player_name)
        .eq('day_of_week', registrationData.day_of_week)
        .gte('start_time', formatTime(minTime))
        .lte('start_time', formatTime(maxTime));
      
      if (checkError) {
        console.error('Error checking existing registrations:', checkError);
        throw new Error('Error al verificar registros existentes');
      }
      
      if (existingRegistrations && existingRegistrations.length > 0) {
        const existing = existingRegistrations[0];
        return new Response(
          JSON.stringify({ 
            error: 'Ya tienes un registro en este horario',
            details: `Ya estás registrado en una raid el ${existing.day_of_week} a las ${existing.start_time}. No puedes registrarte en otra raid 3 horas antes o después.`
          }),
          { 
            status: 400,
            headers: { 'Content-Type': 'application/json' }
          }
        );
      }
      
      // If we get here, all validations passed
      console.log('Attempting to insert into Supabase...');
      
      // Prepare the data to insert
      const insertData = {
  player_name: registrationData.player_name,
  player_class: registrationData.player_class,
  gear_score: parseInt(registrationData.gear_score) || 0,
  player_role: registrationData.player_role,
  raid_role: registrationData.raid_role,
  day_of_week: registrationData.day_of_week,
  start_time: registrationData.start_time,
  raid_id: parseInt(registrationData.raid_id) || 0,
  status: 'en_revision'
};
      
      console.log('Data to insert:', insertData);
      
      // Insert into Supabase
      console.log('Attempting to insert into Supabase table: raid_registrations');
      console.log('Insert data:', JSON.stringify(insertData, null, 2));
      
      try {
        const { data: result, error: insertError } = await supabase
          .from('raid_registrations')
          .insert([insertData])
          .select();

        if (insertError) {
          console.error('Supabase error details:', insertError);
          throw insertError;
        }
        
        console.log('Insert successful, result:', result);
        
        // Return success response
        return new Response(
          JSON.stringify({ 
            success: true, 
            data: result[0] 
          }),
          { 
            status: 200,
            headers: {
              'Content-Type': 'application/json'
            }
          }
        );
      } catch (dbError) {
        console.error('Database error details:', {
          name: dbError.name,
          message: dbError.message,
          code: dbError.code,
          details: dbError.details,
          hint: dbError.hint,
          stack: dbError.stack
        });
        throw dbError;
      }

      // El retorno de éxito ahora está dentro del bloque try
    } catch (error) {
      console.error('Error processing form submission:', error);
      return new Response(
        JSON.stringify({ 
          error: 'Error al procesar la solicitud',
          details: error.message 
        }),
        { 
          status: 500,
          headers: {
            'Content-Type': 'application/json'
          }
        }
      );
    }

    try {
      console.log('Attempting to insert into Supabase...');
      
      // Prepare the data to insert
      const insertData = {
        player_name: registrationData.player_name,
        player_class: registrationData.player_class,
        gear_score: parseInt(registrationData.gear_score) || 0,
        player_role: registrationData.player_role,
        raid_role: registrationData.raid_role,
        day_of_week: registrationData.day_of_week,
        start_time: registrationData.start_time,
        raid_id: parseInt(registrationData.raid_id) || 0,
        status: 'en_revision',
        created_at: new Date().toISOString()
      };
      
      console.log('Data to insert:', insertData);
      
      // Insert into Supabase
      const { data: result, error } = await supabase
        .from('raid_registrations')
        .insert([insertData])
        .select();

      if (error) {
        console.error('Supabase error details:', error);
        throw error;
      }

      // Redirect to prevent form resubmission
      return new Response(
        JSON.stringify({ 
          success: true, 
          data: result[0] 
        }),
        { 
          status: 200,
          headers: {
            'Content-Type': 'application/json'
          }
        }
      );
    } catch (error) {
      console.error('Error saving registration:', error);
      return new Response(
        JSON.stringify({ 
          error: 'Error al guardar el registro',
          details: error.message 
        }),
        { status: 500 }
      );
    }
  }

  // Mapeo de días de la semana a números para ordenar
  const dayOrder = {
    'lunes': 1,
    'martes': 2,
    'miercoles': 3,
    'jueves': 4,
    'viernes': 5,
    'sabado': 6,
    'domingo': 7
  };

  // Obtener el día actual en español
  const days = ['domingo', 'lunes', 'martes', 'miercoles', 'jueves', 'viernes', 'sabado'];
  const todayIndex = new Date().getDay(); // 0 (domingo) a 6 (sábado)
  const today = days[todayIndex];
  
  // Get all raid schedules with different statuses
  const { data: raidSchedulesData, error: fetchError } = await supabase
    .from('raid_registrations')
    .select(`
      id,
      raid_id,
      player_name,
      player_class,
      player_role,
      raid_role,
      gear_score,
      day_of_week,
      start_time,
      status
    `)
    .in('status', ['aceptado', 'en_revision', 'en_espera'])
    .order('day_of_week', { ascending: true })
    .order('start_time', { ascending: true });
    
  // Ordenar los horarios para que el próximo sea el primero
  if (raidSchedulesData) {
    raidSchedulesData.sort((a, b) => {
      // Primero por día de la semana (empezando por hoy)
      const dayDiffA = (dayOrder[a.day_of_week] + 7 - dayOrder[today]) % 7;
      const dayDiffB = (dayOrder[b.day_of_week] + 7 - dayOrder[today]) % 7;
      
      if (dayDiffA !== dayDiffB) {
        return dayDiffA - dayDiffB;
      }
      
      // Si es el mismo día, ordenar por hora
      return a.start_time.localeCompare(b.start_time);
    });
  }
    
  // Count all statuses for indicators - use all data first
  type StatusCounts = {
    [key: string]: number;
    aceptado: number;
    en_espera: number;
    en_revision: number;
  };
  
  const statusCounts: StatusCounts = {
    aceptado: 0,
    en_espera: 0,
    en_revision: 0,
    ...(raidSchedulesData?.reduce<Partial<StatusCounts>>((acc, schedule) => {
      const status = schedule.status as keyof StatusCounts;
      acc[status] = (acc[status] || 0) + 1;
      return acc;
    }, {}) || {})
  };
  
  // Only show 'aceptado' status in the display
  const displaySchedules = raidSchedulesData?.filter(schedule => 
    schedule.status === 'aceptado'
  ) || [];
  
  // Count unique schedule slots (grouped by raid_id, day_of_week, and start_time)
  // Only count 'aceptado' status for schedule totals
  const scheduleCounts = { total: 0 };
  
  // Get all unique schedule slots with at least one 'aceptado' registration
  const acceptedScheduleSlots = new Set<string>();
  
  raidSchedulesData?.forEach(schedule => {
    if (schedule.status === 'aceptado') {
      const slotKey = `${schedule.raid_id}-${schedule.day_of_week}-${schedule.start_time}`;
      acceptedScheduleSlots.add(slotKey);
    }
  });
  
  scheduleCounts.total = acceptedScheduleSlots.size;
    
  if (fetchError) throw fetchError;
  
  // First pass to count statuses per schedule slot
  const scheduleStatusCounts = new Map<string, StatusCounts>();
  
  raidSchedulesData?.forEach(reg => {
    const key = `${reg.raid_id}-${reg.day_of_week}-${reg.start_time}`;
    if (!scheduleStatusCounts.has(key)) {
      scheduleStatusCounts.set(key, { aceptado: 0, en_revision: 0, en_espera: 0 });
    }
    const counts = scheduleStatusCounts.get(key)!;
    if (reg.status in counts) {
      counts[reg.status as keyof StatusCounts]++;
    }
  });

  // Second pass to group by schedule and filter players
  const schedulesMap = (raidSchedulesData || []).reduce<Record<string, RaidSchedule>>((acc, reg: any) => {
    const raid = wotlkRaids.find(r => r.id === reg.raid_id);
    if (!raid) return acc;
    
    const key = `${reg.raid_id}-${reg.day_of_week}-${reg.start_time}`;
    if (!acc[key]) {
      acc[key] = {
        id: reg.id, // Add the id from the database
        raid_id: reg.raid_id,
        raid_name: raid.name,
        difficulty: reg.difficulty || '10',
        day_of_week: reg.day_of_week,
        start_time: reg.start_time,
        players: [],
        statusCounts: scheduleStatusCounts.get(key) || { aceptado: 0, en_revision: 0, en_espera: 0 }
      };
    }
    
    // Only add to players list if status is 'aceptado'
    if (reg.status === 'aceptado') {
      acc[key].players.push({
        name: reg.player_name,
        class: reg.player_class || 'Desconocida',
        role: reg.player_role || 'DPS',
        raid_role: reg.raid_role || 'asistente', // Asegurar que siempre tenga un valor por defecto
        gear_score: reg.gear_score || 0,
        status: reg.status,
        raid_status: reg.status, // Para compatibilidad
        registration_status: reg.status // Para compatibilidad
      });
    }
    
    return acc;
  }, {});
  
  raidSchedules = Object.values(schedulesMap);
  
  // Log the data for debugging
  console.log('Fetched raid schedules:', raidSchedules);
  
} catch (err) {
  console.error('Error fetching raid schedules:', err);
  error = 'Error al cargar los horarios de raid. Por favor, inténtalo de nuevo más tarde.';
}


---

<Layout title="Horarios de Raid">
  <div class="text-white">
    <div class="max-w-7xl mx-auto">
      <div class="text-center mb-12">
        <h1 class="text-4xl font-extrabold tracking-tight text-white">
          <span class="block">Horarios de Raid</span>
        </h1>
      </div>
      
      <div class="relative">

      <div class="relative">
        {error && (
          <div class="bg-red-900/50 border border-red-700 text-red-200 px-4 py-3 rounded relative mb-6 max-w-7xl mx-auto" role="alert">
            <div class="flex items-center">
              <div class="py-1">
                <svg class="fill-current h-6 w-6 text-red-300 mr-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20">
                  <path d="M2.93 17.07A10 10 0 1 1 17.07 2.07 10 10 0 0 1 2.93 17.07zm12.73-1.41A8 8 0 1 0 4.34 4.34a8 8 0 0 0 11.32 11.32zM9 11V9h2v6H9v-4zm0-6h2v2H9V5z"/>
                </svg>
              </div>
              <div>
                <p class="font-bold">¡Error!</p>
                <p class="text-sm">{error}</p>
              </div>
            </div>
          </div>
        )}
        
        <div class="max-w-7xl mx-auto relative">
          <!-- Custom Slider Container -->
          <div class="slider-container max-w-7xl mx-auto overflow-hidden">
            <!-- Pagination -->
            <div class="slider-pagination bg-gray-900/50 backdrop-blur-sm rounded-lg overflow-hidden border border-amber-600/30 transition-all duration-200 hover:border-amber-500/50 hover:shadow-lg hover:shadow-amber-500/10" id="slider-pagination">
              {wotlkRaids.map((raid, index) => {
                const raidSchedulesForRaid = raidSchedules.filter(schedule => 
                  schedule.raid_id === raid.id
                );
                const approvedSchedulesCount = raidSchedulesForRaid.filter(schedule => {
                  if (!schedule.players) return false;
                  return schedule.players.some(player => 
                    player.status === 'aceptado' || 
                    player.raid_status === 'aceptado' ||
                    (player as any).registration_status === 'aceptado' ||
                    player.status === 'accepted' ||
                    player.raid_status === 'accepted' ||
                    (player as any).registration_status === 'accepted' ||
                    player.status === 'confirmed' ||
                    player.raid_status === 'confirmed' ||
                    (player as any).registration_status === 'confirmed'
                  );
                }).length;
                
                return (
                  <button 
                    key={raid.id}
                    class="pagination-item group relative" 
                    data-index={index}
                    aria-label={`Ir a ${raid.name}`}
                  >
                    <span class="pagination-dot"></span>
                    <span class="pagination-label">
                      {raid.name}
                      {approvedSchedulesCount > 0 && (
                        <span class="absolute -top-1 left-1/2 transform -translate-x-1/2 -translate-y-1/2 bg-amber-500 text-white text-xs font-bold rounded-full w-5 h-5 flex items-center justify-center group-hover:bg-amber-400 transition-colors">
                          {approvedSchedulesCount}
                        </span>
                      )}
                    </span>
                  </button>
                );
              })}
            </div>
            <div class="slider-track" id="slider-track">
              {wotlkRaids.map((raid, index) => {
                const raidSchedulesForRaid = raidSchedules.filter(schedule => 
                  schedule.raid_id === raid.id
                );
                
                // Only count players with 'aceptado' status for the total
                const totalPlayers = raidSchedulesForRaid.reduce((sum, sched) => {
                  if (!sched.players) return sum;
                  const acceptedPlayers = sched.players.filter(player => 
                    player.status === 'aceptado' || 
                    player.raid_status === 'aceptado' ||
                    player.registration_status === 'aceptado' ||
                    player.status === 'accepted' ||
                    player.raid_status === 'accepted' ||
                    player.registration_status === 'accepted' ||
                    player.status === 'confirmed' ||
                    player.raid_status === 'confirmed' ||
                    player.registration_status === 'confirmed'
                  );
                  return sum + acceptedPlayers.length;
                }, 0);
                
                return (
                  <div class="swiper-slide">
                    <div class="w-full" data-raid-id={raid.id}>
                      <div class="h-full bg-gray-900/70 backdrop-blur-sm rounded-lg overflow-hidden flex flex-col border border-amber-600/30 transition-all duration-200 hover:border-amber-500/50 hover:shadow-lg hover:shadow-amber-500/10">
                      {/* Header with raid image and basic info */}
                      <div class="relative">
                        <img 
                          src={raid.image} 
                          alt={raid.name}
                          class="w-full h-36 object-cover"
                          onerror="this.onerror=null; this.src='/images/raids/default.jpg'"
                        />
                        <div class="absolute inset-0 bg-gradient-to-t from-gray-900/90 to-transparent"></div>
                        <div class="absolute bottom-0 left-0 right-0 p-4">
                          <div class="flex justify-between items-end">
                            <div>
                              <h3 class="text-xl font-bold text-white">{raid.name}</h3>
                                  <p class="text-xs text-gray-300 flex items-center">
                                    <svg class="w-3 h-3 mr-1 text-amber-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />
                                    </svg>
                                    {raidSchedulesForRaid.filter(schedule => {
                                      if (!schedule.players) return false;
                                      return schedule.players.some(player => 
                                        player.status === 'aceptado' || 
                                        player.raid_status === 'aceptado' ||
                                        player.registration_status === 'aceptado' ||
                                        player.status === 'accepted' ||
                                        player.raid_status === 'accepted' ||
                                        player.registration_status === 'accepted' ||
                                        player.status === 'confirmed' ||
                                        player.raid_status === 'confirmed' ||
                                        player.registration_status === 'confirmed'
                                      );
                                    }).length} {raidSchedulesForRaid.length === 1 ? 'horario' : 'horarios'}
                                  </p>
                                </div>
                                <div class="flex flex-col items-end">
                                  <span class="text-amber-300 text-xs font-medium">Gear Score Mínimo</span>
                                  <span class="bg-amber-500/20 text-amber-300 text-xs font-medium px-2 py-0.5 rounded border border-amber-500/30">
                                    {raid.minGearScore} GS
                                  </span>
                                </div>
                              </div>
                            </div>
                          </div>
                          
                          {/* Next schedule and role info */}
                          <div class="p-4 bg-gray-900/60">
                            
                            {/* Next schedule */}
                            {(() => {
                              const nextSchedule = getNextSchedule(raidSchedulesForRaid);
                              if (!nextSchedule) return null;
                              
                              const acceptedPlayers = nextSchedule.players?.filter(player => 
                                player.status === 'aceptado' || 
                                player.raid_status === 'aceptado' ||
                                player.registration_status === 'aceptado' ||
                                player.status === 'accepted' ||
                                player.raid_status === 'accepted' ||
                                player.registration_status === 'accepted' ||
                                player.status === 'confirmed' ||
                                player.raid_status === 'confirmed' ||
                                player.registration_status === 'confirmed'
                              ) || [];
                              
                              // Don't show the schedule if there are no accepted players
                              if (acceptedPlayers.length === 0) return null;
                              
                              return (
                                <div class="bg-gray-800/50 rounded-lg p-3 border border-gray-700/50">
                                  <div class="flex items-center text-sm text-gray-300 mb-1">
                                    <svg class="w-4 h-4 mr-2 text-yellow-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                                    </svg>
                                    Próximo evento
                                  </div>
                                  <div class="flex justify-between items-center">
                                    <div>
                                      <span class="font-medium text-white">{nextSchedule.day_of_week}</span>
                                      <span class="mx-2 text-gray-400">•</span>
                                      <span class="text-yellow-400">{nextSchedule.start_time}</span>
                                      <span class="mx-2 text-gray-400">•</span>
                                      <span class="text-white-400">Hora server</span>
                                    </div>
                                    <div class="flex items-center space-x-2">
                                      <span class="text-xs bg-blue-600/30 text-blue-300 px-2 py-0.5 rounded flex items-center" title="Jugadores regulares">
                                        <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                                        </svg>
                                        {acceptedPlayers.filter(p => p.raid_role !== 'raid_leader').length}
                                      </span>
                                      <span class="text-xs bg-amber-600/30 text-amber-300 px-2 py-0.5 rounded flex items-center" title="Líderes de raid">
                                        <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z" />
                                        </svg>
                                        {acceptedPlayers.filter(p => p.raid_role === 'raid_leader').length}
                                      </span>
                                    </div>
                                  </div>
                                  {/* Contadores de roles */}
                                  {(() => {
                                    const roleCounts = countPlayersByRole(acceptedPlayers);
                                    return (
                                      <div class="grid grid-cols-4 gap-2 mt-2 text-xs">
                                        <div class="flex flex-col items-center" title="Tanques">
                                          <div class="w-2 h-2 rounded-full bg-blue-500 mb-0.5"></div>
                                          <span class="text-blue-400">T</span>
                                          <span class="text-white">{roleCounts.tank}</span>
                                        </div>
                                        <div class="flex flex-col items-center" title="Sanadores">
                                          <div class="w-2 h-2 rounded-full bg-green-500 mb-0.5"></div>
                                          <span class="text-green-400">H</span>
                                          <span class="text-white">{roleCounts.heal}</span>
                                        </div>
                                        <div class="flex flex-col items-center" title="DPS Cuerpo a Cuerpo">
                                          <div class="w-2 h-2 rounded-full bg-red-500 mb-0.5"></div>
                                          <span class="text-red-400">M</span>
                                          <span class="text-white">{roleCounts.melee}</span>
                                        </div>
                                        <div class="flex flex-col items-center" title="DPS a Distancia">
                                          <div class="w-2 h-2 rounded-full bg-purple-500 mb-0.5"></div>
                                          <span class="text-purple-400">R</span>
                                          <span class="text-white">{roleCounts.ranged}</span>
                                        </div>
                                      </div>
                                    );
                                  })()}
                                </div>
                              );
                            })()}
                            
                            {/* Additional schedules */}
                            {(() => {
                              const nextSchedule = getNextSchedule(raidSchedulesForRaid);
                              
                              // Ordenar horarios por día de la semana y hora
                              const dayOrder = {
                                'lunes': 1,
                                'martes': 2,
                                'miércoles': 3, 'miercoles': 3,
                                'jueves': 4,
                                'viernes': 5,
                                'sábado': 6, 'sabado': 6,
                                'domingo': 7
                              };
                              
                              const sortedSchedules = [...raidSchedulesForRaid].sort((a, b) => {
                                // Convertir a minúsculas y sin acentos para la comparación
                                const dayA = a.day_of_week?.toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g, '') || '';
                                const dayB = b.day_of_week?.toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g, '') || '';
                                
                                // Comparar días
                                if (dayOrder[dayA] !== dayOrder[dayB]) {
                                  return (dayOrder[dayA] || 99) - (dayOrder[dayB] || 99);
                                }
                                
                                // Si es el mismo día, comparar horas
                                const timeA = a.start_time?.replace(':', '') || '0000';
                                const timeB = b.start_time?.replace(':', '') || '0000';
                                return timeA.localeCompare(timeB);
                              });
                              
                              // Filter out the next schedule from the additional schedules
                              const additionalSchedules = nextSchedule 
                                ? sortedSchedules.filter(schedule => schedule.raid_id !== nextSchedule.raid_id || 
                                                                   schedule.day_of_week !== nextSchedule.day_of_week ||
                                                                   schedule.start_time !== nextSchedule.start_time)
                                : [...sortedSchedules];
                              
                              // Filter out schedules with no accepted players
                              const schedulesWithAcceptedPlayers = additionalSchedules.filter(schedule => {
                                return schedule.players?.some(player => 
                                  player.status === 'aceptado' || 
                                  player.raid_status === 'aceptado' ||
                                  player.registration_status === 'aceptado' ||
                                  player.status === 'accepted' ||
                                  player.raid_status === 'accepted' ||
                                  player.registration_status === 'accepted' ||
                                  player.status === 'confirmed' ||
                                  player.raid_status === 'confirmed' ||
                                  player.registration_status === 'confirmed'
                                );
                              });
                              
                              // Only show the button if there are schedules with accepted players
                              if (schedulesWithAcceptedPlayers.length === 0) return null;
                              
                              return (
                              <div class="mt-4">
                                <button 
                                  type="button" 
                                  class="text-xs text-amber-400 hover:text-amber-300 flex items-center"
                                  onclick="this.nextElementSibling.classList.toggle('hidden'); this.querySelector('span').textContent = this.nextElementSibling.classList.contains('hidden') ? 'Mostrar más horarios' : 'Ocultar horarios';"
                                >
                                  <span>Mostrar más horarios</span>
                                  <svg class="w-3 h-3 ml-1 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                                  </svg>
                                </button>
                                <div class="hidden mt-2 space-y-2">
                                  {additionalSchedules.map((schedule, idx) => {
                                    const schedulePlayers = schedule.players?.filter(player => 
                                      player.status === 'aceptado' || 
                                      player.raid_status === 'aceptado' ||
                                      player.registration_status === 'aceptado' ||
                                      player.status === 'accepted' ||
                                      player.raid_status === 'accepted' ||
                                      player.registration_status === 'accepted' ||
                                      player.status === 'confirmed' ||
                                      player.raid_status === 'confirmed' ||
                                      player.registration_status === 'confirmed'
                                    ) || [];
                                   
                                    if (schedulePlayers.length === 0) return null;
                                   
                                    const roleCounts = countPlayersByRole(schedulePlayers);
                                   
                                    return (
                                      <div key={`${schedule.id}-${idx}`} class="bg-gray-800/50 rounded-lg p-2 text-sm border border-gray-700/50">
                                        <div class="flex justify-between items-center">
                                          <div>
                                            <span class="text-gray-300">{schedule.day_of_week}</span>
                                            <span class="mx-2 text-gray-500">•</span>
                                            <span class="text-amber-400">{schedule.start_time}</span>
                                          </div>
                                          <div class="flex items-center space-x-2">
                                            <span class="text-xs bg-blue-600/30 text-blue-300 px-1.5 py-0.5 rounded flex items-center" title="Jugadores regulares">
                                              <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                                              </svg>
                                              {schedulePlayers.filter(p => !['raid_leader', 'lider_raid'].includes(p.raid_role)).length}
                                            </span>
                                            <span class="text-xs bg-amber-600/30 text-amber-300 px-1.5 py-0.5 rounded flex items-center" title="Líderes de raid">
                                              <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z" />
                                              </svg>
                                              {schedulePlayers.filter(p => ['raid_leader', 'lider_raid'].includes(p.raid_role)).length}
                                            </span>
                                          </div>
                                        </div>
                                        <div class="grid grid-cols-4 gap-1 mt-1 text-xs text-gray-400">
                                          <span class="text-center" title="Tanques">
                                            <div class="text-blue-400">T</div>
                                            <div>{roleCounts.tank}</div>
                                          </span>
                                          <span class="text-center" title="Sanadores">
                                            <div class="text-green-400">H</div>
                                            <div>{roleCounts.heal}</div>
                                          </span>
                                          <span class="text-center" title="DPS Cuerpo a Cuerpo">
                                            <div class="text-red-400">M</div>
                                            <div>{roleCounts.melee}</div>
                                          </span>
                                          <span class="text-center" title="DPS a Distancia">
                                            <div class="text-purple-400">R</div>
                                            <div>{roleCounts.ranged}</div>
                                          </span>
                                        </div>
                                      </div>
                                    );
                                  })}
                                </div>
                              </div>
                            );
                          })()}
                        </div>
                        
                        {/* Status indicators */}
                        <div class="p-3 bg-gray-900/60 border-t border-gray-800">
                          <div class="grid grid-cols-3 gap-2 mb-3">
                            {/* En Revisión */}
                            <div class="bg-gray-800/50 rounded p-2 text-center border-l-2 border-amber-500/50">
                              <div class="text-lg font-bold text-amber-400">
                                {raidSchedulesForRaid.reduce((sum, schedule) => 
                                  sum + (schedule.statusCounts?.en_revision || 0), 0
                                )}
                              </div>
                              <div class="text-xs text-gray-400">En Revisión</div>
                            </div>
                            
                            {/* Aceptados */}
                            <div class="bg-gray-800/50 rounded p-2 text-center border-l-2 border-green-500/50">
                              <div class="text-lg font-bold text-green-400">
                                {raidSchedulesForRaid.reduce((sum, schedule) => 
                                  sum + (schedule.statusCounts?.aceptado || 0), 0
                                )}
                              </div>
                              <div class="text-xs text-gray-400">Aceptados</div>
                            </div>
                            
                            {/* En Espera */}
                            <div class="bg-gray-800/50 rounded p-2 text-center border-l-2 border-blue-500/50">
                              <div class="text-lg font-bold text-blue-400">
                                {raidSchedulesForRaid.reduce((sum, schedule) => 
                                  sum + (schedule.statusCounts?.en_espera || 0), 0
                                )}
                              </div>
                              <div class="text-xs text-gray-400">En espera</div>
                            </div>
                          </div>
                        </div>
                        
                        {/* Action button */}
                        <div class="p-3 bg-gray-900/60 border-t border-gray-800">
                          <button 
                            type="button"
                            class="w-full bg-gradient-to-r from-amber-600 to-amber-700 hover:from-amber-500 hover:to-amber-600 text-white text-sm font-medium py-2 px-3 rounded transition-all duration-200 flex items-center justify-center"
                            data-raid-name={raid.name}
                            data-raid-id={raid.id}
                            data-min-gear-score={raid.minGearScore}
                            onclick="handleJoinRaid(this)"
                            data-astro-source-loc="643:28-643:43"
                          >
                            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
                            </svg>
                            Unirse al Raid
                          </button>
                        </div>
                      </div>
                    </div>
                  </div>
                );
              })}
            </div>
            <!-- Navigation Buttons -->
            <button class="slider-nav prev" id="slider-prev" aria-label="Anterior">
              <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M15 18l-6-6 6-6"/>
              </svg>
            </button>
            <button class="slider-nav next" id="slider-next" aria-label="Siguiente">
              <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M9 18l6-6-6-6"/>
              </svg>
            </button>
          </div>
        </div>
            </div>
            </div>
        </div>
      </div>
    </div>
   

    {/* Registration Form Section */}
    <div id="register-section" class="hidden bg-gray-900/50 backdrop-blur-sm border-t border-gray-800 p-6 rounded-lg">
      <div class="max-w-4xl mx-auto">
        <div class="flex justify-between items-start mb-6">
          <div>
            <h3 class="text-xl font-bold text-white">Registro de Raid</h3>
            <p class="text-amber-400 text-sm mt-1">Inscripción para: <span id="raid-title" class="font-medium"></span></p>
          </div>
          <button 
            onclick="document.getElementById('register-section').classList.add('hidden')"
            class="text-gray-400 hover:text-white mt-1"
          >
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
            </svg>
          </button>
        </div>
      
      <form id="registration-form" class="space-y-4">
        <div id="form-errors" class="hidden bg-red-900/50 border border-red-700 text-red-200 p-4 rounded mb-4">
          <p id="error-message"></p>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          {/* Nombre */}
          <div>
            <label for="player-name" class="block text-sm font-medium text-gray-300 mb-1">Nombre del Personaje</label>
            <input 
              type="text" 
              id="player-name" 
              name="player_name" 
              required
              class="w-full px-4 py-2 bg-gray-800 border border-gray-700 rounded-md text-white focus:outline-none focus:ring-2 focus:ring-amber-500 focus:border-transparent"
            />
          </div>
          
          {/* Clase */}
          <div>
            <label for="player-class" class="block text-sm font-medium text-gray-300 mb-1">Clase</label>
            <select 
              id="player-class" 
              name="player_class"
              required
              class="w-full bg-gray-800 border border-gray-700 rounded-lg px-4 py-2 text-white focus:ring-2 focus:ring-amber-500 focus:border-transparent"
            >
              <option value="" disabled selected>Selecciona una clase</option>
              <option value="death-knight">Caballero de la Muerte</option>
              <option value="druid">Druida</option>
              <option value="hunter">Cazador</option>
              <option value="mage">Mago</option>
              <option value="paladin">Paladín</option>
              <option value="priest">Sacerdote</option>
              <option value="rogue">Pícaro</option>
              <option value="shaman">Chamán</option>
              <option value="warlock">Brujo</option>
              <option value="warrior">Guerrero</option>
            </select>
          </div>
          
          {/* Gear Score */}
          <div>
            <label for="gear-score" class="block text-sm font-medium text-gray-300 mb-1">Gear Score</label>
            <input 
              type="number" 
              id="gear-score" 
              name="gear_score" 
              min="0"
              max="7000"
              required
              class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-700 focus:outline-none focus:ring-amber-500 focus:border-amber-500 sm:text-sm rounded-md bg-gray-800 text-white"
              placeholder="Ingresa tu Gear Score"
            />
            <p class="mt-1 text-xs text-gray-400">Mínimo requerido: <span id="min-gear-score" class="text-amber-400">0</span></p>
          </div>
          
          {/* Rol */}
          <div>
            <label for="player-role" class="block text-sm font-medium text-gray-300 mb-1">Rol Principal</label>
            <select 
              id="player-role" 
              name="player_role"
              required
              class="w-full bg-gray-800 border border-gray-700 rounded-lg px-4 py-2 text-white focus:ring-2 focus:ring-amber-500 focus:border-transparent"
            >
              <option value="" disabled selected>Selecciona un rol</option>
              <option value="tank">Tanque</option>
              <option value="healer">Sanador</option>
              <option value="melee">Cuerpo a cuerpo</option>
              <option value="ranged">A distancia</option>
            </select>
          </div>
          
          {/* Rol en Raid */}
          <div>
            <label for="raid-role" class="block text-sm font-medium text-gray-300 mb-1">Rol en Raid</label>
            <select 
              id="raid-role" 
              name="raid_role"
              required
              class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-700 focus:outline-none focus:ring-amber-500 focus:border-amber-500 sm:text-sm rounded-md bg-gray-800 text-white"
            >
              <option value="asistente" selected>Asistente</option>
              <option value="raid_leader">Raid Leader</option>
            </select>
          </div>
          
          {/* Día de la Semana */}
          <div>
            <label for="raid-day" class="block text-sm font-medium text-gray-300 mb-1">Día de la Semana</label>
            <select 
              id="raid-day" 
              name="day_of_week"
              required
              class="w-full bg-gray-800 border border-gray-700 rounded-lg px-4 py-2 text-white focus:ring-2 focus:ring-amber-500 focus:border-transparent"
            >
              <option value="" disabled selected>Selecciona un día</option>
              <option value="lunes">Lunes</option>
              <option value="martes">Martes</option>
              <option value="miercoles">Miércoles</option>
              <option value="jueves">Jueves</option>
              <option value="viernes">Viernes</option>
              <option value="sabado">Sábado</option>
              <option value="domingo">Domingo</option>
            </select>
          </div>
          
          {/* Hora de Conexión */}
          <div>
            <label for="connection-time" class="block text-sm font-medium text-gray-300 mb-1">Hora de Conexión</label>
            <input 
              type="time" 
              id="connection-time" 
              name="start_time" 
              required
              class="w-full bg-gray-800 border border-gray-700 rounded-lg px-4 py-2 text-white focus:ring-2 focus:ring-amber-500 focus:border-transparent"
            />
          </div>
        </div>
        
        <div class="pt-4 flex space-x-4">
          <button 
            type="submit"
            class="bg-amber-600 hover:bg-amber-700 text-white font-medium py-2 px-6 rounded-lg transition-colors flex items-center"
          >
            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
            </svg>
            Enviar Solicitud
          </button>
          <button 
            type="button"
            onclick="document.getElementById('register-section').classList.add('hidden')"
            class="bg-gray-700 hover:bg-gray-600 text-white font-medium py-2 px-6 rounded-lg transition-colors"
          >
            Cancelar
          </button>
        </div>
      </form>
    </div>
  </div>
  
 
    {/* Cómo funciona Section */}
    <div class="max-w-7xl mx-auto px-4 py-12 sm:px-6 lg:px-8">
      <div class="bg-gray-900/50 backdrop-blur-sm rounded-xl border border-amber-600/30 p-6 md:p-8">
        <h2 class="text-2xl font-bold text-amber-400 mb-6">¿Cómo funciona?</h2>
        <div class="grid md:grid-cols-2 gap-6">
          <div class="space-y-3">
            <div class="flex items-start">
              <div class="flex-shrink-0 mt-1">
                <svg class="h-5 w-5 text-amber-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />
                </svg>
              </div>
              <div class="ml-3">
                <h3 class="font-medium text-white">Próximo evento</h3>
                <p class="mt-1 text-sm text-gray-300">El primer horario que ves es el próximo evento oficial programado por parte de la hermandad.</p>
              </div>
            </div>
            
            <div class="flex items-start">
              <div class="flex-shrink-0 mt-1">
                <svg class="h-5 w-5 text-amber-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
              </div>
              <div class="ml-3">
                <h3 class="font-medium text-white">Horarios adicionales</h3>
                <p class="mt-1 text-sm text-gray-300">Usa el botón "Mostrar más horarios" para ver todos eventos programados.</p>
              </div>
            </div>
          </div>
          
          <div class="space-y-3">
            <div class="flex items-start">
              <div class="flex-shrink-0 mt-1">
                <svg class="h-5 w-5 text-amber-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" />
                </svg>
              </div>
              <div class="ml-3">
                <h3 class="font-medium text-white">Participación</h3>
                <p class="mt-1 text-sm text-gray-300">Cada horario programado aceptado muestra la cantidad de jugadores que estan buscando raid en ese mismo horario.</p>
              </div>
            </div>
            
            <div class="flex items-start">
              <div class="flex-shrink-0 mt-1">
                <svg class="h-5 w-5 text-amber-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
              </div>
              <div class="ml-3">
                <h3 class="font-medium text-white">¿Quieres unirte?</h3>
                <p class="mt-1 text-sm text-gray-300">Haz clic en "Unirse al Raid" para inscribirte en un horario disponible o proponer tu horario y atraer jugadores y lideres de raid para formar un grupo.</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    {/* Guía de Registro Section */}
    <div class="max-w-7xl mx-auto px-4 py-12 sm:px-6 lg:px-8">
      <div class="bg-gray-900/50 backdrop-blur-sm rounded-xl border border-amber-600/30 p-6 md:p-8">
        <h2 class="text-2xl font-bold text-amber-400 mb-6">Guía de Registro</h2>
        
        <div class="grid md:grid-cols-2 gap-8">
          <div class="space-y-6">
            <div class="flex items-start">
              <div class="flex-shrink-0 mt-1">
                <div class="h-8 w-8 rounded-full bg-amber-500/20 flex items-center justify-center">
                  <svg class="h-5 w-5 text-amber-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                  </svg>
                </div>
              </div>
              <div class="ml-4">
                <h3 class="font-medium text-white">Nombre del Personaje</h3>
                <p class="mt-1 text-sm text-gray-300">Ingresa el nombre exacto de tu personaje en el juego para poder invitarlo al raid.</p>
              </div>
            </div>

            <div class="flex items-start">
              <div class="flex-shrink-0 mt-1">
                <div class="h-8 w-8 rounded-full bg-amber-500/20 flex items-center justify-center">
                  <svg class="h-5 w-5 text-amber-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
                  </svg>
                </div>
              </div>
              <div class="ml-4">
                <h3 class="font-medium text-white">Clase y rol de personaje</h3>
                <p class="mt-1 text-sm text-gray-300">Selecciona tu clase principal y el tipo de rol que usarás durante el raid.</p>
              </div>
            </div>

            <div class="flex items-start">
              <div class="flex-shrink-0 mt-1">
                <div class="h-8 w-8 rounded-full bg-amber-500/20 flex items-center justify-center">
                  <svg class="h-5 w-5 text-amber-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z" />
                  </svg>
                </div>
              </div>
              <div class="ml-4">
                <h3 class="font-medium text-white">Puntuación de Equipo (GS) y rol de raid</h3>
                <p class="mt-1 text-sm text-gray-300">Ingresa tu Gear Score actual. Asegúrate de que cumple con los requisitos mínimos del raid. Si eres quien va a armar la banda, regístrate como raid leader.</p>
              </div>
            </div>
          </div>

          <div class="space-y-6">
            <div class="flex items-start">
              <div class="flex-shrink-0 mt-1">
                <div class="h-8 w-8 rounded-full bg-amber-500/20 flex items-center justify-center">
                  <svg class="h-5 w-5 text-amber-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                  </svg>
                </div>
              </div>
              <div class="ml-4">
                <h3 class="font-medium text-white">Disponibilidad</h3>
                <p class="mt-1 text-sm text-gray-300">Selecciona el día y hora en el que estás disponible para raidear. Esto nos ayudará a organizar los grupos y dar prioridad a los que tengan más disponibilidad.</p>
              </div>
            </div>

            <div class="flex items-start">
              <div class="flex-shrink-0 mt-1">
                <div class="h-8 w-8 rounded-full bg-amber-500/20 flex items-center justify-center">
                  <svg class="h-5 w-5 text-amber-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                  </svg>
                </div>
              </div>
              <div class="ml-4">
                <h3 class="font-medium text-white">Objetivo</h3>
                <p class="mt-1 text-sm text-gray-300">Consolidar horarios para que podamos organizar los grupos y dar prioridad a los que tengan más disponibilidad.</p>
              </div>
            </div>

            <div class="flex items-start">
              <div class="flex-shrink-0 mt-1">
                <div class="h-8 w-8 rounded-full bg-amber-500/20 flex items-center justify-center">
                  <svg class="h-5 w-5 text-amber-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                  </svg>
                </div>
              </div>
              <div class="ml-4">
                <h3 class="font-medium text-white">Confirmación</h3>
                <p class="mt-1 text-sm text-gray-300">Revisa que toda la información sea correcta antes de enviar tu solicitud.</p>
              </div>
            </div>
          </div>
        </div>

        <div class="mt-8 pt-6 border-t border-gray-800">
          <h3 class="text-lg font-medium text-amber-400 mb-3">¿Necesitas ayuda?</h3>
          <p class="text-sm text-gray-300">Si tienes alguna duda o necesitas asistencia con tu registro, no dudes en contactar a un oficial de la hermandad a través del canal de Discord.</p>
          <div class="mt-4">
            <a href="https://discord.gg/j5CaXYMhws" class="inline-flex items-center text-amber-400 hover:text-amber-300 text-sm font-medium">
              Unirse a Discord
              <svg class="ml-1 h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0l-7 7m7-7H3" />
              </svg>
            </a>
          </div>
        </div>
      </div>
    </div>

  <script is:inline>
    // Función para manejar el clic en el botón "Unirse al Raid"
    function handleJoinRaid(button) {
      const raidName = button.getAttribute('data-raid-name');
      const minGearScore = button.getAttribute('data-min-gear-score');
      const raidId = button.getAttribute('data-raid-id');
      
      // Actualizar el título y los campos del formulario
      document.getElementById('raid-title').textContent = raidName;
      document.getElementById('gear-score').min = minGearScore;
      document.getElementById('gear-score').value = minGearScore;
      document.getElementById('min-gear-score').textContent = minGearScore;
      
      // Almacenar el ID de la raid en una variable global
      window.currentRaidId = raidId;
      
      // Mostrar el formulario
      document.getElementById('register-section').classList.remove('hidden');
      
      // Desplazarse suavemente al formulario
      button.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    }

    document.addEventListener('DOMContentLoaded', () => {
      const form = document.getElementById('registration-form');
      const formErrors = document.getElementById('form-errors');
      const errorMessage = document.getElementById('error-message');
      const raidTitle = document.getElementById('raid-title');
      let currentRaidId = null; // Variable para almacenar el ID de la raid actual
      
      // Función para mostrar mensajes de éxito
      function showSuccess(message) {
        formErrors.className = 'bg-green-900/50 border border-green-700 text-green-200 p-4 rounded mb-4';
        errorMessage.textContent = message;
        formErrors.classList.remove('hidden');
        
        // Ocultar el mensaje después de 5 segundos
        setTimeout(() => {
          formErrors.classList.add('hidden');
        }, 5000);
      }
      
      // Función para mostrar errores
      function showError(message) {
        formErrors.className = 'bg-red-900/50 border border-red-700 text-red-200 p-4 rounded mb-4';
        errorMessage.textContent = message;
        formErrors.classList.remove('hidden');
        
        // Hacer scroll al formulario de error
        formErrors.scrollIntoView({ behavior: 'smooth', block: 'center' });
      }
      
      // Función para ocultar mensajes
      function hideErrors() {
        formErrors.classList.add('hidden');
      }
      
      // Helper function to get form data as object
      function getFormData(formElement) {
        const formData = new FormData(formElement);
        const data = {};
        
        for (let [key, value] of formData.entries()) {
          // Convert string 'true'/'false' to boolean
          if (value === 'true') value = true;
          if (value === 'false') value = false;
          
          // Handle multiple values for the same key (like checkboxes)
          if (data[key] !== undefined) {
            if (!Array.isArray(data[key])) {
              data[key] = [data[key]];
            }
            data[key].push(value);
          } else {
            data[key] = value;
          }
        }
        
        return data;
      }
      
      // Form submission handler
      if (form) {
        form.addEventListener('submit', async (e) => {
          e.preventDefault();
          hideErrors();
          
          const submitButton = form.querySelector('button[type="submit"]');
          const formData = new FormData(form);
          
          // Agregar el ID de la raid al formulario si no está presente
          if (!formData.get('raid_id')) {
            if (window.currentRaidId) {
              formData.append('raid_id', window.currentRaidId.toString());
            } else {
              throw new Error('No se ha seleccionado ninguna raid. Por favor, inténtalo de nuevo.');
            }
          }
          const originalButtonText = submitButton?.innerHTML || 'Enviar';
          
          try {
            // Deshabilitar botón de envío y mostrar estado de carga
            if (submitButton) {
              submitButton.disabled = true;
              submitButton.innerHTML = `
                <svg class="animate-spin -ml-1 mr-2 h-5 w-5 text-white inline-block" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                  <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                  <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                Enviando...
              `;
            }
            
            // Enviar datos del formulario
            const response = await fetch(window.location.pathname, {
              method: 'POST',
              body: formData,
              headers: {
                'Accept': 'application/json'
              }
            });
            
            const result = await response.json();
            
            if (!response.ok) {
              throw new Error(result.error || 'Error al procesar la solicitud');
            }
            
            // Mostrar mensaje de éxito
            showSuccess('¡Registro exitoso! Tu solicitud ha sido enviada para revisión.');
            
            // Limpiar el formulario
            form.reset();
            
            // Cerrar el modal después de 2 segundos
            setTimeout(() => {
              const modal = document.getElementById('register-section');
              if (modal) {
                modal.classList.add('hidden');
              }
            }, 2000);
          } catch (error) {
            console.error('Error al enviar el formulario:', error);
            showError(error instanceof Error ? error.message : 'No se pudo enviar la solicitud. Por favor, inténtalo de nuevo.');
          } finally {
            // Restaurar el botón de envío
            if (submitButton) {
              submitButton.disabled = false;
              submitButton.innerHTML = 'Enviar solicitud';
            }
          }
        });
      }
    });
  </script>


</Layout>

<script is:inline>
  document.addEventListener('DOMContentLoaded', () => {
    const slider = document.querySelector('.slider-container');
    const track = document.querySelector('.slider-track');
    const slides = document.querySelectorAll('.swiper-slide');
    const prevBtn = document.getElementById('slider-prev');
    const nextBtn = document.getElementById('slider-next');
    const dots = document.querySelectorAll('.pagination-dot');
    
    if (!slider || !track || slides.length === 0 || !prevBtn || !nextBtn) {
      console.error('Slider elements not found');
      return;
    }
    
    let currentSlide = 0;
    let slideWidth = 0;
    
    function initSlider() {
      // Set initial slide width
      updateSlideWidth();
      
      // Set initial positions
      updateSlider();
      
      // Add event listeners
      addEventListeners();
    }
    
    function updateSlideWidth() {
      // Get the width of the visible area
      const containerWidth = slider.offsetWidth;
      // Set slide width to 100% of container width
      slideWidth = containerWidth;
      
      // Set width for each slide
      slides.forEach(slide => {
        slide.style.width = `${slideWidth}px`;
        slide.style.flexShrink = '0';
      });
      
      // Set track width to fit all slides
      track.style.width = `${slideWidth * slides.length}px`;
    }
    
    function updateSlider() {
      // Update track position
      track.style.transform = `translateX(-${currentSlide * slideWidth}px)`;
      
      // Update active dot
      updateDots();
      
      // Update button states
      updateButtons();
    }
    
    function updateDots() {
      dots.forEach((dot, index) => {
        dot.classList.toggle('active', index === currentSlide);
      });
    }
    
    function updateButtons() {
      prevBtn.disabled = currentSlide === 0;
      nextBtn.disabled = currentSlide === slides.length - 1;
    }
    
    function goToSlide(index) {
      if (index >= 0 && index < slides.length) {
        currentSlide = index;
        updateSlider();
      }
    }
    
    function addEventListeners() {
      // Navigation buttons
      prevBtn.addEventListener('click', () => {
        if (currentSlide > 0) {
          currentSlide--;
          updateSlider();
        }
      });
      
      nextBtn.addEventListener('click', () => {
        if (currentSlide < slides.length - 1) {
          currentSlide++;
          updateSlider();
        }
      });
      
      // Dots navigation - Handle clicks on pagination items
      const paginationItems = document.querySelectorAll('.pagination-item');
      paginationItems.forEach((item, index) => {
        item.addEventListener('click', (e) => {
          e.preventDefault();
          goToSlide(index);
        });
      });
      
      // Keyboard navigation
      document.addEventListener('keydown', (e) => {
        if (e.key === 'ArrowLeft' && currentSlide > 0) {
          currentSlide--;
          updateSlider();
        } else if (e.key === 'ArrowRight' && currentSlide < slides.length - 1) {
          currentSlide++;
          updateSlider();
        }
      });
      
      // Handle window resize
      let resizeTimer;
      window.addEventListener('resize', () => {
        clearTimeout(resizeTimer);
        resizeTimer = setTimeout(() => {
          updateSlideWidth();
          updateSlider();
        }, 100);
      });
    }
    
    // Initialize the slider
    initSlider();
  });
</script>

<style>
  /* Slider container */
  .swiper-container {
    width: 100%;
    padding: 40px 60px 80px;
    position: relative;
    max-width: 1400px;
    margin: 0 auto;
  }
  
  /* Slide styles */
  .swiper-slide {
    box-sizing: border-box;
    width: calc(100% - 40px); /* Adjust width to account for padding */
  }
  
  /* Navigation buttons */
  .swiper-button-next,
  .swiper-button-prev {
    color: #f59e0b;
    width: 44px;
    height: 44px;
    background: rgba(31, 41, 55, 0.9);
    border-radius: 50%;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    top: 50%;
    margin-top: -22px;
    z-index: 10;
  }
  
  .swiper-button-next {
    right: 0;
  }
  
  .swiper-button-prev {
    left: 0;
  }
  
  .swiper-button-next:before,
  .swiper-button-prev:before {
    content: '';
    width: 12px;
    height: 12px;
    border-top: 2px solid #f59e0b;
    border-right: 2px solid #f59e0b;
    position: absolute;
  }
  
  .swiper-button-next:before {
    transform: rotate(45deg);
    margin-left: -4px;
  }
  
  .swiper-button-prev:before {
    transform: rotate(-135deg);
    margin-right: -4px;
  }
  
  .swiper-button-next:hover,
  .swiper-button-prev:hover {
    background: rgba(55, 65, 81, 0.8);
    transform: scale(1.1);
  }
  
  .swiper-button-next:after,
  .swiper-button-prev:after {
    font-size: 1.2rem;
  }
  
  
  .slider-track {
    display: flex;
    transition: transform 0.4s ease;
    will-change: transform;
  }
  
  .swiper-slide {
    flex-shrink: 0;
    width: 100%;
    box-sizing: border-box;
  }
  
  .slider-nav {
    position: absolute;
    top: 60%;
    transform: translateY(-50%);
    width: 3rem;
    height: 3rem;
    border-radius: 50%;
    background: rgba(31, 41, 55, 0.9);
    color: #f59e0b;
    border: none;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 10;
    transition: all 0.3s ease;
  }
  
  .slider-nav:hover {
    background: #1f2937;
    transform: translateY(-50%) scale(1.1);
  }
  
  .slider-nav:disabled {
    opacity: 0.3;
    cursor: not-allowed;
    transform: translateY(-50%);
  }
  
  .slider-nav.prev {
    left: -2rem;
  }
  
  .slider-nav.next {
    right: -2rem;
  }
  
  .slider-nav svg {
    width: 1.5rem;
    height: 1.5rem;
  }
  
  .slider-pagination {
    display: flex;
    justify-content: center;
    align-items: center;
    padding: 0.5rem;
    padding-top: 2rem;
    gap: 2rem;
    position: relative;
    z-index: 10;
    margin-bottom: 1rem;
    flex-wrap: wrap;
  }
  
  .pagination-item {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 0.5rem;
    cursor: pointer;
    transition: all 0.2s ease;
    background: none;
    border: none;
    color: inherit;
    padding: 0.5rem;
    margin: 0;
    font: inherit;
    outline: inherit;
  }
  
  .pagination-item:focus {
    outline: 2px solid #fbbf24;
    outline-offset: 2px;
    border-radius: 0.25rem;
  }
  
  .pagination-item:hover .pagination-dot {
    transform: scale(1.1);
  }
  
  .pagination-item:hover .pagination-label {
    color: #fbbf24; /* amber-400 */
  }
  
  .pagination-label {
    color: #ffffff; /* white */
    font-size: 0.875rem; /* text-sm */
    font-weight: 700; /* bold */
    transition: color 0.2s ease;
    text-align: center;
    white-space: nowrap;
  }
  
  .pagination-dot {
    width: 2.5rem;
    height: 0.5rem;
    border-radius: 0.25rem;
    background: #4b5563;
    border: none;
    cursor: pointer;
    padding: 0;
    transition: all 0.3s ease;
  }
  
  .pagination-dot.active {
    background: #f59e0b;
    transform: scale(1.1);
  }
  
  .pagination-dot:not(.active):hover {
    background: #6b7280;
  }
  
  @media (min-width: 768px) {
    
  }
  
</style>



  <style>
    /* Slider container styles */
    .swiper-container {
      width: 100%;
      overflow: hidden;
    margin-top: 1.5rem;
    gap: 0.5rem;
    padding: 0.5rem 0;
  }
  
  #pagination button {
    transition: all 0.3s ease;
    border-radius: 9999px;
    cursor: pointer;
    outline: none;
    border: 2px solid transparent;
  }
  
  #pagination button:hover,
  #pagination button:focus-visible {
    background-color: #f59e0b !important;
    border-color: rgba(245, 158, 11, 0.5);
    transform: scale(1.1);
  }
  
  #pagination button:active {
    transform: scale(0.95);
  }
  
  #pagination button {
    transition: all 0.3s ease;
    border-radius: 0.5rem;
  }
  
  /* Animations */
  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
  }

  .fade-in {
    animation: fadeIn 0.5s ease-out forwards;
  }

  /* Custom scrollbar */
  ::-webkit-scrollbar {
    width: 8px;
    height: 8px;
  }
  
  ::-webkit-scrollbar-track {
    background: rgba(255, 255, 255, 0.05);
    border-radius: 4px;
  }
  
  ::-webkit-scrollbar-thumb {
    background: rgba(180, 83, 9, 0.5);
    border-radius: 4px;
  }
  
  ::-webkit-scrollbar-thumb:hover {
    background: rgba(217, 119, 6, 0.7);
  }

  /* Responsive adjustments */
  @media (max-width: 768px) {
    .container {
      padding-left: 1rem;
      padding-right: 1rem;
    }
  }
</style>