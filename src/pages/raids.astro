---
import Layout from '../components/layout/Layout.astro';
import { supabase } from '../lib/supabase';
// Import components
import RaidRulesModal from '../components/raids/RaidRulesModal.astro';
import RaidSurvey from '../components/RaidSurvey.astro';

// Función auxiliar para contar jugadores por rol
type PlayerRole = 'tank' | 'healer' | 'melee' | 'ranged';

function countPlayersByRole(players) {
  if (!players) return { tank: 0, healer: 0, melee: 0, ranged: 0 };
  return players.reduce(
    (acc, player) => {
      // Priorizar player_role o raid_role
      const role = (player.player_role || player.role || '').toLowerCase();
      const className = (player.class || '').toLowerCase();

      // Verificar si es tanque (incluyendo variaciones de la DB)
      if (role.includes('tank') || role.includes('tanque')) {
        acc.tank = (acc.tank || 0) + 1;
      }
      // Verificar si es sanador (incluyendo variaciones de la DB como 'healer', 'heal', etc)
      else if (role.includes('heal') || role.includes('sanador') || role.includes('sanación')) {
        acc.healer = (acc.healer || 0) + 1;
      }
      // Verificar DPS
      else {
        if (role.includes('melee') || role.includes('cuerpo a cuerpo')) {
          acc.melee = (acc.melee || 0) + 1;
        } else if (role.includes('ranged') || role.includes('distancia') || role.includes('rango')) {
          acc.ranged = (acc.ranged || 0) + 1;
        } else {
          // Fallback por clase
          const meleeClasses = [
            'warrior', 'guerrero', 
            'paladin', 'paladín', 
            'deathknight', 'death-knight', 'caballero', 'dk',
            'rogue', 'pícaro', 'picaro'
          ];
          if (meleeClasses.some((c) => className.includes(c))) {
            acc.melee = (acc.melee || 0) + 1;
          } else {
            acc.ranged = (acc.ranged || 0) + 1;
          }
        }
      }
      return acc;
    },
    { tank: 0, healer: 0, melee: 0, ranged: 0 }
  );
}

// Define types
interface Raid {
  id: string; // Cambiado de number a string (Nombre de la raid)
  name: string;
  image: string;
  description: string;
  minGearScore: number;
  rules?: string;
}

interface Player {
  name: string;
  class: string;
  role: string;
  status?: string; 
  raid_status?: string; 
}

interface RaidSchedule {
  id: string; // Cambiado de number a string
  raid_id: string; // Cambiado de number a string
  raid_name: string;
  difficulty: string;
  day_of_week: string;
  start_time: string;
  players: Player[];
  is_official_core?: boolean;
}

// WotLK Raid Information

// Fetch raid schedules from Supabase
let raidSchedules: RaidSchedule[] = [];
let error: string | null = null;

// Import roster data and utils
import rosterData from '../data/roster.json';
const globalLastUpdate = rosterData.globalLastUpdate;

// Find the player who updated the roster
const lastUpdatedBy = Object.entries(rosterData.players).find(
  ([_, player]: [string, any]) => player.leaderData?.lastUpdate === globalLastUpdate
)?.[0] || 'Desconocido';

import { validatePublicNote } from '../utils/rosterUtils';

// Define a default raid structure for when we only have a name
const createRaidFromName = (name: string, gs: number = 5000): Raid => {
  const nameLower = name.toLowerCase();
  let image = '/images/raids/iccfarm.jpg';
  if (nameLower.includes('toc')) image = '/images/raids/tocfarm.jpg';
  else if (nameLower.includes('sr') || nameLower.includes('sagrario')) image = '/images/raids/sr.jpg';
  else if (nameLower.includes('lk')) image = '/images/raids/icclk.jpg';

  return {
    id: name, // El ID es ahora el nombre
    name,
    image,
    description: 'Raid oficial de la hermandad.',
    minGearScore: gs,
    rules: ''
  };
};

// Create a list of all possible raids exclusively from roster.json leaderData
const allAvailableRaids: Raid[] = [];
const seenRaids = new Set<string>();

if (rosterData && rosterData.players) {
  Object.values(rosterData.players).forEach((member: any) => {
    const leaderData = member.leaderData;
    if (!leaderData || !leaderData.cores || !Array.isArray(leaderData.cores)) return;

    leaderData.cores.forEach((core) => {
      if (!core.raid) return;

      const coreRaidKey = core.raid; // Usar el nombre original para evitar filtrado excesivo
      if (!seenRaids.has(coreRaidKey)) {
        seenRaids.add(coreRaidKey);
        allAvailableRaids.push(createRaidFromName(core.raid, core.gs || 5000));
      }
    });
  });
}

// Process roster data to get parsed members
const parsedMembers = Object.entries(rosterData.players).map(([playerName, member]: [string, any]) => {
  const publicNote = member.publicNote || '';
  const validation = validatePublicNote(publicNote, playerName);

  // Find character block
  const charBlock = validation.blocks?.find((b) => b.type === 'character')?.parsedData;

  let gs = 0;
  let role = 'D'; // Default to DPS
  let dualGs = 0;
  let dualRole = null;

  if (charBlock) {
    // Normalize GS: if < 100, assume it's k (e.g. 5.8 -> 5800)
    let rawGs = charBlock.mainGearScore || 0;
    if (rawGs > 0 && rawGs < 100) {
      gs = rawGs * 1000;
    } else {
      gs = rawGs;
    }

    role = charBlock.mainRole || 'D';

    // Handle dual role
    let rawDualGs = charBlock.dualGearScore || 0;
    if (rawDualGs > 0 && rawDualGs < 100) {
      dualGs = rawDualGs * 1000;
    } else {
      dualGs = rawDualGs;
    }
    dualRole = charBlock.dualRole || null;
  }

  return {
    name: playerName,
    class: member.class, // Mantener original para visualización
    normalizedClass: (member.class || '').toLowerCase().trim().replace(/ /g, '').replace(/-/g, ''), // Clase normalizada para lógica
    role: role,
    gearScore: gs,
    dualRole: dualRole,
    dualGearScore: dualGs,
    publicNote: publicNote,
    noteValidation: validation, // Add the full validation object
    guild_leave: member.guildLeave === true,
    is_sanctioned: member.isSanctioned === 1 || member.isSanctioned === true || member.guildLeave === true,
    is_guild_member: member.guildLeave === false,
  };
});

// Calculate eligible members for each raid
// 1. All eligible members (Min GS only) - For schedule specific view
const raidEligibleMembers = {};
// 2. Range filtered members (Min GS <= GS < Next Raid Min GS) - For general raid view
const raidEligibleMembersRange = {};

allAvailableRaids.forEach((raid, index) => {
  // All eligible (Min GS) - Check both main and dual GS
  raidEligibleMembers[raid.id] = parsedMembers.filter(
    (m) =>
      (m.gearScore >= raid.minGearScore || (m.dualGearScore && m.dualGearScore >= raid.minGearScore)) &&
      !m.guild_leave &&
      m.is_guild_member
  );

  // Range filtered
  const minGs = raid.minGearScore;
  // Find the next raid that has a strictly higher GS requirement
  const nextTierRaid = allAvailableRaids
    .slice()
    .sort((a, b) => a.minGearScore - b.minGearScore)
    .find((r) => r.minGearScore > minGs);
  const maxGs = nextTierRaid ? nextTierRaid.minGearScore : Infinity;

  raidEligibleMembersRange[raid.id] = parsedMembers.filter(
    (m) =>
      ((m.gearScore >= minGs && m.gearScore < maxGs) ||
      (m.dualGearScore && m.dualGearScore >= minGs && m.dualGearScore < maxGs)) &&
      !m.guild_leave &&
      m.is_guild_member
  );
});

// Function to get the next upcoming schedule
// Function to get sorted schedules including the 1 hour buffer
function getSortedSchedules(schedules) {
  if (!schedules || schedules.length === 0) return [];

  const dayOrder = {
    lunes: 1,
    martes: 2,
    miercoles: 3,
    miércoles: 3,
    jueves: 4,
    viernes: 5,
    sabado: 6,
    sábado: 6,
    domingo: 7,
    'sin dia': 8,
    'sin día': 8,
    'hora-definida-sin-dia': 9,
    'sin-dia-ni-hora': 10,
  };

  return schedules
    .filter((schedule) => {
      // Show all schedules that come from roster.json (official cores)
      // or those that have accepted players
      if (schedule.is_official_core) return true;
      
      if (!schedule.players || schedule.players.length === 0) return false;
      return schedule.players.some(
        (player) =>
          (['aceptado', 'accepted', 'confirmed'].includes(player.status) ||
          ['aceptado', 'accepted', 'confirmed'].includes(player.raid_status) ||
          ['aceptado', 'accepted', 'confirmed'].includes(player.registration_status)) &&
          (player.is_guild_member || player.from_supabase)
      );
    })
    .sort((a, b) => {
      const dayA = a.day_of_week
        .toLowerCase()
        .normalize('NFD')
        .replace(/[\u0300-\u036f]/g, '');
      const dayB = b.day_of_week
        .toLowerCase()
        .normalize('NFD')
        .replace(/[\u0300-\u036f]/g, '');

      const orderA = dayOrder[dayA] || 99;
      const orderB = dayOrder[dayB] || 99;

      if (orderA !== orderB) {
        return orderA - orderB;
      }

      return a.start_time.localeCompare(b.start_time);
    });
}

// Group schedules by day and raid
try {
  // Handle form submission
  if (Astro.request.method === 'POST') {
    try {
      const formData = await Astro.request.formData();
      const formDataObj = Object.fromEntries(formData.entries());

      // Define registration data with index signature
      const registrationData: {
        player_name: string;
        player_class: string;
        player_role: string;
        day_of_week: string;
        start_time: string;
        raid_id: string;
        [key: string]: string; // Index signature
      } = {
        player_name: formDataObj.player_name?.toString() || '',
        player_class: formDataObj.player_class?.toString() || '',
        player_role: formDataObj.player_role?.toString() || '',
        day_of_week: formDataObj.day_of_week?.toString() || '',
        start_time: formDataObj.start_time?.toString() || '',
        raid_id: formDataObj.raid_id?.toString().toUpperCase() || '',
      };

      console.log('Processed registration data:', registrationData);

      // Validate required fields
      const requiredFields = [
        'player_name',
        'player_class',
        'player_role',
        'day_of_week',
        'start_time',
        'raid_id',
      ];
      const missingFields = requiredFields.filter((field) => !registrationData[field]);

      if (missingFields.length > 0) {
        return new Response(
          JSON.stringify({
            error: 'Faltan campos requeridos',
            missingFields,
          }),
          {
            status: 400,
            headers: {
              'Content-Type': 'application/json',
            },
          }
        );
      }

      // Check for existing registrations within the time window
      const startTime = new Date(`1970-01-01T${registrationData.start_time}:00`);
      const minTime = new Date(startTime);
      minTime.setHours(minTime.getHours() - 3);
      const maxTime = new Date(startTime);
      maxTime.setHours(maxTime.getHours() + 3);

      // Format times for Supabase query
      const formatTime = (date) => date.toTimeString().substring(0, 5);

      const { data: existingRegistrations, error: checkError } = await supabase
        .from('raid_registrations')
        .select('*')
        .eq('player_name', registrationData.player_name)
        .eq('day_of_week', registrationData.day_of_week)
        .gte('start_time', formatTime(minTime))
        .lte('start_time', formatTime(maxTime));

      if (checkError) {
        console.error('Error checking existing registrations:', checkError);
        throw new Error('Error al verificar registros existentes');
      }

      if (existingRegistrations && existingRegistrations.length > 0) {
        const existing = existingRegistrations[0];
        return new Response(
          JSON.stringify({
            error: 'Ya tienes un registro en este horario',
            details: `Ya estás registrado en una raid el ${existing.day_of_week} a las ${existing.start_time}. No puedes registrarte en otra raid 3 horas antes o después.`,
          }),
          {
            status: 400,
            headers: { 'Content-Type': 'application/json' },
          }
        );
      }

      // If we get here, all validations passed
      console.log('Attempting to insert into Supabase...');

      // Prepare the data to insert
      const insertData = {
        player_name: registrationData.player_name,
        player_class: registrationData.player_class,
        player_role: registrationData.player_role,
        day_of_week: registrationData.day_of_week,
        start_time: registrationData.start_time,
        raid_id: registrationData.raid_id,
        status: 'en_revision',
      };

      console.log('Data to insert:', insertData);

      // Insert into Supabase
      console.log('Attempting to insert into Supabase table: raid_registrations');
      console.log('Insert data:', JSON.stringify(insertData, null, 2));

      try {
        const { data: result, error: insertError } = await supabase
          .from('raid_registrations')
          .insert([insertData])
          .select();

        if (insertError) {
          console.error('Supabase error details:', insertError);
          throw insertError;
        }

        console.log('Insert successful, result:', result);

        // Return success response
        return new Response(
          JSON.stringify({
            success: true,
            data: result[0],
          }),
          {
            status: 200,
            headers: {
              'Content-Type': 'application/json',
            },
          }
        );
      } catch (dbError) {
        console.error('Database error:', {
          message: dbError.message,
          details: dbError.details,
          hint: dbError.hint,
          stack: dbError.stack
        });
        throw dbError;
      }

      // El retorno de éxito ahora está dentro del bloque try
    } catch (error) {
      return new Response(
        JSON.stringify({
          error: 'Error al procesar la solicitud',
          details: error.message,
        }),
        {
          status: 500,
          headers: {
            'Content-Type': 'application/json',
          },
        }
      );
    }

    try {
      console.log('Attempting to insert into Supabase...');

      // Prepare the data to insert
      const insertData = {
        player_name: registrationData.player_name,
        player_class: registrationData.player_class,
        player_role: registrationData.player_role,
        raid_role: registrationData.raid_role,
        day_of_week: registrationData.day_of_week,
        start_time: registrationData.start_time,
        raid_id: parseInt(registrationData.raid_id) || 0,
        status: 'en_revision',
        created_at: new Date().toISOString(),
      };

      console.log('Data to insert:', insertData);

      // Insert into Supabase
      const { data: result, error } = await supabase
        .from('raid_registrations')
        .insert([insertData])
        .select();

      if (error) {
        console.error('Supabase error details:', error);
        throw error;
      }

      // Redirect to prevent form resubmission
      return new Response(
        JSON.stringify({
          success: true,
          data: result[0],
        }),
        {
          status: 200,
          headers: {
            'Content-Type': 'application/json',
          },
        }
      );
    } catch (error) {
      console.error('Error saving registration:', error);
      return new Response(
        JSON.stringify({
          error: 'Error al guardar el registro',
          details: error.message,
        }),
        { status: 500 }
      );
    }
  }

  // Mapeo de días de la semana a números para ordenar
  const dayOrder = {
    lunes: 1,
    martes: 2,
    miercoles: 3,
    jueves: 4,
    viernes: 5,
    sabado: 6,
    domingo: 7,
    'sin dia': 8,
    'sin día': 8,
    'hora-definida-sin-dia': 9,
    'sin-dia-ni-hora': 10,
  };

  // Obtener el día actual en español
  const days = ['domingo', 'lunes', 'martes', 'miercoles', 'jueves', 'viernes', 'sabado'];
  const todayIndex = new Date().getDay(); // 0 (domingo) a 6 (sábado)
  const today = days[todayIndex];

  // Get all raid schedules with different statuses
  const { data: raidSchedulesData, error: fetchError } = await supabase
    .from('raid_registrations')
    .select(
      `
      id,
      raid_id,
      player_name,
      player_class,
      player_role,
      day_of_week,
      start_time,
      status
    `
    )
    .in('status', ['aceptado', 'en_revision', 'en_espera'])
    .order('day_of_week', { ascending: true })
    .order('start_time', { ascending: true });

  // Ordenar los horarios para que el próximo sea el primero
  if (raidSchedulesData) {
    raidSchedulesData.sort((a, b) => {
      const normalizedDayA = a.day_of_week?.toLowerCase()
        .normalize('NFD')
        .replace(/[\u0300-\u036f]/g, '');
      const normalizedDayB = b.day_of_week?.toLowerCase()
        .normalize('NFD')
        .replace(/[\u0300-\u036f]/g, '');

      // Primero por día de la semana (empezando por hoy)
      const dayDiffA = (dayOrder[normalizedDayA] + 7 - dayOrder[today]) % 7;
      const dayDiffB = (dayOrder[normalizedDayB] + 7 - dayOrder[today]) % 7;

      if (dayDiffA !== dayDiffB) {
        return dayDiffA - dayDiffB;
      }

      // Si es el mismo día, ordenar por hora
      return a.start_time.localeCompare(b.start_time);
    });
  }

  // Only show 'aceptado' status in the display
  const displaySchedules =
    raidSchedulesData?.filter((schedule) => schedule.status === 'aceptado') || [];

  // Count unique schedule slots (grouped by raid_id, day_of_week, and start_time)
  // Only count 'aceptado' status for schedule totals
  const scheduleCounts = { total: 0 };

  // Get all unique schedule slots with at least one 'aceptado' registration
  const acceptedScheduleSlots = new Set<string>();

  raidSchedulesData?.forEach((schedule) => {
    if (schedule.status === 'aceptado') {
      const slotKey = `${schedule.raid_id.toUpperCase()}-${schedule.day_of_week}-${schedule.start_time}`;
      acceptedScheduleSlots.add(slotKey);
    }
  });

  scheduleCounts.total = acceptedScheduleSlots.size;

  if (fetchError) throw fetchError;

  // Create a map to group schedules by their unique key (raid_id-day_of_week-start_time)
  const schedulesMap = new Map();

  // 1. First, process data from roster.json (Primary source for cores)
  if (rosterData && rosterData.players) {
    Object.entries(rosterData.players).forEach(([playerName, member]: [string, any]) => {
      const leaderData = member.leaderData;
      if (!leaderData || !leaderData.cores || !Array.isArray(leaderData.cores)) return;

      leaderData.cores.forEach((core) => {
        if (!core.raid || !core.schedule) return;

        // Buscar coincidencia exacta por nombre original
        const raid = allAvailableRaids.find((r) => r.name === core.raid);

        if (!raid) return;

        // Normalize schedule: try to extract time and day
        let normalizedTime = "Sin hora";
        let normalizedDay = "Sin día"; // Default if not found

        const timeMatch = String(core.schedule).match(/(\d{1,2}:\d{2})/);
        if (timeMatch) normalizedTime = timeMatch[1].padStart(5, '0');

        const dayMatch = String(core.schedule).toLowerCase().match(/(lunes|martes|miercoles|miércoles|jueves|viernes|sabado|sábado|domingo)/);
        if (dayMatch) {
          normalizedDay = dayMatch[1]
            .normalize('NFD')
            .replace(/[\u0300-\u036f]/g, '')
            .replace('miércoles', 'miercoles')
            .replace('sábado', 'sabado');
        }

        const key = `${raid.id.toUpperCase()}-${normalizedDay}-${normalizedTime}`;

        if (!schedulesMap.has(key)) {
          schedulesMap.set(key, {
            id: raid.id.toUpperCase(),
            raid_id: raid.id.toUpperCase(),
            raid_name: raid.name,
            difficulty: raid.name.includes('10') ? '10' : '25',
            day_of_week: normalizedDay,
            start_time: normalizedTime,
            players: [],
            is_official_core: true, // Mark as official core from roster
          });
        }

        const schedule = schedulesMap.get(key);
        schedule.is_official_core = true; // Ensure it's marked if combined with others

        // Add the leader themselves to the players array
        if (!schedule.players.some(p => p.name.toLowerCase() === playerName.toLowerCase())) {
          schedule.players.push({
          name: playerName,
          class: member.class || 'Desconocida',
          role: 'DPS', // Default, will be updated if in members
          raid_role: 'lider',
          status: 'aceptado',
          raid_status: 'aceptado',
          registration_status: 'aceptado',
          note: member.publicNote || '',
          achievements: member.reconocimientos || 0,
          raids_count: member.raidsCompletadas || 0,
          is_guild_member: member.guildLeave === false,
          guild_leave: member.guildLeave === true,
          is_sanctioned: member.isSanctioned === 1 || member.isSanctioned === true || member.guildLeave === true,
        });
        } else {
          // If already there, ensure raid_role is 'lider'
          const existingPlayer = schedule.players.find(p => p.name.toLowerCase() === playerName.toLowerCase());
          if (existingPlayer) existingPlayer.raid_role = 'lider';
        }

        // Add members from the core to this schedule
        if (core.members && Array.isArray(core.members)) {
          core.members.forEach((m) => {
            if (!m.name) return;
            
            // Look for full member info in roster
            const rosterPlayerKey = Object.keys(rosterData.players).find(
              (key) => key.toLowerCase() === m.name.trim().toLowerCase()
            );
            const rosterPlayer = rosterPlayerKey ? rosterData.players[rosterPlayerKey] : null;

            const existingPlayerIndex = schedule.players.findIndex(p => p.name.toLowerCase() === m.name.toLowerCase());
            
            if (existingPlayerIndex !== -1) {
              // Update existing player info if they were already added as leader
              const existingPlayer = schedule.players[existingPlayerIndex];
              existingPlayer.role = m.role || existingPlayer.role;
              // Don't overwrite raid_role: 'lider' if they are already leader
              if (existingPlayer.raid_role !== 'lider') {
                existingPlayer.raid_role = m.isLeader ? 'lider' : 'asistente';
              }
            } else {
              schedule.players.push({
                name: m.name,
                class: m.class || rosterPlayer?.class || 'Desconocida',
                role: m.role || 'DPS',
                raid_role: m.isLeader ? 'lider' : 'asistente',
                status: 'aceptado',
                raid_status: 'aceptado',
                registration_status: 'aceptado',
                note: rosterPlayer?.publicNote || '',
                achievements: rosterPlayer?.reconocimientos || 0,
                raids_count: rosterPlayer?.raidsCompletadas || 0,
                is_guild_member: rosterPlayer ? rosterPlayer.guildLeave === false : false,
                guild_leave: rosterPlayer?.guildLeave === true,
                is_sanctioned: m.isSanctioned === 1 || m.isSanctioned === true || rosterPlayer?.isSanctioned === 1 || rosterPlayer?.isSanctioned === true || rosterPlayer?.guildLeave === true,
              });
            }
          });
        }
      });
    });
  }

  // 2. Then, integrate data from Supabase (External registrations)
  raidSchedulesData?.forEach((reg) => {
    if (!reg.day_of_week || !reg.start_time || !reg.player_name) return;

    // Normalize day of week (remove accents, convert to lowercase)
    const normalizedDay =
      reg.day_of_week
        .toLowerCase()
        .normalize('NFD')
        .replace(/[\u0300-\u036f]/g, '')
        .replace('miércoles', 'miercoles')
        .replace('sábado', 'sabado');

    // Normalize time (ensure consistent format)
    const normalizedTime = reg.start_time.toString().padStart(5, '0');

    // Ahora buscamos la raid por su ID que es su nombre (normalizado a mayúsculas)
    const raid = allAvailableRaids.find((r) => r.id.toUpperCase() === reg.raid_id.toUpperCase());
    if (!raid) return;

    // Create a consistent key with normalized values
    const key = `${reg.raid_id.toUpperCase()}-${normalizedDay}-${normalizedTime}`;

    if (!schedulesMap.has(key)) {
      schedulesMap.set(key, {
        id: reg.id,
        raid_id: reg.raid_id.toUpperCase(),
        raid_name: raid.name,
        difficulty: reg.difficulty || (raid.name.includes('10') ? '10' : '25'),
        day_of_week: normalizedDay,
        start_time: normalizedTime,
        players: [],
      });
    }

    // Only add to players list if status is 'aceptado' and NOT already added from roster
    if (reg.status === 'aceptado') {
      const schedule = schedulesMap.get(key);
      
      const existingPlayer = schedule.players.find(p => p.name.toLowerCase() === reg.player_name.toLowerCase());
      
      if (!existingPlayer) {
        // Look for the player in the roster data to get additional info
        const rosterPlayerKey = Object.keys(rosterData.players).find(
          (key) => key.toLowerCase() === reg.player_name.trim().toLowerCase()
        );
        const rosterPlayer = rosterPlayerKey ? rosterData.players[rosterPlayerKey] : null;
        
        schedule.players.push({
          name: reg.player_name,
          class: reg.player_class || 'Desconocida',
          role: reg.player_role || 'DPS',
          raid_role: reg.raid_role || 'asistente',
          status: reg.status,
          raid_status: reg.status,
          registration_status: reg.status,
          note: rosterPlayer?.publicNote || '',
          achievements: rosterPlayer?.reconocimientos || 0,
          raids_count: rosterPlayer?.raidsCompletadas || 0,
          is_guild_member: rosterPlayer ? rosterPlayer.guildLeave === false : false,
          guild_leave: rosterPlayer?.guildLeave === true,
          is_sanctioned: rosterPlayer?.isSanctioned === 1 || rosterPlayer?.isSanctioned === true || rosterPlayer?.guildLeave === true,
          from_supabase: true,
        });
      } else {
        // Si ya existe (fue agregado desde el roster), marcamos que también está en supabase
        existingPlayer.from_supabase = true;
      }
    }
  });

  // Convert the map values to an array and sort
  raidSchedules = Array.from(schedulesMap.values()).sort((a, b) => {
    // Sort by raid_id first (localeCompare since it's a string name now)
    if (a.raid_id !== b.raid_id) {
      return a.raid_id.localeCompare(b.raid_id);
    }

    // Then by day of week
    const dayOrder = {
      lunes: 1,
      martes: 2,
      miercoles: 3,
      jueves: 4,
      viernes: 5,
      sabado: 6,
      domingo: 7,
      'sin dia': 8,
      'sin día': 8,
      'hora-definida-sin-dia': 9,
      'sin-dia-ni-hora': 10,
    };

    const dayA =
      a.day_of_week
        ?.toLowerCase()
        .normalize('NFD')
        .replace(/[\u0300-\u036f]/g, '') || '';
    const dayB =
      b.day_of_week
        ?.toLowerCase()
        .normalize('NFD')
        .replace(/[\u0300-\u036f]/g, '') || '';

    const dayAOrder = dayOrder[dayA] || 99;
    const dayBOrder = dayOrder[dayB] || 99;

    if (dayAOrder !== dayBOrder) {
      return dayAOrder - dayBOrder;
    }

    // Finally by start time, with '00:00 ST' always last
    const timeA = (a.start_time || '').replace(' ST', '');
    const timeB = (b.start_time || '').replace(' ST', '');

    // If one of the times is '00:00', it should come last
    if (timeA === '00:00' && timeB !== '00:00') return 1;
    if (timeA !== '00:00' && timeB === '00:00') return -1;

    // If both are '00:00', maintain their order
    if (timeA === '00:00' && timeB === '00:00') return 0;

    // Otherwise, do a normal time comparison
    return timeA.localeCompare(timeB);
  });

  // Raid schedules loaded successfully
} catch (err) {
  error = 'Error al cargar los horarios de raid. Por favor, inténtalo de nuevo más tarde.';
}
---

<script is:inline>
    function openRaidRulesModal(btn) {
      const name = btn.getAttribute('data-raid-name');
      const rules = btn.getAttribute('data-raid-rules');
      const gs = btn.getAttribute('data-raid-gs');

      console.log('Datos recuperados del botón:', { name, rules, gs });

      const modal = document.getElementById('raid-rules-modal');
      // Usar querySelector para los elementos dentro del modal
      const nameEl = modal ? modal.querySelector('[data-js-id="modal-raid-name"]') : null;
      const gsEl = modal ? modal.querySelector('[data-js-id="modal-raid-gs"]') : null;
      const rulesEl = modal ? modal.querySelector('[data-js-id="modal-raid-rules"]') : null;

      console.log('Elementos del modal encontrados:', { modal: !!modal, nameEl: !!nameEl, gsEl: !!gsEl, rulesEl: !!rulesEl });

      if (modal && nameEl && rulesEl) {
        nameEl.textContent = name;
        if (gsEl) gsEl.textContent = `[${gs} GS]`;
        
        // Procesar y formatear las reglas
        if (rulesEl && rules) {
          const formattedRules = rules.split('\n')
            .filter(line => line.trim() !== '')
            .map((rule, index) => {
              // Clean up any existing numbering at the start
              const cleanRule = rule.replace(/^\d+[\.\-]\s*/, '').trim();
              
              const colonIndex = cleanRule.indexOf(':');
              let content = '';
              
              if (colonIndex !== -1) {
                const beforeColon = cleanRule.substring(0, colonIndex);
                const afterColon = cleanRule.substring(colonIndex + 1);
                content = `<span class="font-bold text-amber-400">${beforeColon}:</span>${afterColon}`;
              } else {
                content = cleanRule;
              }

              return `
                <div class="flex gap-3 mb-3 p-2 rounded hover:bg-white/5 transition-colors">
                  <span class="flex-shrink-0 flex items-center justify-center w-6 h-6 rounded-full bg-amber-500/10 border border-amber-500/20 text-amber-400 text-xs font-bold font-mono">
                    ${index + 1}
                  </span>
                  <span class="text-gray-300">${content}</span>
                </div>
              `;
            }).join('');
          rulesEl.innerHTML = formattedRules;
        }
        
        modal.classList.remove('hidden');
        modal.classList.add('flex');
        document.body.style.overflow = 'hidden';
      } else {
        console.error('Error: No se pudieron encontrar todos los elementos del modal para actualizar.');
      }
    }

    function closeRaidRulesModal() {
      const modal = document.getElementById('raid-rules-modal');
      if (modal) {
        modal.classList.add('hidden');
        modal.classList.remove('flex');
        document.body.style.overflow = 'auto';
      }
    }

    // Exponer globalmente
    window.openRaidRulesModal = openRaidRulesModal;
    window.closeRaidRulesModal = closeRaidRulesModal;
  </script>

<Layout title="Horarios de Raid">
  <div class="text-white">
    <div class="max-w-7xl mx-auto">
      <!-- Título de la sección -->
    <div
      id="reglas-hermandad"
      class="flex flex-col md:flex-row md:justify-between md:items-end gap-4 px-2 mb-6"
    >
      <div class="flex items-center space-x-4">
        <div
          class="w-12 h-12 bg-gradient-to-br from-amber-600 to-amber-800 rounded-xl flex items-center justify-center shadow-lg shadow-amber-900/20 transform -rotate-2 hover:rotate-0 transition-transform duration-300"
        >
          <svg fill="#000000" viewBox="0 0 32 32" version="1.1" xmlns="http://www.w3.org/2000/svg"><g id="SVGRepo_bgCarrier" stroke-width="0"></g><g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"></g><g id="SVGRepo_iconCarrier"> <title>frozen-arrow</title> <path d="M29.273 22.896l1.593 0.252-0.945-1.164 0.012-0.017h-0.026l-13.872-17.076-4.264 3.134-11.224-6.487v2.104l11.552 6.678 3.535-2.587 10.094 12.463-15.852-2.514 0.51-4.446-9.839-5.694v2.196l3.626 2.097 1.388 6.633 1.083-5.204 1.592 0.92-0.62 5.284 0.019 0.003 1.425 7.753 0.667-3.645 1.245 7.298 1.773-10.45 1.347 7.328 1.269-6.937 1.105 2.248 0.998-2.040 1.175 0.186 1.376 8.297 1.3-7.874 0.799 0.126 1.531 3.931 0.922-2.379 1.129 6.14 1.099-6.008 1.047 1.466z"></path> </g></svg>
        </div>
        <div>
          <span class="text-sm md:text-3xl font-black text-white uppercase tracking-tighter italic">
            Raids de la <span
              class="text-transparent bg-clip-text bg-gradient-to-r from-amber-200 via-amber-400 to-amber-200 pr-1"
              >Hermandad</span
            >
          </span>
          <span
            class="text-amber-300/60 font-medium tracking-widest uppercase text-[10px] flex items-center space-x-1"
          >
            <span class="self-end">Registro de jugadores en core</span>
          </span>
        </div>
      </div>
      <div class="flex items-center text-[10px] text-amber-300/40 bg-gray-900/40 px-3 py-1.5 rounded-full border border-amber-900/30 shadow-inner">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3 mr-1.5 opacity-70" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
        </svg>
        <span class="font-medium tracking-wide">
          Actualizado por <span class="text-amber-300 font-semibold">{lastUpdatedBy}</span>: {globalLastUpdate ? new Date(globalLastUpdate * 1000).toLocaleString('es-ES', { 
            day: '2-digit', 
            month: '2-digit', 
            year: 'numeric', 
            hour: '2-digit', 
            minute: '2-digit' 
          }) : 'N/A'}
        </span>
      </div>
    </div>

      <div class="relative">
        <div class="relative">
          {
            error && (
              <div
                class="bg-red-900/50 border border-red-700 text-red-200 px-4 py-3 rounded relative mb-6 max-w-7xl mx-auto"
                role="alert"
              >
                <div class="flex items-center">
                  <div class="py-1">
                    <svg
                      class="fill-current h-6 w-6 text-red-300 mr-4"
                      xmlns="http://www.w3.org/2000/svg"
                      viewBox="0 0 20 20"
                    >
                      <path d="M2.93 17.07A10 10 0 1 1 17.07 2.07 10 10 0 0 1 2.93 17.07zm12.73-1.41A8 8 0 1 0 4.34 4.34a8 8 0 0 0 11.32 11.32zM9 11V9h2v6H9v-4zm0-6h2v2H9V5z" />
                    </svg>
                  </div>
                  <div>
                    <p class="font-bold">¡Error!</p>
                    <p class="text-sm">{error}</p>
                  </div>
                </div>
              </div>
            )
          }

          <div class="max-w-7xl mx-auto relative">
            <!-- Custom Slider Container -->
            <div class="slider-container max-w-7xl mx-auto overflow-hidden">
              <!-- Pagination -->
              <div
                class="slider-pagination bg-gradient-to-br from-amber-900/20 via-gray-900/40 to-amber-800/10 backdrop-blur-sm border border-amber-600/30 rounded-md p-4 shadow-2xl hover:border-amber-500/60 transition-all duration-300 hover:shadow-lg hover:shadow-amber-500/10"
                id="slider-pagination"
              >
                {
                  allAvailableRaids
                    .filter((raid) =>
                      raidSchedules.some((schedule) => schedule.raid_id === raid.id)
                    )
                    .map((raid, index) => {
                      const raidSchedulesForRaid = raidSchedules.filter(
                        (schedule) => schedule.raid_id === raid.id
                      );
                      const approvedSchedulesCount = raidSchedulesForRaid.filter((schedule) => {
                        // Include official cores even if empty
                        if (schedule.is_official_core) return true;
                        
                        if (!schedule.players) return false;
                        return schedule.players.some(
                          (player) =>
                            (player.status === 'aceptado' ||
                            player.raid_status === 'aceptado' ||
                            (player as any).registration_status === 'aceptado' ||
                            player.status === 'accepted' ||
                            player.raid_status === 'accepted' ||
                            (player as any).registration_status === 'accepted' ||
                            player.status === 'confirmed' ||
                            player.raid_status === 'confirmed' ||
                            (player as any).registration_status === 'confirmed') &&
                            (player.is_guild_member || player.from_supabase)
                        );
                      }).length;

                      return (
                        <button
                          key={raid.id}
                          class="pagination-item group relative"
                          data-index={index}
                          aria-label={`Ir a ${raid.name}`}
                        >
                          <span class="pagination-dot" />
                          <span class="pagination-label">
                            {raid.name}
                            {approvedSchedulesCount > 0 && (
                              <span class="absolute -top-1 left-1/2 transform -translate-x-1/2 -translate-y-1/2 bg-amber-500 text-white text-xs font-bold rounded-full w-5 h-5 flex items-center justify-center group-hover:bg-amber-400 transition-colors">
                                {approvedSchedulesCount}
                              </span>
                            )}
                          </span>
                        </button>
                      );
                    })
                }
              </div>
              <div class="slider-track" id="slider-track">
                {
                  allAvailableRaids
                    .filter((raid) => {
                      // Only include raids that have at least one schedule
                      return raidSchedules.some((schedule) => schedule.raid_id === raid.id);
                    })
                    .map((raid, index) => {
                      const raidSchedulesForRaid = raidSchedules.filter(
                        (schedule) => schedule.raid_id === raid.id
                      );

                      // Only count players with 'aceptado' status for the total
                      const totalPlayers = raidSchedulesForRaid.reduce((sum, sched) => {
                        if (!sched.players) return sum;
                        const acceptedPlayers = sched.players.filter(
                          (player) =>
                            (player.status === 'aceptado' ||
                            player.raid_status === 'aceptado' ||
                            player.registration_status === 'aceptado' ||
                            player.status === 'accepted' ||
                            player.raid_status === 'accepted' ||
                            player.registration_status === 'accepted' ||
                            player.status === 'confirmed' ||
                            player.raid_status === 'confirmed' ||
                            player.registration_status === 'confirmed' ||
                            sched.is_official_core) &&
                            (player.is_guild_member || player.from_supabase)
                        );
                        return sum + acceptedPlayers.length;
                      }, 0);

                      return (
                        <div class="swiper-slide px-6">
                          <div class="w-full" data-raid-id={raid.id}>
                            <div class="bg-gradient-to-br from-amber-900/20 via-gray-900/40 to-amber-800/10 backdrop-blur-sm border border-amber-600/30 rounded-md shadow-2xl hover:border-amber-500/60 transition-all duration-300 hover:shadow-lg hover:shadow-amber-500/10 overflow-hidden">
                              {/* Header with raid image and basic info */}
                              <div class="relative">
                                
                                <div class="inset-0 bg-gradient-to-t from-gray-900/90 to-transparent" />
                                <div class="bottom-0 left-0 right-0 p-4">
                                  <div class="flex justify-between items-end">
                                    <div>
                                      <h3 class="text-xl font-bold text-white italic">{raid.name}</h3>
                                      {raid.rules && (
                                          <button
                                            data-raid-name={raid.name}
                                            data-raid-rules={raid.rules}
                                            data-raid-gs={raid.minGearScore}
                                            onclick="window.openRaidRulesModal(this)"
                                            class="mt-2 px-3 py-1 bg-amber-700 hover:bg-amber-600 text-white text-xs font-medium rounded-full transition-colors duration-200 flex items-center gap-1"
                                          >
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                                            </svg>
                                            Ver Reglas
                                          </button>
                                        )}
                                      <p class="text-xs text-gray-300 flex items-center">
                                        <svg
                                          class="w-3 h-3 mr-1 text-amber-400"
                                          fill="none"
                                          stroke="currentColor"
                                          viewBox="0 0 24 24"
                                        >
                                          <path
                                            stroke-linecap="round"
                                            stroke-linejoin="round"
                                            stroke-width="2"
                                            d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"
                                          />
                                        </svg>
                                        {
                                          raidSchedulesForRaid.filter((schedule) => {
                                            // Include official cores even if empty
                                            if (schedule.is_official_core) return true;
                                            
                                            if (!schedule.players) return false;
                                            return schedule.players.some(
                                              (player) =>
                                                (['aceptado', 'accepted', 'confirmed'].includes(player.status) ||
                                                ['aceptado', 'accepted', 'confirmed'].includes(player.raid_status) ||
                                                ['aceptado', 'accepted', 'confirmed'].includes(player.registration_status)) &&
                                                (player.is_guild_member || player.from_supabase)
                                            );
                                          }).length
                                        }{' '}
                                        {raidSchedulesForRaid.length === 1 ? 'CORE' : 'CORES'}
                                      </p>
                                    </div>
                                    <div class="flex flex-col items-end">
                                      <span class="text-amber-300 text-xs font-medium">
                                        Gear Score Mínimo
                                      </span>
                                      <span class="bg-amber-500/20 text-amber-300 text-xs font-medium px-2 py-0.5 rounded border border-amber-500/30">
                                        {raid.minGearScore} GS
                                      </span>
                                    </div>
                                  </div>
                                </div>
                              </div>

                              {/* Next schedule and role info */}
                              <div class="p-4">
                                {/* Eligible Roster Members Button */}
                                <div class="mb-4">
                                  <button
                                    onclick={`openRosterModal('${raid.id}')`}
                                    class="w-full bg-indigo-600/20 hover:bg-indigo-600/30 text-indigo-300 border border-indigo-500/30 rounded-md px-3 py-2 text-sm font-medium transition-colors flex items-center justify-between group"
                                  >
                                    <div class="flex items-center">
                                      <svg
                                        class="w-4 h-4 mr-2"
                                        fill="none"
                                        stroke="currentColor"
                                        viewBox="0 0 24 24"
                                      >
                                        <path
                                          stroke-linecap="round"
                                          stroke-linejoin="round"
                                          stroke-width="2"
                                          d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"
                                        />
                                      </svg>
                                      <span>Personajes de la hermandad en etapa {raid.name}</span>
                                    </div>
                                    <span class="bg-indigo-500/20 text-indigo-200 px-2 py-0.5 rounded text-xs group-hover:bg-indigo-500/30 border border-indigo-500/20">
                                      {raidEligibleMembersRange[raid.id]?.length || 0}
                                    </span>
                                  </button>
                                </div>

                                {/* Next schedule */}
                                {/* Schedules List */}
                                <div class="space-y-2 pr-1">
                                  {(() => {
                                    const sortedSchedules =
                                      getSortedSchedules(raidSchedulesForRaid);

                                    if (sortedSchedules.length === 0) {
                                      return (
                                        <div class="text-center text-gray-400 py-4 text-sm">
                                          No hay horarios programados
                                        </div>
                                      );
                                    }

                                    // Agrupar horarios por día (asegurando normalización)
                                    const groupedSchedules = sortedSchedules.reduce((acc, schedule) => {
                                      let day = (schedule.day_of_week || '').toLowerCase();
                                      if (day === 'sin dia' || day === 'sin día') {
                                        if (schedule.start_time !== 'Sin hora') {
                                          day = 'hora-definida-sin-dia';
                                        } else {
                                          day = 'sin-dia-ni-hora';
                                        }
                                      }
                                      if (!acc[day]) acc[day] = [];
                                      acc[day].push(schedule);
                                      return acc;
                                    }, {});

                                    return Object.entries(groupedSchedules).map(([day, schedules], dayIdx) => {
                                      // Formatear el día para mostrar
                                      let displayDay = day.charAt(0).toUpperCase() + day.slice(1);
                                      if (day === 'hora-definida-sin-dia') {
                                        displayDay = 'Hora definida (Día sin definir)';
                                      } else if (day === 'sin-dia-ni-hora') {
                                        displayDay = 'Día y hora sin definir';
                                      } else if (day === 'sin dia' || day === 'sin día') {
                                        displayDay = 'Día sin definir';
                                      }
                                      
                                      // Calcular total de jugadores para este día
                                      const totalDayPlayers = schedules.reduce((sum, s) => {
                                        // Include members from roster for official cores
                                        const count = s.players?.filter((p) =>
                                          (['aceptado', 'accepted', 'confirmed'].includes(p.status) ||
                                          ['aceptado', 'accepted', 'confirmed'].includes(p.raid_status) ||
                                          ['aceptado', 'accepted', 'confirmed'].includes(p.registration_status) ||
                                          s.is_official_core) &&
                                          (p.is_guild_member || p.from_supabase)
                                        ).length || 0;
                                        return sum + count;
                                      }, 0);

                                      return (
                                        <div 
                                          key={day} 
                                          class="mb-2" 
                                          x-data="{ open: false }"
                                        >
                                          <button
                                            @click="open = !open; $nextTick(() => { if(window.updateSlider) window.updateSlider(); })"
                                            class="w-full flex items-center justify-between p-2 bg-gray-800/30 hover:bg-gray-700/70 rounded-md border border-gray-700/50 transition-colors group"
                                          >
                                            <div class="flex items-center space-x-2">
                                              <svg 
                                                class="w-4 h-4 text-amber-500 transition-transform duration-200"
                                                :class="{ 'rotate-90': open }"
                                                fill="none" 
                                                stroke="currentColor" 
                                                viewBox="0 0 24 24"
                                              >
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                                              </svg>
                                              <span class="font-bold text-white uppercase tracking-wider text-xs">
                                                {displayDay}
                                              </span>
                                            </div>
                                            <div class="flex items-center space-x-2">
                                              <span class="text-[10px] bg-amber-500/20 text-amber-300 px-1.5 py-0.5 rounded-md   border border-amber-500/30">
                                                {schedules.length} {schedules.length === 1 ? 'Core' : 'Cores'}
                                              </span>
                                              <span class="text-[10px] bg-indigo-500/20 text-indigo-300 px-1.5 py-0.5 rounded-md border border-indigo-500/30">
                                                {totalDayPlayers} Jugadores
                                              </span>
                                            </div>
                                          </button>

                                          <div 
                                            x-show="open" 
                                            x-transition:enter="transition ease-out duration-200"
                                            x-transition:enter-start="opacity-0 transform scale-95"
                                            x-transition:enter-end="opacity-100 transform scale-100"
                                            class="mt-2 space-y-2 pl-2 border-l-2 border-gray-700/30"
                                          >
                                            {schedules.map((schedule, idx) => {
                                              const schedulePlayers =
                                                schedule.players?.filter(
                                                  (player) =>
                                                    (['aceptado', 'accepted', 'confirmed'].includes(
                                                      player.status
                                                    ) ||
                                                    ['aceptado', 'accepted', 'confirmed'].includes(
                                                      player.raid_status
                                                    ) ||
                                                    ['aceptado', 'accepted', 'confirmed'].includes(
                                                      player.registration_status
                                                    ) ||
                                                    schedule.is_official_core) &&
                                                    (player.is_guild_member || player.from_supabase)
                                                ) || [];

                                              const roleCounts = countPlayersByRole(schedulePlayers.filter(p => !p.is_sanctioned));

                                              return (
                                                <div
                                                  key={`${schedule.id}-${idx}`}
                                                  class="bg-gray-800/50 rounded-md p-3 border border-gray-700/50 hover:border-amber-500/30 transition-colors"
                                                >
                                                  <div class="flex justify-between items-center mb-2">
                                                    <div>
                                                      <span class="text-amber-400">
                                                        {schedule.start_time}
                                                      </span>
                                                      <span class="mx-2 text-gray-400">•</span>
                                                      <span class="text-xs text-gray-500">Server</span>
                                                    </div>
                                                  {/* Action Buttons for Players and Leaders */}
                                                  <div class="flex flex-col items-center md:flex-row space-y-2 md:space-y-0 space-x-2 mt-2 bg-gray-900/40 p-1.5 rounded-md border border-gray-700/30">
                                            
                                                    
                                                    <button
                                                      data-leaders={JSON.stringify({
                                                        leaders: (schedulePlayers || [])
                                                          .filter((p) => p && p.raid_role === 'lider')
                                                          .map((p) => ({
                                                            name: String(p.name || ''),
                                                            class: String(p.class || ''),
                                                            role: String(p.raid_role || ''),
                                                            player_role: String(p.player_role || p.role || 'default'),
                                                            note: p.note || p.public_note || '',
                                                            achievements: p.achievements || 0,
                                                            raids_count: p.raids_count || 0,
                                                            is_leader: true,
                                                            is_guild_member: p.is_guild_member === true,
                                                            guild_leave: p.guild_leave || false,
                                                            is_sanctioned: p.is_sanctioned === true,
                                                            from_supabase: p.from_supabase === true
                                                          })),
                                                      })}
                                                      onclick={`(function(btn) {
                                                      try {
                                                        const data = JSON.parse(btn.getAttribute('data-leaders') || '{}');
                                                        const leaders = data.leaders || [];
                                                        openRaidLeadersModal(leaders, '${raid.name}', '${schedule.day_of_week} ${schedule.start_time}');
                                                      } catch (e) {
                                                        console.error('Error loading raid leaders:', e);
                                                        openRaidLeadersModal([], '${raid.name}', '${schedule.day_of_week} ${schedule.start_time}');
                                                      }
                                                    })(this)`}
                                                      class="text-[10px] md:text-xs bg-amber-600/30 hover:bg-amber-600/40 text-amber-300 px-2 py-1 rounded flex items-center transition-colors border border-amber-500/30 font-bold uppercase tracking-wider"
                                                      title="Ver líderes de raid"
                                                    >
                                                      <svg class="w-3.5 h-3.5 mr-1.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z" />
                                                      </svg>
                                                      Líderes: <span class="ml-1.5 px-1.5 py-0.5 bg-amber-500/20 rounded text-amber-200">{schedulePlayers.filter((p) => p.raid_role === 'lider').length}</span>
                                                    </button>

                                                    {/* Eligible Roster Button for Schedule */}
                                                    <button
                                                      onclick={`openRosterModal('${raid.id}', '${schedule.day_of_week}', '${schedule.start_time}')`}
                                                      class="text-[10px] md:text-xs bg-indigo-600/30 hover:bg-indigo-600/40 text-indigo-300 px-2 py-1 rounded flex items-center transition-colors border border-indigo-500/30 font-bold uppercase tracking-wider"
                                                      title="Invitar miembros del roster"
                                                    >
                                                      <svg
                                                        class="w-3.5 h-3.5 mr-1.5"
                                                        fill="none"
                                                        stroke="currentColor"
                                                        viewBox="0 0 24 24"
                                                      >
                                                        <path
                                                          stroke-linecap="round"
                                                          stroke-linejoin="round"
                                                          stroke-width="2"
                                                          d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z"
                                                        />
                                                      </svg>
                                                      Roster: <span class="ml-1.5 px-1.5 py-0.5 bg-indigo-500/20 rounded text-indigo-200">{raidEligibleMembers[raid.id]?.length || 0}</span>
                                                    </button>

                                                    <button
                                                      data-regulars={JSON.stringify({
                                                        regulars: (schedulePlayers || [])
                                                          .map((p) => ({
                                                            name: String(p.name || ''),
                                                            class: String(p.class || ''),
                                                            role: String(p.raid_role || 'asistente'),
                                                            player_role: String(
                                                              p.player_role || p.role || 'default'
                                                            ),
                                                            note: p.note || p.public_note || '',
                                                            achievements: p.achievements || 0,
                                                            raids_count: p.raids_count || 0,
                                                            is_leader: p.raid_role === 'lider',
                                                            is_guild_member: p.is_guild_member === true,
                                                            guild_leave: p.guild_leave === true,
                                                            is_sanctioned: p.is_sanctioned === true,
                                                            from_supabase: p.from_supabase === true
                                                          })),
                                                      })}
                                                      onclick={`(function(btn) {
                                                      try {
                                                        const data = JSON.parse(btn.getAttribute('data-regulars') || '{}');
                                                        const regulars = data.regulars || [];
                                                        openRegularPlayersModal(regulars, '${raid.name}', '${schedule.day_of_week} ${schedule.start_time}', ${raid.minGearScore});
                                                      } catch (e) {
                                                        console.error('Error loading regular players:', e);
                                                        openRegularPlayersModal([], '${raid.name}', '${schedule.day_of_week} ${schedule.start_time}', ${raid.minGearScore});
                                                      }
                                                    })(this)`}
                                                      class="text-[10px] md:text-xs bg-indigo-600/30 hover:bg-indigo-600/40 text-indigo-300 px-2 py-1 rounded flex items-center transition-colors border border-indigo-500/30 font-bold uppercase tracking-wider"
                                                      title="Ver todos los jugadores confirmados"
                                                    >
                                                      <svg class="w-3.5 h-3.5 mr-1.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" />
                                                      </svg>
                                                      Confirmados: <span class="ml-1.5 px-1.5 py-0.5 bg-indigo-500/20 rounded text-indigo-200">{schedulePlayers.length}</span>
                                                    </button>

                                                    
                                                  </div>
                                                </div>

                                                  {/* Warning for raids without leaders */}
                                                  {!schedulePlayers.some(p => p.raid_role === 'lider') && (
                                                    <div class="bg-yellow-900/30 border border-yellow-500/50 p-2 rounded-md mt-2">
                                                      <p class="text-yellow-300 text-xs font-medium">⚠️ ADVERTENCIA</p>
                                                      <p class="text-yellow-200 text-xs">Esta raid no tiene líderes asignados en roster.json.</p>
                                                    </div>
                                                  )}
                                                  
                                                  {/* Role Selection Buttons */}
                                                  <div class="mt-3 pt-3 border-t border-gray-700/50">
                                                    <div class="grid grid-cols-4 gap-2">
                                                      {/* Tank Button */}
                                                      <div class="relative group">
                                                        <button
                                                          type="button"
                                                          class="flex flex-col items-center justify-center p-1.5 rounded bg-blue-900/20 hover:bg-blue-900/40 border border-blue-700/30 hover:border-blue-500/50 transition-all w-full"
                                                          data-raid-name={raid.name}
                                                          data-raid-id={raid.id}
                                                          data-day={schedule.day_of_week}
                                                          data-time={schedule.start_time}
                                                          data-role="tank"
                                                          onclick="openRegistrationModal(this)"
                                                        >
                                                          <div class="w-1.5 h-1.5 rounded-full bg-blue-500 mb-1 group-hover:scale-125 transition-transform" />
                                                          <span class="text-[10px] text-blue-300 font-medium">
                                                            Tank
                                                          </span>
                                                          <span class="text-[10px] text-gray-400">
                                                            {roleCounts.tank}
                                                          </span>
                                                        </button>
                                                        <div class="absolute z-10 invisible group-hover:visible bg-gray-800 text-white text-xs rounded py-1 px-2 -top-8 left-1/2 transform -translate-x-1/2 whitespace-nowrap opacity-0 group-hover:opacity-100 transition-opacity duration-200">
                                                          Anotarme como Tanque
                                                          <div class="absolute w-2 h-2 bg-gray-800 transform rotate-45 -bottom-1 left-1/2 -ml-1" />
                                                        </div>
                                                      </div>

                                                      {/* Healer Button */}
                                                      <div class="relative group">
                                                        <button
                                                          type="button"
                                                          class="flex flex-col items-center justify-center p-1.5 rounded bg-green-900/20 hover:bg-green-900/40 border border-green-700/30 hover:border-green-500/50 transition-all w-full"
                                                          data-raid-name={raid.name}
                                                          data-raid-id={raid.id}
                                                          data-day={schedule.day_of_week}
                                                          data-time={schedule.start_time}
                                                          data-role="healer"
                                                          onclick="openRegistrationModal(this)"
                                                        >
                                                          <div class="w-1.5 h-1.5 rounded-full bg-green-500 mb-1 group-hover:scale-125 transition-transform" />
                                                          <span class="text-[10px] text-green-300 font-medium">
                                                            Healer
                                                          </span>
                                                          <span class="text-[10px] text-gray-400">
                                                            {roleCounts.healer}
                                                          </span>
                                                        </button>
                                                        <div class="absolute z-10 invisible group-hover:visible bg-gray-800 text-white text-xs rounded py-1 px-2 -top-8 left-1/2 transform -translate-x-1/2 whitespace-nowrap opacity-0 group-hover:opacity-100 transition-opacity duration-200">
                                                          Anotarme como Sanador
                                                          <div class="absolute w-2 h-2 bg-gray-800 transform rotate-45 -bottom-1 left-1/2 -ml-1" />
                                                        </div>
                                                      </div>

                                                      {/* Melee Button */}
                                                      <div class="relative group">
                                                        <button
                                                          type="button"
                                                          class="flex flex-col items-center justify-center p-1.5 rounded bg-red-900/20 hover:bg-red-900/40 border border-red-700/30 hover:border-red-500/50 transition-all w-full"
                                                          data-raid-name={raid.name}
                                                          data-raid-id={raid.id}
                                                          data-day={schedule.day_of_week}
                                                          data-time={schedule.start_time}
                                                          data-role="melee"
                                                          onclick="openRegistrationModal(this)"
                                                        >
                                                          <div class="w-1.5 h-1.5 rounded-full bg-red-500 mb-1 group-hover:scale-125 transition-transform" />
                                                          <span class="text-[10px] text-red-300 font-medium">
                                                            Melee
                                                          </span>
                                                          <span class="text-[10px] text-gray-400">
                                                            {roleCounts.melee}
                                                          </span>
                                                        </button>
                                                        <div class="absolute z-10 invisible group-hover:visible bg-gray-800 text-white text-xs rounded py-1 px-2 -top-8 left-1/2 transform -translate-x-1/2 whitespace-nowrap opacity-0 group-hover:opacity-100 transition-opacity duration-200">
                                                          Anotarme como Cuerpo a Cuerpo
                                                          <div class="absolute w-2 h-2 bg-gray-800 transform rotate-45 -bottom-1 left-1/2 -ml-1" />
                                                        </div>
                                                      </div>

                                                      {/* Ranged Button */}
                                                      <div class="relative group">
                                                        <button
                                                          type="button"
                                                          class="flex flex-col items-center justify-center p-1.5 rounded bg-purple-900/20 hover:bg-purple-900/40 border border-purple-700/30 hover:border-purple-500/50 transition-all w-full"
                                                          data-raid-name={raid.name}
                                                          data-raid-id={raid.id}
                                                          data-day={schedule.day_of_week}
                                                          data-time={schedule.start_time}
                                                          data-role="ranged"
                                                          onclick="openRegistrationModal(this)"
                                                        >
                                                          <div class="w-1.5 h-1.5 rounded-full bg-purple-500 mb-1 group-hover:scale-125 transition-transform" />
                                                          <span class="text-[10px] text-purple-300 font-medium">
                                                            Ranged
                                                          </span>
                                                          <span class="text-[10px] text-gray-400">
                                                            {roleCounts.ranged}
                                                          </span>
                                                        </button>
                                                        <div class="absolute z-10 invisible group-hover:visible bg-gray-800 text-white text-xs rounded py-1 px-2 -top-8 left-1/2 transform -translate-x-1/2 whitespace-nowrap opacity-0 group-hover:opacity-100 transition-opacity duration-200">
                                                          Anotarme como A Distancia
                                                          <div class="absolute w-2 h-2 bg-gray-800 transform rotate-45 -bottom-1 left-1/2 -ml-1" />
                                                        </div>
                                                      </div>
                                                    </div>
                                                  </div>
                                                </div>
                                              );
                                            })}
                                          </div>
                                        </div>
                                      );
                                    });
                                  })()}
                                </div>
                              </div>

                              {/* Action button */}
                            </div>
                          </div>
                        </div>
                      );
                    })
                }
              </div>
              <!-- Navigation Buttons -->
              <button class="slider-nav prev" id="slider-prev" aria-label="Anterior">
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  width="24"
                  height="24"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                >
                  <path d="M15 18l-6-6 6-6"></path>
                </svg>
              </button>
              <button class="slider-nav next" id="slider-next" aria-label="Siguiente">
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  width="24"
                  height="24"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                >
                  <path d="M9 18l6-6-6-6"></path>
                </svg>
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Roster Eligible Modal -->
  <div
    id="roster-modal"
    class="fixed inset-0 z-50 hidden overflow-y-auto"
    aria-labelledby="modal-title"
    role="dialog"
    aria-modal="true"
  >
    <div
      class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0"
    >
      <div
        class="fixed inset-0 bg-gray-900 bg-opacity-75 transition-opacity backdrop-blur-sm"
        aria-hidden="true"
        onclick="closeRosterModal()"
      >
      </div>

      <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true"
        >&#8203;</span
      >

      <div
        class="inline-block align-bottom bg-gray-900 rounded-md text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-2xl sm:w-full border border-gray-700"
      >
        <div class="bg-gray-800 px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
          <div class="sm:flex sm:items-start">
            <div class="mt-3 text-center sm:mt-0 sm:ml-4 sm:text-left w-full">
              <h3
                class="text-lg leading-6 font-medium text-white flex items-center justify-between border-b border-gray-700 pb-3 mb-4"
                id="modal-title"
              >
                <span id="roster-modal-raid-name">Miembros Elegibles</span>
                <button
                  type="button"
                  class="text-gray-400 hover:text-white focus:outline-none"
                  onclick="closeRosterModal()"
                >
                  <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M6 18L18 6M6 6l12 12"></path>
                  </svg>
                </button>
              </h3>

              <div
                id="roster-modal-content"
                class="mt-2 max-h-[60vh] overflow-y-auto pr-2 custom-scrollbar"
              >
                <!-- Content injected by JS -->
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  {/* Registration Modal */}
  <div
    id="register-modal"
    class="fixed inset-0 z-50 hidden overflow-y-auto"
    aria-labelledby="modal-title"
    role="dialog"
    aria-modal="true"
  >
    <div
      class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0"
    >
      <div
        class="fixed inset-0 bg-gray-900/80 backdrop-blur-sm transition-opacity"
        aria-hidden="true"
        onclick="closeRegistrationModal()"
      >
      </div>

      <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true"
        >&#8203;</span
      >

      <div
        class="inline-block align-bottom bg-gray-800 rounded-md text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg w-full border border-gray-700"
      >
        <div class="bg-gray-800 px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
          <div class="sm:flex sm:items-start">
            <div class="mt-3 text-center sm:mt-0 sm:ml-4 sm:text-left w-full">
              <h3 class="text-lg leading-6 font-medium text-white" id="modal-title">
                Unirse a Core
              </h3>
              <div class="mt-2">
                <p class="text-sm text-gray-400 mb-4">
                  Inscribiéndote para: <span id="modal-raid-name" class="text-amber-400 font-bold"
                  ></span>
                  <br />
                  <span id="modal-schedule-info" class="text-gray-300"></span>
                  <br />
                  Rol seleccionado: <span
                    id="modal-role-display"
                    class="capitalize font-bold text-white"></span>
                </p>

                <form id="registration-form" class="space-y-4">
                  <input type="hidden" name="raid_id" id="modal-raid-id" />
                  <input type="hidden" name="day_of_week" id="modal-day" />
                  <input type="hidden" name="start_time" id="modal-time" />
                  <input type="hidden" name="player_role" id="modal-player-role" />

                  <div
                    id="form-errors"
                    class="hidden bg-red-900/50 border border-red-700 text-red-200 p-3 rounded text-sm mb-4"
                  >
                    <p id="error-message"></p>
                  </div>

                  <div>
                    <label for="player-name" class="block text-sm font-medium text-gray-300 mb-1">
                      Nombre del Personaje
                    </label>
                    <input
                      type="text"
                      id="player-name"
                      name="player_name"
                      required
                      class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-md text-white focus:outline-none focus:ring-2 focus:ring-amber-500 focus:border-transparent"
                      placeholder="Nombre exacto en el juego"
                    />
                  </div>

                  <div>
                    <label for="player-class" class="block text-sm font-medium text-gray-300 mb-1">
                      Clase
                    </label>
                    <select
                      id="player-class"
                      name="player_class"
                      required
                      class="w-full bg-gray-700 border border-gray-600 rounded-md px-3 py-2 text-white focus:ring-2 focus:ring-amber-500 focus:border-transparent"
                    >
                      <option value="" disabled selected>Selecciona tu clase</option>
                      <option value="death-knight">Caballero de la Muerte</option>
                      <option value="druid">Druida</option>
                      <option value="hunter">Cazador</option>
                      <option value="mage">Mago</option>
                      <option value="paladin">Paladín</option>
                      <option value="priest">Sacerdote</option>
                      <option value="rogue">Pícaro</option>
                      <option value="shaman">Chamán</option>
                      <option value="warlock">Brujo</option>
                      <option value="warrior">Guerrero</option>
                    </select>
                  </div>

                  <div class="mt-5 sm:mt-4 sm:flex sm:flex-row-reverse">
                    <button
                      type="submit"
                      class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-amber-600 text-base font-medium text-white hover:bg-amber-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-amber-500 sm:ml-3 sm:w-auto sm:text-sm"
                    >
                      Confirmar
                    </button>
                    <button
                      type="button"
                      onclick="closeRegistrationModal()"
                      class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-600 shadow-sm px-4 py-2 bg-gray-700 text-base font-medium text-gray-300 hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500 sm:mt-0 sm:w-auto sm:text-sm"
                    >
                      Cancelar
                    </button>
                  </div>
                </form>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  {/* Weekly Schedule Section */}
  <div class="max-w-7xl mx-auto py-8">
    <!-- Título de la sección -->
    <div
      id="reglas-hermandad"
      class="flex flex-col md:flex-row md:justify-between md:items-end gap-4 px-2 mb-6 mt-20"
    >
      <div class="flex items-center space-x-4">
        <div
          class="w-12 h-12 bg-gradient-to-br from-amber-600 to-amber-800 rounded-xl flex items-center justify-center shadow-lg shadow-amber-900/20 transform -rotate-2 hover:rotate-0 transition-transform duration-300"
        >
          <svg fill="#000000" viewBox="0 0 32 32" version="1.1" xmlns="http://www.w3.org/2000/svg"><g id="SVGRepo_bgCarrier" stroke-width="0"></g><g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"></g><g id="SVGRepo_iconCarrier"> <title>bell</title> <path d="M26.654 1.125h-2.624l0.264 2.359h-16.413l0.264-2.353h-2.624l-4.847 21.61v7.981h4.154l2.861-25.53h8.037v2.519c-0.463 0.151-0.798 0.585-0.798 1.098 0 0.049 0.003 0.097 0.009 0.144-2.29 0.546-3.275 2.804-4.471 7.269l0 0c-1.17 4.368-3.021 3.948-3.021 6.823 0 1.557 3.43 2.545 7.451 2.718-0.053 0.153-0.083 0.318-0.083 0.489 0 0.818 0.664 1.481 1.482 1.482s1.481-0.663 1.481-1.481c0-0.176-0.031-0.344-0.087-0.5 3.916-0.201 7.208-1.178 7.208-2.705-0-2.875-1.852-2.455-3.023-6.824-1.227-4.574-2.231-6.832-4.642-7.307 0.003-0.036 0.005-0.072 0.005-0.108 0-0.483-0.297-0.896-0.717-1.069v-2.548h7.963l2.861 25.524h4.154v-7.981l-4.847-21.61z"></path> </g></svg>
        </div>
        <div>
          <span class="text-sm md:text-3xl font-black text-white uppercase tracking-tighter italic">
            Horarios de <span
              class="text-transparent bg-clip-text bg-gradient-to-r from-amber-200 via-amber-400 to-amber-200 pr-1"
              >Core</span
            >
          </span>
          <span
            class="text-amber-300/60 font-medium tracking-widest uppercase text-[10px] flex items-center space-x-1"
          >
            <span class="self-end">Temporada {new Date().toLocaleDateString('es-ES', { month: 'long', year: 'numeric' })}  </span>
          </span>
        </div>
      </div>
    </div>
    
    <div class="mt-8 flex justify-end opacity-40 hover:opacity-100 transition-opacity duration-500">
          <a href="https://paypal.me/iamdev88" target="_blank" rel="noopener noreferrer" class="group flex items-center gap-2 px-3 py-1.5 rounded-full bg-gray-900/30 hover:bg-amber-900/20 border border-transparent hover:border-amber-600/30 transition-all duration-300" title="Apoya el desarrollo">
            <span class="text-[10px] uppercase tracking-wider text-gray-500 group-hover:text-amber-400/80 font-medium transition-colors">Invítame a un café</span>
            <svg class="w-3 h-3 text-gray-600 group-hover:text-amber-500 transition-colors" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"></path>
            </svg>
          </a>
        </div>

    <div
      class="bg-gradient-to-br from-amber-900/20 via-gray-900/40 to-amber-800/10 backdrop-blur-sm border border-amber-600/30 rounded-md p-4 shadow-2xl hover:border-amber-500/60 transition-all duration-300 hover:shadow-lg hover:shadow-amber-500/10"
    >

      <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 lg:grid-cols-7 gap-3">
        {
          ['Lunes', 'Martes', 'Miércoles', 'Jueves', 'Viernes', 'Sábado', 'Domingo'].map((day) => {
            // Normalize day for comparison
            const normalizeDay = (d) =>
              d
                .toLowerCase()
                .normalize('NFD')
                .replace(/[\u0300-\u036f]/g, '');

            const targetDay = normalizeDay(day);

            const daySchedules = raidSchedules
              .filter((s) => normalizeDay(s.day_of_week) === targetDay)
              .filter((s) => {
                // Only show schedules that have at least one raid leader
                return s.players.some(p => p.raid_role === 'lider' && (p.is_guild_member || p.from_supabase));
              })
              .sort((a, b) => {
                // Extract time part (remove 'ST' if present)
                const timeA = (a.start_time || '').replace(' ST', '');
                const timeB = (b.start_time || '').replace(' ST', '');

                // Handle '00:00' to appear last
                if (timeA === '00:00' && timeB !== '00:00') return 1;
                if (timeA !== '00:00' && timeB === '00:00') return -1;

                // For other times, do normal time comparison
                return timeA.localeCompare(timeB);
              });

            // Only show the day if there are schedules for it
            if (daySchedules.length === 0) return null;

            return (
              <div class="bg-gradient-to-br from-gray-900/80 to-gray-800/60 backdrop-blur-sm border border-blue-600/40 rounded-md hover:border-blue-500/60 transition-all duration-300 hover:shadow-lg hover:shadow-blue-500/10 overflow-hidden">
                <div class="bg-gray-800/80 p-2 text-center border-b border-gray-700/50">
                  <h3 class="font-bold text-gray-200 text-sm">{day}</h3>
                </div>
                <div class="p-2 space-y-2 flex-grow min-h-[100px]">
                  {daySchedules.length > 0 ? (
                    daySchedules.map((schedule) => {
                      // Get raid leaders from roster only
                      const raidLeadersFromRoster = schedule.players.filter(p => 
                        p.raid_role === 'lider' && p.is_guild_member
                      );
                      
                      return (
                      <div class="group relative bg-gray-900/60 hover:bg-gray-800 p-3 rounded border-l-2 border-amber-500 transition-all duration-200 cursor-default shadow-sm hover:shadow-md">
                        <div class="flex flex-col justify-between items-center mb-2">
                          <span class="text-xs font-bold text-amber-400 flex items-center">
                            <svg class="w-3 h-3 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                            {schedule.start_time} hora server
                          </span>
                          <span class="text-xs text-red-400 font-bold whitespace-nowrap bg-red-900/20 px-2 py-0.5 rounded-full">
                            {allAvailableRaids.find((r) => r.id === schedule.raid_id)?.minGearScore} GS
                          </span>
                        </div>
                        <div class="mb-2">
                          <span class="text-sm text-white font-semibold leading-tight whitespace-normal break-words">
                            {schedule.raid_name}
                          </span>
                        </div>
                        {raidLeadersFromRoster.length > 0 && (
                          <div class="mt-1 flex flex-wrap items-center gap-2">
                            <span class="text-[10px] text-gray-400">Líder{raidLeadersFromRoster.length > 1 ? 'es' : ''}:</span>
                            {raidLeadersFromRoster.map((leader, index) => (
                              <button
                                key={index}
                                onclick={`openRaidLeadersModal([{name: '${leader.name}', is_leader: true, is_guild_member: true, class: '${leader.class}', role: '${leader.role}'}], '${schedule.raid_name}', '${schedule.start_time}')`}
                                class="flex items-center text-[10px] text-amber-400 hover:text-amber-300 transition-colors bg-amber-900/20 px-2 py-0.5 rounded-full hover:bg-amber-800/30"
                              >
                                <svg
                                  class="w-2.5 h-2.5 mr-1"
                                  fill="none"
                                  viewBox="0 0 24 24"
                                  stroke="currentColor"
                                >
                                  <path
                                    stroke-linecap="round"
                                    stroke-linejoin="round"
                                    stroke-width="2"
                                    d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z"
                                  />
                                </svg>
                                {leader.name}
                              </button>
                            ))}
                          </div>
                        )}
                        <div class="mt-2 pt-2 border-t border-gray-700/50 flex justify-between items-center text-[10px]">
                          <span class="text-gray-500">
                            {(() => {
                              const validPlayersCount = schedule.players.filter(p => 
                                (['aceptado', 'accepted', 'confirmed'].includes(p.status) || 
                                 ['aceptado', 'accepted', 'confirmed'].includes(p.raid_status) || 
                                 ['aceptado', 'accepted', 'confirmed'].includes(p.registration_status) || 
                                 schedule.is_official_core) && 
                                (p.is_guild_member || p.from_supabase)
                              ).length;
                              return `${validPlayersCount} jugador${validPlayersCount !== 1 ? 'es' : ''}`;
                            })()}
                          </span>
                        </div>
                      </div>
                    );
                    })
                  ) : (
                    <div class="h-full flex items-center justify-center">
                      <span class="text-xs text-gray-600 italic">-</span>
                    </div>
                  )}
                </div>
              </div>
            );
          })
        }
      </div>
      <div class="mt-8 flex justify-end opacity-40 hover:opacity-100 transition-opacity duration-500">
      <a href="https://paypal.me/iamdev88" target="_blank" rel="noopener noreferrer" class="group flex items-center gap-2 px-3 py-1.5 rounded-full bg-gray-900/30 hover:bg-amber-900/20 border border-transparent hover:border-amber-600/30 transition-all duration-300" title="Apoya el desarrollo">
        <span class="text-[10px] uppercase tracking-wider text-gray-500 group-hover:text-amber-400/80 font-medium transition-colors">Invítame a un café</span>
        <svg class="w-3 h-3 text-gray-600 group-hover:text-amber-500 transition-colors" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"></path>
        </svg>
      </a>
    </div>
    </div>
    
  </div>

  {/* Raid Rules Section */}
  <div class="max-w-7xl mx-auto mt-20">
    <!-- Título de la sección -->
    <div
      id="reglas-hermandad"
      class="flex flex-col md:flex-row md:justify-between md:items-end gap-4 px-2 mb-6"
    >
      <div class="flex items-center space-x-4">
        <div
          class="w-12 h-12 bg-gradient-to-br from-amber-600 to-amber-800 rounded-xl flex items-center justify-center shadow-lg shadow-amber-900/20 transform -rotate-2 hover:rotate-0 transition-transform duration-300"
        >
          <svg fill="#000000" viewBox="0 0 32 32" version="1.1" xmlns="http://www.w3.org/2000/svg" data-astro-source-file="C:/Users/Usuario/Desktop/_DEV/GUILD-PORTAL/src/pages/roster.astro" data-astro-source-loc="204:15"><g id="SVGRepo_bgCarrier" stroke-width="0" data-astro-source-file="C:/Users/Usuario/Desktop/_DEV/GUILD-PORTAL/src/pages/roster.astro" data-astro-source-loc="204:15"></g><g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round" data-astro-source-file="C:/Users/Usuario/Desktop/_DEV/GUILD-PORTAL/src/pages/roster.astro" data-astro-source-loc="204:62"></g><g id="SVGRepo_iconCarrier" data-astro-source-file="C:/Users/Usuario/Desktop/_DEV/GUILD-PORTAL/src/pages/roster.astro" data-astro-source-loc="207:71"> <title>scroll-unfurled</title> <path d="M26.693 23.878h-4.43l-0.042-0.076c0.016-2.709 1.069-5.48 3.069-7.666 1.495-1.633 2.623-3.783 3.202-5.918l-2.573-1.556 2.388-0.431-2.706-1.61 3.253-0.552c-0.326-2.442-1.8-4.25-4.828-4.25-2.955 0.574-11.374 0.749-15.729 0.185-0.552-0.18-1.108-0.285-1.651-0.304-0.004-0.001-0.008-0.002-0.012-0.003 0.002 0.001 0.005 0.002 0.007 0.003-1.416-0.047-2.738 0.501-3.647 1.882-1.263 1.919 0.082 5.213 3.046 5.213 0.167 0 0.32-0.009 0.46-0.026v0.023h3.702c-0.56 2.257-1.949 4.767-3.557 7.296-0.135 0.212-0.266 0.429-0.393 0.649l2.177 2.23-3.511 0.588c-2.042 5.364-1.711 11.361 3.013 11.361v-0l0.489 0.003v0.007h5.349v-0.010h14.097c4.25 0 4.833-7.039-1.171-7.039zM14.134 27.263c-0-0.029-0.001-0.059-0.002-0.089 0.001 0.030 0.002 0.059 0.002 0.089zM13.997 26.144c0.001 0.004 0.001 0.007 0.002 0.011-0.001-0.004-0.001-0.007-0.002-0.011-0.168-0.741-0.649-1.358-1.278-1.755h0c0.629 0.398 1.11 1.015 1.278 1.755zM14.128 27.071c-0.001-0.030-0.003-0.060-0.005-0.090 0.002 0.030 0.004 0.060 0.005 0.090zM14.114 26.871c-0.003-0.030-0.006-0.060-0.009-0.090 0.003 0.030 0.006 0.060 0.009 0.090zM14.090 26.662c-0.004-0.029-0.008-0.058-0.012-0.087 0.005 0.029 0.008 0.058 0.012 0.087zM14.055 26.439c-0.005-0.025-0.008-0.050-0.013-0.076 0.005 0.026 0.009 0.051 0.013 0.076zM7.393 8.433c0.876-0.746-0.036-2.509-1.085-3.976h3.617c0.605 1.167 0.667 2.514 0.358 3.976h-2.89zM10.181 24.754c1.618-0.538 3.452 0.49 3.816 2.094 0.062 0.274 0.102 0.533 0.122 0.778 0.002-0.026 0.004-0.052 0.005-0.078-0.040 0.579-0.212 1.061-0.488 1.459h-0.032c-0.031 0.044-0.063 0.087-0.096 0.128l0.050-0.022c-0.463 0.605-1.173 1.009-2.018 1.27h-0.878l0.043-0.019c-0.925-0-1.988-0.087-1.988-0.087 1.373-0.022 1.964-0.603 2.19-1.269-0.978 0.355-2.020-0.284-2.348-1.227-0.443-1.273 0.391-2.618 1.622-3.027zM14.132 27.362c-0.001 0.029-0.001 0.058-0.002 0.086 0.001-0.028 0.001-0.057 0.002-0.086zM13.563 29.108c0.025-0.033 0.049-0.066 0.073-0.099-0.023 0.034-0.048 0.067-0.073 0.099z" data-astro-source-file="C:/Users/Usuario/Desktop/_DEV/GUILD-PORTAL/src/pages/roster.astro" data-astro-source-loc="209:16"></path> </g></svg>
        </div>
        <div>
          <span class="text-sm md:text-3xl font-black text-white uppercase tracking-tighter italic">
            Reglas de <span
              class="text-transparent bg-clip-text bg-gradient-to-r from-amber-200 via-amber-400 to-amber-200 pr-1"
              >Raid</span
            >
          </span>
          <span
            class="text-amber-300/60 font-medium tracking-widest uppercase text-[10px] flex items-center space-x-1"
          >
                        <span class="self-end"> Código de conducta y normas </span>

          </span>
        </div>
      </div>
    </div>
    <div
      class="bg-gradient-to-br from-amber-900/20 via-gray-900/40 to-amber-800/10 backdrop-blur-sm border border-amber-600/30 rounded-2xl p-4 shadow-2xl hover:border-amber-500/60 transition-all duration-300 hover:shadow-lg hover:shadow-amber-500/10"
    >
      <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between mb-6 gap-4">
        <div class="flex items-center space-x-4">
          <a
            href="https://discord.gg/BwdpNV9sky"
            target="_blank"
            rel="noopener noreferrer"
            class="flex items-center text-white bg-indigo-600 hover:bg-indigo-700 px-3 py-1.5 rounded-md text-sm font-medium transition-colors"
          >
            <svg class="w-5 h-5 mr-1.5" fill="currentColor" viewBox="0 0 24 24">
              <path
                d="M20.317 4.37a19.791 19.791 0 00-4.885-1.515.074.074 0 00-.079.037c-.21.375-.444.864-.608 1.25a18.27 18.27 0 00-5.487 0 12.64 12.64 0 00-.617-1.25.077.077 0 00-.079-.037A19.736 19.736 0 003.677 4.37a.07.07 0 00-.032.027C.533 9.046-.32 13.58.099 18.057a.082.082 0 00.031.057 19.9 19.9 0 005.993 3.03.078.078 0 00.084-.028c.462-.63.874-1.295 1.226-1.994a.076.076 0 00-.041-.1 13.107 13.107 0 01-1.872-.892.077.077 0 01-.008-.128 10.2 10.2 0 00.372-.292.074.074 0 01.077-.01c3.928 1.8 8.18 1.8 12.062 0a.074.074 0 01.078.01c.12.098.246.198.373.292a.077.077 0 01-.006.127 12.299 12.299 0 01-1.873.891.077.077 0 00-.041.1c.36.698.772 1.362 1.225 1.993a.076.076 0 00.084.028 19.84 19.84 0 005.99-3.03.077.077 0 00.032-.054c.5-5.177-.838-9.674-3.549-13.66a.061.061 0 00-.031-.03zM8.02 15.33c-1.183 0-2.157-1.085-2.157-2.419 0-1.333.946-2.419 2.157-2.419 1.21 0 2.175 1.096 2.157 2.42 0 1.333-.946 2.418-2.157 2.418zm7.975 0c-1.183 0-2.157-1.085-2.157-2.419 0-1.333.953-2.419 2.157-2.419 1.21 0 2.175 1.096 2.157 2.42 0 1.333-.946 2.418-2.157 2.418z"
              ></path>
            </svg>
            Discord
          </a>
          <a
            href="https://chat.whatsapp.com/BahYOaTMZfHIwYQGey3G91"
            target="_blank"
            rel="noopener noreferrer"
            class="flex items-center text-white bg-green-600 hover:bg-green-700 px-3 py-1.5 rounded-md text-sm font-medium transition-colors"
          >
            <svg class="w-5 h-5 mr-1.5" fill="currentColor" viewBox="0 0 24 24">
              <path
                d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.966-.273-.099-.471-.148-.67.15-.197.297-.767.963-.94 1.16-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.795-1.484-1.781-1.66-2.075-.173-.297-.018-.458.13-.606.136-.135.298-.354.446-.531.149-.174.198-.298.298-.497.099-.198.05-.367-.025-.531-.075-.174-.669-1.612-.916-2.207-.242-.579-.487-.5-.67-.508-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.79.359-.272.3-1.04 1.016-1.04 2.477s1.065 2.873 1.213 3.074c.149.198 2.096 3.2 5.076 4.49.703.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.005-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.03-1.38l-.36-.214-3.741.982.998-3.648-.235-.372a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.29A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.549 4.142 1.595 5.945L0 24l6.335-1.652a11.882 11.882 0 005.723 1.464h.006c6.553 0 11.89-5.336 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"
              ></path>
            </svg>
            WhatsApp
          </a>
        </div>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        {/* Normas de Conducta */}
        <div
          class="bg-gradient-to-br from-gray-900/80 to-gray-800/60 backdrop-blur-sm border border-purple-600/40 rounded-md hover:border-purple-500/60 transition-all duration-300 hover:shadow-lg hover:shadow-purple-500/10 overflow-hidden p-4"
        >
          <h3 class="text-lg font-semibold text-white mb-3 flex items-center">
            <svg
              class="w-5 h-5 text-red-400 mr-2"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"
              ></path>
            </svg>
            Normas de Conducta
          </h3>
          <ul class="space-y-2 text-gray-300">
            <li class="flex items-start">
              <span class="text-red-400 mr-2">•</span>
              <span>AFK/OFF sin avisar = Sin botín/Expulsión</span>
            </li>
            <li class="flex items-start">
              <span class="text-red-400 mr-2">•</span>
              <span>No respetar pulls/mecánicas = Sin botín/Expulsión</span>
            </li>
            <li class="flex items-start">
              <span class="text-red-400 mr-2">•</span>
              <span>DPS/Healer/Tank con bajo rendimiento = Expulsión</span>
            </li>
            <li class="flex items-start">
              <span class="text-red-400 mr-2">•</span>
              <span>PVP no permitido = Expulsión</span>
            </li>
          </ul>
        </div>

        {/* Sistema de Botín */}
        <div
          class="bg-gradient-to-br from-gray-900/80 to-gray-800/60 backdrop-blur-sm border border-purple-600/40 rounded-md hover:border-purple-500/60 transition-all duration-300 hover:shadow-lg hover:shadow-purple-500/10 overflow-hidden p-4"
        >
          <h3 class="text-lg font-semibold text-white mb-3 flex items-center">
            <svg
              class="w-5 h-5 text-amber-400 mr-2"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
              ></path>
            </svg>
            Sistema de Botín
          </h3>
          <ul class="space-y-2 text-gray-300">
            <li class="flex items-start">
              <span class="text-amber-400 mr-2">•</span>
              <span>No Discord = No botín</span>
            </li>
            <li class="flex items-start">
              <span class="text-amber-400 mr-2">•</span>
              <span>Desconexión = Sin botín</span>
            </li>
            <li class="flex items-start">
              <span class="text-amber-400 mr-2">•</span>
              <span>Se rollea 20 minutos antes del ligado del ítem</span>
            </li>
            <li class="flex items-start">
              <span class="text-amber-400 mr-2">•</span>
              <span>Al dar Raid Off se cierran los rolls en el orden de obtención</span>
            </li>
          </ul>
        </div>

        {/* Requisitos Generales */}
        <div
          class="md:col-span-2 bg-gradient-to-br from-gray-900/80 to-gray-800/60 backdrop-blur-sm border border-blue-600/40 rounded-md hover:border-blue-500/60 transition-all duration-300 hover:shadow-lg hover:shadow-blue-500/10 overflow-hidden p-4"
        >
          <h3 class="text-lg font-semibold text-white mb-3 flex items-center">
            <svg
              class="w-5 h-5 text-blue-400 mr-2"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"
              ></path>
            </svg>
            Requisitos Generales
          </h3>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <h4 class="font-medium text-blue-300 mb-2">Asistencia</h4>
              <ul class="space-y-1 text-gray-300">
                <li class="flex items-start">
                  <span class="text-blue-400 mr-2">•</span>
                  <span>Puntualidad requerida</span>
                </li>
                <li class="flex items-start">
                  <span class="text-blue-400 mr-2">•</span>
                  <span>Avisar con anticipación si no podrás asistir</span>
                </li>
              </ul>
            </div>
            <div>
              <h4 class="font-medium text-blue-300 mb-2">Equipamiento</h4>
              <ul class="space-y-1 text-gray-300">
                <li class="flex items-start">
                  <span class="text-blue-400 mr-2">•</span>
                  <span>Consumibles necesarios</span>
                </li>
                <li class="flex items-start">
                  <span class="text-blue-400 mr-2">•</span>
                  <span>Encantamientos y gemas al día</span>
                </li>
              </ul>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <Fragment slot="modals">
    <RaidRulesModal />

<!-- Raid Leaders Modal -->
<div
  id="raid-leaders-modal"
  class="fixed inset-0 bg-black/70 flex items-center justify-center z-50 p-4 hidden"
>
  <div
    class="bg-gray-800 rounded-md w-full max-w-2xl border border-amber-600/50 overflow-hidden shadow-xl"
  >
    <div class="p-2 md:p-4 border-b border-amber-600/30 bg-gray-900/50">
      <div class="flex items-center justify-between">
        <h3 class="text-lg md:text-xl font-bold text-amber-400">
          <svg
            class="w-4 h-4 md:w-5 md:h-5 inline-block mr-2 -mt-1"
            fill="none"
            viewBox="0 0 24 24"
            stroke="currentColor"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z"
            ></path>
          </svg>
          Líderes de Raid
        </h3>
        <button id="close-leaders-modal" class="text-gray-400 hover:text-white transition-colors">
          <svg class="w-5 h-5 md:w-6 md:h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M6 18L18 6M6 6l12 12"></path>
          </svg>
        </button>
      </div>
    </div>

    <div class="flex flex-col md:flex-row max-h-[85vh] md:max-h-[70vh]">
      <div id="raid-leaders-list" class="flex-1 overflow-y-auto p-2 md:p-4 custom-scrollbar flex flex-col gap-1.5 md:gap-2">
        <!-- Raid leaders will be listed here by JavaScript -->
      </div>
      
      <!-- Summary Sidebar -->
      <div id="raid-leaders-summary" class="w-full md:w-24 bg-gray-900/40 border-t md:border-t-0 md:border-l border-gray-700/50 p-2 md:p-3 overflow-y-auto custom-scrollbar flex md:flex-col gap-2 md:gap-3 justify-center md:justify-start items-center">
        <!-- Class summary icons will be listed here -->
      </div>
    </div>

    <div class="p-2 md:p-4 border-t border-gray-700/50 bg-gray-900/30 flex items-center justify-between">
      <div id="raid-leaders-legend" class="flex items-center gap-3 md:gap-4">
        <!-- Legend indicators will be injected here -->
      </div>
      <button
        id="close-leaders-modal-btn"
        class="px-3 py-1.5 md:px-4 md:py-2 bg-amber-600 hover:bg-amber-500 text-white rounded-md transition-colors font-medium text-xs md:text-sm"
      >
        Cerrar
      </button>
    </div>
  </div>
</div>

<!-- Regular Players Modal -->
<div
  id="regular-players-modal"
  class="fixed inset-0 bg-black/70 flex items-center justify-center z-50 p-4 hidden"
>
  <div
    class="bg-gray-800 rounded-md w-full max-w-2xl border border-blue-600/50 overflow-hidden shadow-xl"
  >
    <div class="p-2 md:p-4 border-b border-blue-600/30 bg-gray-900/50">
      <div class="flex items-center justify-between">
        <h3 class="text-lg md:text-xl font-bold text-blue-400">
          <svg
            class="w-4 h-4 md:w-5 md:h-5 inline-block mr-2 -mt-1"
            fill="none"
            viewBox="0 0 24 24"
            stroke="currentColor"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"
            ></path>
          </svg>
          Jugadores Regulares
        </h3>
        <button id="close-regulars-modal" class="text-gray-400 hover:text-white transition-colors">
          <svg class="w-5 h-5 md:w-6 md:h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M6 18L18 6M6 6l12 12"></path>
          </svg>
        </button>
      </div>
    </div>

    <div class="flex flex-col md:flex-row max-h-[85vh] md:max-h-[70vh]">
      <div id="regular-players-list" class="flex-1 overflow-y-auto p-2 md:p-4 custom-scrollbar flex flex-col gap-1.5 md:gap-2">
        <!-- Regular players will be listed here by JavaScript -->
      </div>
      
      <!-- Summary Sidebar -->
      <div id="regular-players-summary" class="w-full md:w-24 bg-gray-900/40 border-t md:border-t-0 md:border-l border-gray-700/50 p-2 md:p-3 overflow-y-auto custom-scrollbar flex md:flex-col gap-2 md:gap-3 justify-center md:justify-start items-center">
        <!-- Class summary icons will be listed here -->
      </div>
    </div>

    <div class="p-2 md:p-4 border-t border-gray-700/50 bg-gray-900/30 flex items-center justify-between">
      <div id="regular-players-legend" class="flex items-center gap-3 md:gap-4">
        <!-- Legend indicators will be injected here -->
      </div>
      <button
        id="close-regulars-modal-btn"
        class="px-3 py-1.5 md:px-4 md:py-2 bg-blue-600 hover:bg-blue-500 text-white rounded-md transition-colors font-medium text-xs md:text-sm"
      >
        Cerrar
      </button>
    </div>
  </div>
</div>
  </Fragment>
</Layout>
<script is:inline>
  // Raid Leaders and Regular Players Modal Functions
  document.addEventListener('DOMContentLoaded', function () {
    // Setup Raid Leaders Modal
    const leadersList = document.getElementById('raid-leaders-list');
    if (leadersList) leadersList.innerHTML = '';

    const leadersModal = document.getElementById('raid-leaders-modal');
    const leadersCloseButtons = [
      document.getElementById('close-leaders-modal'),
      document.getElementById('close-leaders-modal-btn'),
    ];

    leadersModal?.addEventListener('click', function (e) {
      if (e.target === this) leadersModal.classList.add('hidden');
    });

    leadersCloseButtons.forEach((btn) => {
      btn?.addEventListener('click', () => leadersModal?.classList.add('hidden'));
    });

    // Setup Regular Players Modal
    const regularsList = document.getElementById('regular-players-list');
    if (regularsList) regularsList.innerHTML = '';

    const regularsModal = document.getElementById('regular-players-modal');
    const regularsCloseButtons = [
      document.getElementById('close-regulars-modal'),
      document.getElementById('close-regulars-modal-btn'),
    ];

    regularsModal?.addEventListener('click', function (e) {
      if (e.target === this) regularsModal.classList.add('hidden');
    });

    regularsCloseButtons.forEach((btn) => {
      btn?.addEventListener('click', () => regularsModal?.classList.add('hidden'));
    });
  });

  // Shared class colors mapping
  const classColors = {
    warrior: 'bg-orange-900/30 text-orange-300 border-orange-800',
    guerrero: 'bg-orange-900/30 text-orange-300 border-orange-800',
    paladin: 'bg-pink-900/30 text-pink-300 border-pink-800',
    'paladín': 'bg-pink-900/30 text-pink-300 border-pink-800',
    hunter: 'bg-green-900/30 text-green-300 border-green-800',
    cazador: 'bg-green-900/30 text-green-300 border-green-800',
    rogue: 'bg-yellow-900/30 text-yellow-300 border-yellow-800',
    'pícaro': 'bg-yellow-900/30 text-yellow-300 border-yellow-800',
    priest: 'bg-white/30 text-gray-200 border-gray-400',
    sacerdote: 'bg-white/30 text-gray-200 border-gray-400',
    deathknight: 'bg-red-900/30 text-red-300 border-red-800',
    'death-knight': 'bg-red-900/30 text-red-300 border-red-800',
    'caballero de la muerte': 'bg-red-900/30 text-red-300 border-red-800',
    shaman: 'bg-blue-900/30 text-blue-300 border-blue-800',
    'chamán': 'bg-blue-900/30 text-blue-300 border-blue-800',
    mage: 'bg-cyan-900/30 text-cyan-300 border-cyan-800',
    mago: 'bg-cyan-900/30 text-cyan-300 border-cyan-800',
    warlock: 'bg-purple-900/30 text-purple-300 border-purple-800',
    brujo: 'bg-purple-900/30 text-purple-300 border-purple-800',
    druid: 'bg-orange-900/30 text-orange-300 border-orange-800',
    druida: 'bg-orange-900/30 text-orange-300 border-orange-800',
    default: 'bg-gray-700/50 text-gray-300 border-gray-600',
  };

  const classAvatars = {
    warrior: 'class_Guerrero.jpg',
    guerrero: 'class_Guerrero.jpg',
    paladin: 'class_Paladín.jpg',
    'paladín': 'class_Paladín.jpg',
    hunter: 'class_Cazador.jpg',
    cazador: 'class_Cazador.jpg',
    rogue: 'class_Pícaro.jpg',
    'pícaro': 'class_Pícaro.jpg',
    priest: 'class_Sacerdote.jpg',
    sacerdote: 'class_Sacerdote.jpg',
    deathknight: 'class_Caballero de la Muerte.jpg',
    'death-knight': 'class_Caballero de la Muerte.jpg',
    'caballero de la muerte': 'class_Caballero de la Muerte.jpg',
    shaman: 'class_Chamán.jpg',
    'chamán': 'class_Chamán.jpg',
    mage: 'class_Mago.jpg',
    mago: 'class_Mago.jpg',
    warlock: 'class_Brujo.jpg',
    brujo: 'class_Brujo.jpg',
    druid: 'class_Druida.jpg',
    druida: 'class_Druida.jpg',
    default: 'default.png',
  };

  const classDisplayNames = {
    deathknight: 'Caballero de la Muerte',
    druid: 'Druida',
    hunter: 'Cazador',
    mage: 'Mago',
    paladin: 'Paladín',
    priest: 'Sacerdote',
    rogue: 'Pícaro',
    shaman: 'Chamán',
    warlock: 'Brujo',
    warrior: 'Guerrero',
    default: 'Clase'
  };

  // Función para normalizar nombres de clase
  function normalizeClassName(name) {
    if (!name) return 'default';
    const n = String(name).toLowerCase().trim();
    
    if (n.includes('caballero') || n.includes('death') || n.includes('dk')) return 'deathknight';
    if (n.includes('guerrero') || n.includes('warrior')) return 'warrior';
    if (n.includes('palad') || n.includes('paladin')) return 'paladin';
    if (n.includes('cazador') || n.includes('hunter')) return 'hunter';
    if (n.includes('pícaro') || n.includes('picaro') || n.includes('rogue')) return 'rogue';
    if (n.includes('sacerdote') || n.includes('priest')) return 'priest';
    if (n.includes('chamán') || n.includes('chaman') || n.includes('shaman')) return 'shaman';
    if (n.includes('mago') || n.includes('mage')) return 'mage';
    if (n.includes('brujo') || n.includes('warlock')) return 'warlock';
    if (n.includes('druid')) return 'druid';
    
    return n;
  }

  // Role configuration with colors and display names
  const roleConfig = {
    tank: {
      bg: 'bg-blue-900/30',
      text: 'text-blue-300',
      border: 'border-blue-700/50',
      display: 'Tanque',
    },
    healer: {
      bg: 'bg-green-900/30',
      text: 'text-green-300',
      border: 'border-green-700/50',
      display: 'Sanador',
    },
    melee: {
      bg: 'bg-red-900/30',
      text: 'text-red-300',
      border: 'border-red-700/50',
      display: 'Cuerpo a Cuerpo',
    },
    melee_dps: {
      bg: 'bg-red-900/30',
      text: 'text-red-300',
      border: 'border-red-700/50',
      display: 'Cuerpo a Cuerpo',
    },
    ranged: {
      bg: 'bg-purple-900/30',
      text: 'text-purple-300',
      border: 'border-purple-700/50',
      display: 'Distancia',
    },
    ranged_dps: {
      bg: 'bg-purple-900/30',
      text: 'text-purple-300',
      border: 'border-purple-700/50',
      display: 'Distancia',
    },
    default: {
      bg: 'bg-gray-700/30',
      text: 'text-gray-300',
      border: 'border-gray-600/50',
      display: 'Sin rol',
    },
  };

  function createPlayerElement(player, isLeader = false) {
    const name = player?.name ? String(player.name) : 'Desconocido';
    const className = normalizeClassName(player?.class);
    const playerRole =
      player?.player_role && roleConfig[player.player_role] ? player.player_role : 'default';
    const roleInfo = roleConfig[playerRole];

    if (!name || name === 'Desconocido') return null;

    const colorClass = classColors[className] || classColors['default'];
    const avatarFile = classAvatars[className] || classAvatars['default'];
    const avatarPath = `/images/avatars/${avatarFile}`;
    
    // Role Icons
    const roleIcons = {
      tank: `<svg class="w-3.5 h-3.5" fill="currentColor" viewBox="0 0 24 24"><path d="M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4zm0 10.99h7c-.53 4.12-3.28 7.79-7 8.94V12H5V6.3l7-3.11v8.8z"/></svg>`,
      healer: `<svg class="w-3.5 h-3.5" fill="currentColor" viewBox="0 0 24 24"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></svg>`,
      melee: `<svg class="w-3.5 h-3.5" fill="currentColor" viewBox="0 0 24 24"><path d="M19.37 15.83L11.5 8 10 9.5l7.83 7.87-1.42 1.42L8.54 11 7.13 12.41 15 20.28l-1.41 1.41L5.72 13.83l-1.41 1.41L2.89 13.83l1.41-1.41L2.89 11l1.41-1.41L5.72 8.17l1.41 1.41L15 1.72l1.41 1.41-7.87 7.87 1.42 1.42 7.83-7.83 1.42 1.42-7.83 7.83 1.41 1.41 1.41-1.41z"/></svg>`,
      melee_dps: `<svg class="w-3.5 h-3.5" fill="currentColor" viewBox="0 0 24 24"><path d="M19.37 15.83L11.5 8 10 9.5l7.83 7.87-1.42 1.42L8.54 11 7.13 12.41 15 20.28l-1.41 1.41L5.72 13.83l-1.41 1.41L2.89 13.83l1.41-1.41L2.89 11l1.41-1.41L5.72 8.17l1.41 1.41L15 1.72l1.41 1.41-7.87 7.87 1.42 1.42 7.83-7.83 1.42 1.42-7.83 7.83 1.41 1.41 1.41-1.41z"/></svg>`,
      ranged: `<svg class="w-3.5 h-3.5" fill="currentColor" viewBox="0 0 24 24"><path d="M20.47 4.11L19.89 3.53a1.5 1.5 0 0 0-2.12 0L13 8.3L11.59 6.88L13 5.47L11.59 4.05L10.17 5.47L8.76 4.05L4.5 8.31L5.93 9.73L7.34 8.31L8.76 9.73L7.34 11.14L8.76 12.56L13.72 7.59L15.14 9L10.3 13.84a1.5 1.5 0 0 0 0 2.12l.58.58a1.5 1.5 0 0 0 2.12 0L20.47 6.23a1.5 1.5 0 0 0 0-2.12zM5.5 18.5a1 1 0 1 1-2 0 1 1 0 0 1 2 0z"/></svg>`,
      ranged_dps: `<svg class="w-3.5 h-3.5" fill="currentColor" viewBox="0 0 24 24"><path d="M20.47 4.11L19.89 3.53a1.5 1.5 0 0 0-2.12 0L13 8.3L11.59 6.88L13 5.47L11.59 4.05L10.17 5.47L8.76 4.05L4.5 8.31L5.93 9.73L7.34 8.31L8.76 9.73L7.34 11.14L8.76 12.56L13.72 7.59L15.14 9L10.3 13.84a1.5 1.5 0 0 0 0 2.12l.58.58a1.5 1.5 0 0 0 2.12 0L20.47 6.23a1.5 1.5 0 0 0 0-2.12zM5.5 18.5a1 1 0 1 1-2 0 1 1 0 0 1 2 0z"/></svg>`,
      default: `<svg class="w-3.5 h-3.5" fill="currentColor" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z"/></svg>`
    };

    const icon = roleIcons[playerRole] || roleIcons['default'];

    const note = player?.note ? String(player.note) : '';
    const achievements = player?.achievements || 0;
    const raidsCount = player?.raids_count || 0;

    const el = document.createElement('div');
    el.className = `flex items-start gap-1 p-[.05rem] md:p-[.1rem] rounded border transition-all hover:brightness-110 ${colorClass} group relative overflow-hidden`;

    // Iconos de indicadores - combina el parámetro isLeader con la propiedad player.is_leader
    const isLeaderDisplay = isLeader || player.is_leader;
    const isSanctioned = player.is_sanctioned === true || player.guild_leave === true;
    
    const leaderIcon = isLeaderDisplay ? `
      <div class="flex-shrink-0 flex items-center justify-center w-5 h-5 md:w-6 md:h-6 bg-amber-500/10 rounded-full border border-amber-500/30 shadow-[0_0_10px_rgba(251,191,36,0.2)] animate-pulse-slow" title="Líder de Banda">
        <svg class="w-3 h-3 md:w-4 md:h-4 text-amber-400 drop-shadow-[0_0_5px_rgba(251,191,36,0.8)]" fill="currentColor" viewBox="0 0 32 32">
          <path d="M29.273 22.896l1.593 0.252-0.945-1.164 0.012-0.017h-0.026l-13.872-17.076-4.264 3.134-11.224-6.487v2.104l11.552 6.678 3.535-2.587 10.094 12.463-15.852-2.514 0.51-4.446-9.839-5.694v2.196l3.626 2.097 1.388 6.633 1.083-5.204 1.592 0.92-0.62 5.284 0.019 0.003 1.425 7.753 0.667-3.645 1.245 7.298 1.773-10.45 1.347 7.328 1.269-6.937 1.105 2.248 0.998-2.040 1.175 0.186 1.376 8.297 1.3-7.874 0.799 0.126 1.531 3.931 0.922-2.379 1.129 6.14 1.099-6.008 1.047 1.466z"></path>
        </svg>
      </div>
    ` : '';

    const guildIcon = player.is_guild_member && !isSanctioned ? `
      <div class="flex-shrink-0 flex items-center justify-center w-5 h-5 md:w-6 md:h-6 bg-purple-500/10 rounded-full border border-purple-500/30 shadow-[0_0_10px_rgba(168,85,247,0.2)]" title="Miembro de Hermandad">
        <svg class="w-3 h-3 md:w-4 md:h-4 text-purple-400 drop-shadow-[0_0_5px_rgba(168,85,247,0.8)]" fill="currentColor" viewBox="0 0 32 32">
          <path d="M27.745 9.605c-2.737-4.441-7.647-7.397-11.759-8.808-1.394 0.445-2.781 1.056-4.12 1.823l5.301 4.128-1.447 1.463 5.196 3.968-9.746-3.045 1.995-1.925-5.295-1.681c-1.311 1.189-2.512 2.553-3.546 4.078 2.827 7.594 2.827 9.077 0 16.671 7.648 5.84 15.714 6.117 23.422 0-2.313-7.594-2.313-9.076 0-16.671zM23.884 17.982c-1.965-0.982-3.885-1.598-5.787-1.841-0.751 4.757-0.732 9.514 0.155 14.271h-3.73c1.153-4.768 0.981-9.535 0.143-14.303-1.956 0.217-3.908 0.839-5.884 1.873v-4.45c4.971-1.398 10.449-0.936 15.103 0v4.45z"></path>
        </svg>
      </div>
    ` : '';

    const indicators = `
      <div class="absolute right-1 top-1/2 -translate-y-1/2 flex items-center gap-0.5 z-20">
        ${leaderIcon}
        ${guildIcon}
        ${player.is_guild_member === false ? `
          <div class="flex-shrink-0 flex items-center justify-center w-5 h-5 md:w-6 md:h-6 bg-blue-500/10 rounded-full border border-blue-500/30 shadow-[0_0_10px_rgba(59,130,246,0.2)]" title="Posada">
            <svg class="w-3 h-3 md:w-4 md:h-4 text-blue-400 drop-shadow-[0_0_5px_rgba(59,130,246,0.8)]" fill="currentColor" viewBox="0 0 32 32">
              <path d="M15.474 1.384c-1.851 0.24-3.295 2.252-3.295 4.679 0 1.344 0.461 2.545 1.171 3.401-3.849 0.723-4.14 7.203-4.14 11.753h2.669l0.708 9.494h6.781l0.626-9.494h2.533c0-4.562 0.092-11.156-4.112-11.807 0.68-0.852 1.117-2.035 1.117-3.346 0-2.589-1.65-4.679-3.677-4.679-0.127 0-0.258-0.016-0.381 0l0-0zM21.163 1.355c2.027 0 3.681 2.075 3.681 4.665 0 1.311-0.45 2.501-1.13 3.353 4.204 0.651 4.118 7.245 4.118 11.807h-2.514l-0.656 9.511h-3.936l0.619-9.511h2.551c0-4.562 0.086-11.156-4.118-11.807 0.68-0.851 1.13-2.041 1.13-3.353 0-1.662-0.69-3.106-1.713-3.936 0.472-0.389 0.98-0.653 1.567-0.729 0.123-0.016 0.274 0 0.401 0zM12.542 2.084c-1.017 0.838-1.713 2.278-1.713 3.936 0 1.345 0.456 2.57 1.166 3.426-3.849 0.723-4.118 7.185-4.118 11.734h2.66l0.692 9.511h-3.936l-0.692-9.511h-2.697c0-4.549 0.306-11.011 4.154-11.734-0.71-0.856-1.166-2.081-1.166-3.426 0-2.427 1.429-4.424 3.28-4.665 0.123-0.016 0.274 0 0.401 0 0.726 0 1.397 0.266 1.968 0.729z"></path>
            </svg>
          </div>
        ` : ''}
        ${isSanctioned ? `
          <div class="flex-shrink-0 flex items-center justify-center w-5 h-5 md:w-6 md:h-6 bg-red-500/10 rounded-full border border-red-500/30 shadow-[0_0_10px_rgba(239,68,68,0.2)]" title="Sancionado">
            <svg class="w-3 h-3 md:w-4 md:h-4 text-red-400 drop-shadow-[0_0_5px_rgba(239,68,68,0.8)]" fill="currentColor" viewBox="0 0 32 32">
              <path d="M31.155 18.938c0-6.615-2.188-14.287-7.774-17.897l-0-0-1.472 2.277c1.418 0.873 2.163 1.681 2.882 3.109-0.497 0.689-0.87 1.521-1.182 2.46 0.254 0.566 0.438 1.576 0.439 2.245l-2.24-0.366-1.934 2.123-1.555-3.185c-2.045 2.515-2.658 3.571-5.821 3.356l-0.894-2.757-3.188 0.618c0 0-0.581-3.176-1.557-3.887 0.274-1.145 1.090-2.159 2.579-3.071l-1.414-2.619c-5.176 3.629-7.281 10.84-7.281 17.594 5.797 2.916 7.527 6.229 7.205 9.745 0.864 0.487 1.758 0.97 2.806 1.251 1.433 0.384 2.97 0.569 4.55 0.569s3.199-0.184 4.702-0.569c1.361-0.348 2.595-0.892 3.716-1.555-0.050-3.421 1.814-6.8 7.432-9.441zM11.72 20.697c-1.763 1.018-3.823 0.757-4.585-0.563-0.435-0.754-0.341-1.688 0.134-2.547l-0-0c0.801-0.014 1.745-0.175 2.762-0.563 0.969-0.37 1.876-0.877 2.601-1.421 0.374 0.197 0.701 0.493 0.912 0.858 0.762 1.32-0.060 3.218-1.823 4.236zM13.42 27.085c0.616-2.254 1.356-4.509 2.529-6.763 0-0-0-0-0-0h0c0 0-0 0-0 0 1.156 2.254 2.074 4.509 2.529 6.763-1.686-0.514-3.372-0.583-5.058 0zM24.757 20.134c-0.762 1.32-2.822 1.581-4.585 0.563s-2.586-2.916-1.823-4.236c0.211-0.365 0.537-0.661 0.912-0.858 0.724 0.544 1.632 1.051 2.601 1.421 1.017 0.389 1.961 0.549 2.762 0.563l-0 0c0.475 0.859 0.569 1.793 0.134 2.547zM6.584 7.391c0.33-0.871 0.554-1.926 1.621-2.612zM25.137 6.748c-0.363-0.688-0.965-1.891-1.689-2.431z"></path>
            </svg>
          </div>
        ` : ''}
      </div>
    `;

    el.innerHTML = `
      <div class="absolute inset-0 opacity-10 bg-center bg-no-repeat bg-cover pointer-events-none" style="background-image: url('${avatarPath}')"></div>
      <div class="flex-shrink-0 w-7 h-7 md:w-8 md:h-8 rounded border border-white/20 overflow-hidden relative z-10 shadow-sm mr-1">
        <img src="${avatarPath}" alt="${className}" class="w-full h-full object-cover" />
      </div>
      <div class="flex-1 min-w-0 relative z-10 pr-11 md:pr-14">
        <div class="flex items-center justify-between gap-1">
          <div class="flex flex-col min-w-0">
            <div class="flex items-center gap-1 min-w-0">
              <span class="text-[15px] italic pr-1 md:text-sm font-bold  tracking-tight text-white group-hover:text-white/95 leading-tight">
                ${name}
              </span>
            </div>
            ${note ? `<span class="text-[8px] md:text-[9px] text-white/60 truncate italic leading-none mt-0.5 bg-black/20 px-1 rounded-md w-fit">${note}</span>` : ''}
          </div>
        </div>
      </div>
      ${indicators}
    `;
    return el;
  }

  function showNoDataMessage(container, type) {
    if (!container) return;
    const isLeader = type === 'leader';
    const color = isLeader ? 'text-amber-400' : 'text-blue-400';

    container.innerHTML = `
      <div class="text-center py-8 col-span-full">
        <svg class="mx-auto h-14 w-14 text-gray-500 mb-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
        </svg>
        <h3 class="text-lg font-medium text-gray-200">Sin ${isLeader ? 'líderes' : 'jugadores'}</h3>
        <p class="mt-1 text-sm text-gray-400">No hay ${isLeader ? 'líderes asignados' : 'jugadores regulares'} en este horario.</p>
      </div>
    `;
  }

  function updateSummarySidebar(container, players) {
    if (!container) return;
    
    // Initialize all class counts to 0
    const allClasses = [
      'deathknight', 'druid', 'hunter', 'mage', 'paladin',
      'priest', 'rogue', 'shaman', 'warlock', 'warrior'
    ];
    
    const classCounts = {};
    allClasses.forEach(className => {
      classCounts[className] = 0;
    });
    
    // Count actual players
    players.forEach(player => {
      if (player.class) {
        const className = normalizeClassName(player.class);
        if (classCounts.hasOwnProperty(className)) {
          classCounts[className]++;
        }
      }
    });
    
    // Sort by class name for consistent order
    const sortedClasses = Object.entries(classCounts).sort((a, b) => a[0].localeCompare(b[0]));
    
    container.innerHTML = `
      <div class="flex md:flex-col items-center gap-2">
        ${sortedClasses.map(([className, count]) => {
          const avatarFile = classAvatars[className] || classAvatars['default'];
          const avatarPath = `/images/avatars/${avatarFile}`;
          const opacityClass = count === 0 ? 'opacity-40' : 'opacity-100';
          const displayName = classDisplayNames[className] || className;
          
          return `
            <div class="relative w-6 h-6 group flex-shrink-0 ${opacityClass}" 
                 title="${displayName}: ${count}">
              <div class="w-full h-full rounded border ${count > 0 ? 'border-white/20' : 'border-white/10'} overflow-hidden shadow-lg group-hover:scale-110 transition-transform">
                <img src="${avatarPath}" alt="${className}" class="w-full h-full object-cover" />
                <div class="absolute inset-0 bg-gradient-to-t from-black/60 to-transparent"></div>
              </div>
              ${count > 0 ? `
                <span class="absolute -top-1 -right-1 bg-amber-500 text-white text-[9px] font-bold rounded-full w-3.5 h-3.5 flex items-center justify-center shadow-md">
                  ${count}
                </span>
              ` : ''}
            </div>
          `;
        }).join('')}
      </div>
    `;
    
    if (players.length === 0) {
      container.innerHTML = '<div class="text-xs text-gray-400 text-center italic">Sin jugadores</div>';
    }
  }

  function openRaidLeadersModal(leaders, raidName = '', raidSchedule = '') {
    const modal = document.getElementById('raid-leaders-modal');
    const list = document.getElementById('raid-leaders-list');
    const summary = document.getElementById('raid-leaders-summary');
    const titleEl = modal?.querySelector('h3');
    if (!modal || !list) return;

    if (titleEl) {
      titleEl.innerHTML = `
        <svg class="w-5 h-5 inline-block mr-2 -mt-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z"></path>
        </svg>
        Líderes: ${raidName} <span class="text-sm font-normal text-amber-400/70 ml-1">(${raidSchedule})</span>
      `;
    }

    list.innerHTML = '';
    const leaderList = Array.isArray(leaders) ? leaders : [];

    if (leaderList.length > 0) {
      // Sort leaders by class and then by name
      leaderList.sort((a, b) => {
        const classA = normalizeClassName(a.player_class || a.class || '').toLowerCase();
        const classB = normalizeClassName(b.player_class || b.class || '').toLowerCase();
        if (classA !== classB) return classA.localeCompare(classB);
        
        const nameA = (a.player_name || a.name || '').toLowerCase();
        const nameB = (b.player_name || b.name || '').toLowerCase();
        return nameA.localeCompare(nameB);
      });

      // For leaders, we don't necessarily need grouping by role if there are few,
      // but let's keep it consistent or just list them
      leaderList.forEach((leader) => {
        const playerWithRole = {
          ...leader,
          player_role: leader.player_role || leader.role || 'default',
        };
        const el = createPlayerElement(playerWithRole, true);
        if (el) list.appendChild(el);
      });
    }

    updateSummarySidebar(summary, leaderList);

    if (list.children.length === 0) {
      showNoDataMessage(list, 'leader');
    }

    // Calculate legend counts - para líderes, todos son líderes
    const leaderCount = leaderList.length;
    const guildCount = leaderList.filter(p => p.is_guild_member && !p.is_sanctioned).length;
    const posadaCount = leaderList.filter(p => p.is_guild_member === false && p.from_supabase).length;
    const sancionadoCount = leaderList.filter(p => p.is_sanctioned).length;
    
    const legendEl = document.getElementById('raid-leaders-legend');
    if (legendEl) {
      legendEl.innerHTML = `
        <div class="grid grid-cols-2 sm:grid-cols-4 gap-x-4 gap-y-3">
          <div class="flex items-center gap-2 group cursor-help" title="Líderes de Banda">
          <div class="flex-shrink-0 flex items-center justify-center w-6 h-6 bg-amber-500/10 rounded-full border border-amber-500/30 shadow-[0_0_10px_rgba(251,191,36,0.2)]">
            <svg class="w-3.5 h-3.5 text-amber-400 drop-shadow-[0_0_5px_rgba(251,191,36,0.8)]" fill="currentColor" viewBox="0 0 32 32">
              <path d="M29.273 22.896l1.593 0.252-0.945-1.164 0.012-0.017h-0.026l-13.872-17.076-4.264 3.134-11.224-6.487v2.104l11.552 6.678 3.535-2.587 10.094 12.463-15.852-2.514 0.51-4.446-9.839-5.694v2.196l3.626 2.097 1.388 6.633 1.083-5.204 1.592 0.92-0.62 5.284 0.019 0.003 1.425 7.753 0.667-3.645 1.245 7.298 1.773-10.45 1.347 7.328 1.269-6.937 1.105 2.248 0.998-2.040 1.175 0.186 1.376 8.297 1.3-7.874 0.799 0.126 1.531 3.931 0.922-2.379 1.129 6.14 1.099-6.008 1.047 1.466z"></path>
            </svg>
          </div>
          <div class="flex flex-col leading-none">
            <span class="text-[10px] font-bold text-amber-400">${leaderCount}</span>
            <span class="text-[8px] font-black text-amber-200/50 uppercase tracking-tighter">Líderes</span>
          </div>
        </div>
          <div class="flex items-center gap-2 group cursor-help" title="Miembros de Hermandad">
          <div class="flex-shrink-0 flex items-center justify-center w-6 h-6 bg-purple-500/10 rounded-full border border-purple-500/30 shadow-[0_0_10px_rgba(168,85,247,0.2)]">
            <svg class="w-3.5 h-3.5 text-purple-400 drop-shadow-[0_0_5px_rgba(168,85,247,0.8)]" fill="currentColor" viewBox="0 0 32 32">
              <path d="M27.745 9.605c-2.737-4.441-7.647-7.397-11.759-8.808-1.394 0.445-2.781 1.056-4.12 1.823l5.301 4.128-1.447 1.463 5.196 3.968-9.746-3.045 1.995-1.925-5.295-1.681c-1.311 1.189-2.512 2.553-3.546 4.078 2.827 7.594 2.827 9.077 0 16.671 7.648 5.84 15.714 6.117 23.422 0-2.313-7.594-2.313-9.076 0-16.671zM23.884 17.982c-1.965-0.982-3.885-1.598-5.787-1.841-0.751 4.757-0.732 9.514 0.155 14.271h-3.73c1.153-4.768 0.981-9.535 0.143-14.303-1.956 0.217-3.908 0.839-5.884 1.873v-4.45c4.971-1.398 10.449-0.936 15.103 0v4.45z"></path>
            </svg>
          </div>
          <div class="flex flex-col leading-none">
            <span class="text-[10px] font-bold text-purple-400">${guildCount}</span>
            <span class="text-[8px] font-black text-purple-200/50 uppercase tracking-tighter">Hermandad</span>
          </div>
        </div>
          <div class="flex items-center gap-2 group cursor-help" title="Sancionados">
          <div class="flex-shrink-0 flex items-center justify-center w-6 h-6 bg-red-500/10 rounded-full border border-red-500/30 shadow-[0_0_10px_rgba(239,68,68,0.2)]">
            <svg class="w-3.5 h-3.5 text-red-400 drop-shadow-[0_0_5px_rgba(239,68,68,0.8)]" fill="currentColor" viewBox="0 0 32 32">
              <path d="M31.155 18.938c0-6.615-2.188-14.287-7.774-17.897l-0-0-1.472 2.277c1.418 0.873 2.163 1.681 2.882 3.109-0.497 0.689-0.87 1.521-1.182 2.46 0.254 0.566 0.438 1.576 0.439 2.245l-2.24-0.366-1.934 2.123-1.555-3.185c-2.045 2.515-2.658 3.571-5.821 3.356l-0.894-2.757-3.188 0.618c0 0-0.581-3.176-1.557-3.887 0.274-1.145 1.090-2.159 2.579-3.071l-1.414-2.619c-5.176 3.629-7.281 10.84-7.281 17.594 5.797 2.916 7.527 6.229 7.205 9.745 0.864 0.487 1.758 0.97 2.806 1.251 1.433 0.384 2.97 0.569 4.55 0.569s3.199-0.184 4.702-0.569c1.361-0.348 2.595-0.892 3.716-1.555-0.050-3.421 1.814-6.8 7.432-9.441zM11.72 20.697c-1.763 1.018-3.823 0.757-4.585-0.563-0.435-0.754-0.341-1.688 0.134-2.547l-0-0c0.801-0.014 1.745-0.175 2.762-0.563 0.969-0.37 1.876-0.877 2.601-1.421 0.374 0.197 0.701 0.493 0.912 0.858 0.762 1.32-0.060 3.218-1.823 4.236zM13.42 27.085c0.616-2.254 1.356-4.509 2.529-6.763 0-0-0-0-0-0h0c0 0-0 0-0 0 1.156 2.254 2.074 4.509 2.529 6.763-1.686-0.514-3.372-0.583-5.058 0zM24.757 20.134c-0.762 1.32-2.822 1.581-4.585 0.563s-2.586-2.916-1.823-4.236c0.211-0.365 0.537-0.661 0.912-0.858 0.724 0.544 1.632 1.051 2.601 1.421 1.017 0.389 1.961 0.549 2.762 0.563l-0 0c0.475 0.859 0.569 1.793 0.134 2.547zM6.584 7.391c0.33-0.871 0.554-1.926 1.621-2.612zM25.137 6.748c-0.363-0.688-0.965-1.891-1.689-2.431z"></path>
            </svg>
          </div>
          <div class="flex flex-col leading-none">
            <span class="text-[10px] font-bold text-red-400">${sancionadoCount}</span>
            <span class="text-[8px] font-black text-red-200/50 uppercase tracking-tighter">Sancionados</span>
          </div>
        </div>
          <div class="flex items-center gap-2 group cursor-help" title="Posada">
          <div class="flex-shrink-0 flex items-center justify-center w-6 h-6 bg-blue-500/10 rounded-full border border-blue-500/30 shadow-[0_0_10px_rgba(59,130,246,0.2)]">
            <svg class="w-3.5 h-3.5 text-blue-400 drop-shadow-[0_0_5px_rgba(59,130,246,0.8)]" fill="currentColor" viewBox="0 0 32 32">
              <path d="M15.474 1.384c-1.851 0.24-3.295 2.252-3.295 4.679 0 1.344 0.461 2.545 1.171 3.401-3.849 0.723-4.14 7.203-4.14 11.753h2.669l0.708 9.494h6.781l0.626-9.494h2.533c0-4.562 0.092-11.156-4.112-11.807 0.68-0.852 1.117-2.035 1.117-3.346 0-2.589-1.65-4.679-3.677-4.679-0.127 0-0.258-0.016-0.381 0l0-0zM21.163 1.355c2.027 0 3.681 2.075 3.681 4.665 0 1.311-0.45 2.501-1.13 3.353 4.204 0.651 4.118 7.245 4.118 11.807h-2.514l-0.656 9.511h-3.936l0.619-9.511h2.551c0-4.562 0.086-11.156-4.118-11.807 0.68-0.851 1.13-2.041 1.13-3.353 0-1.662-0.69-3.106-1.713-3.936 0.472-0.389 0.98-0.653 1.567-0.729 0.123-0.016 0.274 0 0.401 0zM12.542 2.084c-1.017 0.838-1.713 2.278-1.713 3.936 0 1.345 0.456 2.57 1.166 3.426-3.849 0.723-4.118 7.185-4.118 11.734h2.66l0.692 9.511h-3.936l-0.692-9.511h-2.697c0-4.549 0.306-11.011 4.154-11.734-0.71-0.856-1.166-2.081-1.166-3.426 0-2.427 1.429-4.424 3.28-4.665 0.123-0.016 0.274 0 0.401 0 0.726 0 1.397 0.266 1.968 0.729z"></path>
            </svg>
          </div>
          <div class="flex flex-col leading-none">
            <span class="text-[10px] font-bold text-blue-400">${posadaCount}</span>
            <span class="text-[8px] font-black text-blue-200/50 uppercase tracking-tighter">Posada</span>
          </div>
        </div>
      `;
    }

    modal.classList.remove('hidden');
  }

  function createRoleSection(role, players) {
    if (players.length === 0) return null;
    
    const section = document.createElement('div');
    section.className = 'col-span-full mb-4';
    
    const roleConfigMap = {
      tank: { label: 'TANQUES', color: 'text-blue-400', border: 'border-blue-500/30', icon: '<svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24"><path d="M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4zm0 10.99h7c-.53 4.12-3.28 7.79-7 8.94V12H5V6.3l7-3.11v8.8z"/></svg>' },
      healer: { label: 'SANADORES', color: 'text-green-400', border: 'border-green-500/30', icon: '<svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></svg>' },
      melee: { label: 'CUERPO A CUERPO', color: 'text-red-400', border: 'border-blue-500/30', icon: '<svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24"><path d="M19.37 15.83L11.5 8 10 9.5l7.83 7.87-1.42 1.42L8.54 11 7.13 12.41 15 20.28l-1.41 1.41L5.72 13.83l-1.41 1.41L2.89 13.83l1.41-1.41L2.89 11l1.41-1.41L5.72 8.17l1.41 1.41L15 1.72l1.41 1.41-7.87 7.87 1.42 1.42 7.83-7.83 1.42 1.42-7.83 7.83 1.41 1.41 1.41-1.41z"/></svg>' },
      ranged: { label: 'DISTANCIA', color: 'text-purple-400', border: 'border-green-500/30', icon: '<svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24"><path d="M20.47 4.11L19.89 3.53a1.5 1.5 0 0 0-2.12 0L13 8.3L11.59 6.88L13 5.47L11.59 4.05L10.17 5.47L8.76 4.05L4.5 8.31L5.93 9.73L7.34 8.31L8.76 9.73L7.34 11.14L8.76 12.56L13.72 7.59L15.14 9L10.3 13.84a1.5 1.5 0 0 0 0 2.12l.58.58a1.5 1.5 0 0 0 2.12 0L20.47 6.23a1.5 1.5 0 0 0 0-2.12zM5.5 18.5a1 1 0 1 1-2 0 1 1 0 0 1 2 0z"/></svg>' },
      sanctioned: { label: 'SANCIONADOS', color: 'text-red-500', border: 'border-red-500/30', icon: '<svg class="w-4 h-4" fill="currentColor" viewBox="0 0 32 32"><path d="M31.155 18.938c0-6.615-2.188-14.287-7.774-17.897l-0-0-1.472 2.277c1.418 0.873 2.163 1.681 2.882 3.109-0.497 0.689-0.87 1.521-1.182 2.46 0.254 0.566 0.438 1.576 0.439 2.245l-2.24-0.366-1.934 2.123-1.555-3.185c-2.045 2.515-2.658 3.571-5.821 3.356l-0.894-2.757-3.188 0.618c0 0-0.581-3.176-1.557-3.887 0.274-1.145 1.090-2.159 2.579-3.071l-1.414-2.619c-5.176 3.629-7.281 10.84-7.281 17.594 5.797 2.916 7.527 6.229 7.205 9.745 0.864 0.487 1.758 0.97 2.806 1.251 1.433 0.384 2.97 0.569 4.55 0.569s3.199-0.184 4.702-0.569c1.361-0.348 2.595-0.892 3.716-1.555-0.050-3.421 1.814-6.8 7.432-9.441zM11.72 20.697c-1.763 1.018-3.823 0.757-4.585-0.563-0.435-0.754-0.341-1.688 0.134-2.547l-0-0c0.801-0.014 1.745-0.175 2.762-0.563 0.969-0.37 1.876-0.877 2.601-1.421 0.374 0.197 0.701 0.493 0.912 0.858 0.762 1.32-0.060 3.218-1.823 4.236zM13.42 27.085c0.616-2.254 1.356-4.509 2.529-6.763 0-0-0-0-0-0h0c0 0-0 0-0 0 1.156 2.254 2.074 4.509 2.529 6.763-1.686-0.514-3.372-0.583-5.058 0zM24.757 20.134c-0.762 1.32-2.822 1.581-4.585 0.563s-2.586-2.916-1.823-4.236c0.211-0.365 0.537-0.661 0.912-0.858 0.724 0.544 1.632 1.051 2.601 1.421 1.017 0.389 1.961 0.549 2.762 0.563l-0 0c0.475 0.859 0.569 1.793 0.134 2.547zM6.584 7.391c0.33-0.871 0.554-1.926 1.621-2.612zM25.137 6.748c-0.363-0.688-0.965-1.891-1.689-2.431z"/></svg>' },
      default: { label: 'OTROS', color: 'text-gray-400', border: 'border-gray-500/30', icon: '<svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z"/></svg>' }
    };
    
    const config = roleConfigMap[role] || roleConfigMap.default;
    
    section.innerHTML = `
      <div class="role-header flex items-center gap-2 mb-2 px-1 cursor-pointer group/header select-none">
        <div class="${config.color}">${config.icon}</div>
        <h4 class="text-[10px] font-black tracking-widest ${config.color}">${config.label}</h4>
        <div class="flex-1 h-[1px] bg-gradient-to-r from-white/10 to-transparent ml-2"></div>
        <span class="text-[10px] font-bold text-white/40 mr-2">${players.length}</span>
        <svg class="w-3 h-3 text-white/20 group-hover/header:text-white/50 transition-transform transform chevron-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
        </svg>
      </div>
      <div class="role-grid grid grid-cols-2 gap-2 transition-all duration-300"></div>
    `;
    
    const header = section.querySelector('.role-header');
    const grid = section.querySelector('.role-grid');
    const chevron = section.querySelector('.chevron-icon');
    
    header.onclick = () => {
      const isHidden = grid.classList.contains('hidden');
      if (isHidden) {
        grid.classList.remove('hidden');
        chevron.classList.remove('-rotate-90');
      } else {
        grid.classList.add('hidden');
        chevron.classList.add('-rotate-90');
      }
    };
    
    players.forEach(player => {
      const el = createPlayerElement(player, player.is_leader || false);
      if (el) grid.appendChild(el);
    });
    
    return section;
  }

  function openRegularPlayersModal(players, raidName = '', raidSchedule = '', minGS = 0) {
    const modal = document.getElementById('regular-players-modal');
    const list = document.getElementById('regular-players-list');
    const summary = document.getElementById('regular-players-summary');
    const titleEl = modal?.querySelector('h3');
    if (!modal || !list) return;

    if (titleEl) {
      titleEl.innerHTML = `
        <div class="flex items-center flex-wrap gap-x-2 text-[15px] md:text-base">
          <svg class="w-5 h-5 text-blue-400 shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>
          </svg>
          <span class="text-white font-bold whitespace-nowrap">Core: ${raidName}</span>
          <div class="flex items-center gap-1 bg-amber-900/30 px-1.5 py-0.5 rounded border border-amber-500/20 shrink-0">
            <span class="text-[10px] text-amber-500/70 font-bold uppercase tracking-tighter">GS MÍN:</span>
            <span class="text-xs text-amber-400 font-black font-mono">${minGS}</span>
          </div>
          <span class="text-blue-400/70 italic font-medium whitespace-nowrap">${raidSchedule}</span>
          <span class="text-xs font-bold text-white/40">[${players.length}]</span>
        </div>
      `;
    }

    list.innerHTML = '';
    const playerList = Array.isArray(players) ? players : [];

    if (playerList.length > 0) {
      // Group players by role
      const groups = {
        tank: [],
        healer: [],
        melee: [],
        ranged: [],
        default: [],
        sanctioned: []
      };

      playerList.forEach((player) => {
        // If player is sanctioned, put in sanctioned group regardless of role
        if (player.is_sanctioned) {
          groups.sanctioned.push(player);
          return;
        }

        const role = (player.player_role || player.role || 'default').toLowerCase();
        
        if (role.includes('tank') || role.includes('tanque')) {
          groups.tank.push(player);
        } else if (role.includes('heal') || role.includes('sanador') || role.includes('sanación') || role.includes('healer')) {
          groups.healer.push(player);
        } else if (role.includes('melee') || role.includes('cuerpo a cuerpo') || role.includes('melee_dps')) {
          groups.melee.push(player);
        } else if (role.includes('ranged') || role.includes('distancia') || role.includes('rango') || role.includes('ranged_dps')) {
          groups.ranged.push(player);
        } else {
          groups.default.push(player);
        }
      });

    // Sort each group by class and then by name
    Object.keys(groups).forEach(role => {
      groups[role].sort((a, b) => {
        const classA = normalizeClassName(a.player_class || a.class || '').toLowerCase();
        const classB = normalizeClassName(b.player_class || b.class || '').toLowerCase();
        if (classA !== classB) return classA.localeCompare(classB);
        
        const nameA = (a.player_name || a.name || '').toLowerCase();
        const nameB = (b.player_name || b.name || '').toLowerCase();
        return nameA.localeCompare(nameB);
      });
    });

    // Create sections in order
    ['tank', 'healer', 'melee', 'ranged', 'default', 'sanctioned'].forEach(role => {
      const section = createRoleSection(role, groups[role]);
      if (section) list.appendChild(section);
    });
    }

    updateSummarySidebar(summary, playerList);

    if (list.children.length === 0) {
      showNoDataMessage(list, 'regular');
    }

    // Calculate legend counts
    const leaderCount = playerList.filter(p => p.is_leader).length;
    const guildCount = playerList.filter(p => p.is_guild_member && !p.is_sanctioned).length;
    const posadaCount = playerList.filter(p => p.is_guild_member === false && p.from_supabase).length;
    const sancionadoCount = playerList.filter(p => p.is_sanctioned).length;
    
    const legendEl = document.getElementById('regular-players-legend');
    if (legendEl) {
      legendEl.innerHTML = `
        <div class="grid grid-cols-2 sm:grid-cols-4 gap-x-4 gap-y-3">
          <div class="flex items-center gap-2 group cursor-help" title="Líderes de Banda">
            <div class="flex-shrink-0 flex items-center justify-center w-6 h-6 bg-amber-500/10 rounded-full border border-amber-500/30 shadow-[0_0_10px_rgba(251,191,36,0.2)]">
              <svg class="w-3.5 h-3.5 text-amber-400 drop-shadow-[0_0_5px_rgba(251,191,36,0.8)]" fill="currentColor" viewBox="0 0 32 32">
                <path d="M29.273 22.896l1.593 0.252-0.945-1.164 0.012-0.017h-0.026l-13.872-17.076-4.264 3.134-11.224-6.487v2.104l11.552 6.678 3.535-2.587 10.094 12.463-15.852-2.514 0.51-4.446-9.839-5.694v2.196l3.626 2.097 1.388 6.633 1.083-5.204 1.592 0.92-0.62 5.284 0.019 0.003 1.425 7.753 0.667-3.645 1.245 7.298 1.773-10.45 1.347 7.328 1.269-6.937 1.105 2.248 0.998-2.040 1.175 0.186 1.376 8.297 1.3-7.874 0.799 0.126 1.531 3.931 0.922-2.379 1.129 6.14 1.099-6.008 1.047 1.466z"></path>
              </svg>
            </div>
            <div class="flex flex-col leading-none">
              <span class="text-[10px] font-bold text-amber-400">${leaderCount}</span>
              <span class="text-[8px] font-black text-amber-200/50 uppercase tracking-tighter">Líderes</span>
            </div>
          </div>

          <div class="flex items-center gap-2 group cursor-help" title="Miembros de Hermandad">
            <div class="flex-shrink-0 flex items-center justify-center w-6 h-6 bg-purple-500/10 rounded-full border border-purple-500/30 shadow-[0_0_10px_rgba(168,85,247,0.2)]">
              <svg class="w-3.5 h-3.5 text-purple-400 drop-shadow-[0_0_5px_rgba(168,85,247,0.8)]" fill="currentColor" viewBox="0 0 32 32">
                <path d="M27.745 9.605c-2.737-4.441-7.647-7.397-11.759-8.808-1.394 0.445-2.781 1.056-4.12 1.823l5.301 4.128-1.447 1.463 5.196 3.968-9.746-3.045 1.995-1.925-5.295-1.681c-1.311 1.189-2.512 2.553-3.546 4.078 2.827 7.594 2.827 9.077 0 16.671 7.648 5.84 15.714 6.117 23.422 0-2.313-7.594-2.313-9.076 0-16.671zM23.884 17.982c-1.965-0.982-3.885-1.598-5.787-1.841-0.751 4.757-0.732 9.514 0.155 14.271h-3.73c1.153-4.768 0.981-9.535 0.143-14.303-1.956 0.217-3.908 0.839-5.884 1.873v-4.45c4.971-1.398 10.449-0.936 15.103 0v4.45z"></path>
              </svg>
            </div>
            <div class="flex flex-col leading-none">
              <span class="text-[10px] font-bold text-purple-400">${guildCount}</span>
              <span class="text-[8px] font-black text-purple-200/50 uppercase tracking-tighter">Hermandad</span>
            </div>
          </div>

          <div class="flex items-center gap-2 group cursor-help" title="Posada">
            <div class="flex-shrink-0 flex items-center justify-center w-6 h-6 bg-blue-500/10 rounded-full border border-blue-500/30 shadow-[0_0_10px_rgba(59,130,246,0.2)]">
              <svg class="w-3.5 h-3.5 text-blue-400 drop-shadow-[0_0_5px_rgba(59,130,246,0.8)]" fill="currentColor" viewBox="0 0 32 32">
                <path d="M15.474 1.384c-1.851 0.24-3.295 2.252-3.295 4.679 0 1.344 0.461 2.545 1.171 3.401-3.849 0.723-4.14 7.203-4.14 11.753h2.669l0.708 9.494h6.781l0.626-9.494h2.533c0-4.562 0.092-11.156-4.112-11.807 0.68-0.852 1.117-2.035 1.117-3.346 0-2.589-1.65-4.679-3.677-4.679-0.127 0-0.258-0.016-0.381 0l0-0zM21.163 1.355c2.027 0 3.681 2.075 3.681 4.665 0 1.311-0.45 2.501-1.13 3.353 4.204 0.651 4.118 7.245 4.118 11.807h-2.514l-0.656 9.511h-3.936l0.619-9.511h2.551c0-4.562 0.086-11.156-4.118-11.807 0.68-0.851 1.13-2.041 1.13-3.353 0-1.662-0.69-3.106-1.713-3.936 0.472-0.389 0.98-0.653 1.567-0.729 0.123-0.016 0.274 0 0.401 0zM12.542 2.084c-1.017 0.838-1.713 2.278-1.713 3.936 0 1.345 0.456 2.57 1.166 3.426-3.849 0.723-4.118 7.185-4.118 11.734h2.66l0.692 9.511h-3.936l-0.692-9.511h-2.697c0-4.549 0.306-11.011 4.154-11.734-0.71-0.856-1.166-2.081-1.166-3.426 0-2.427 1.429-4.424 3.28-4.665 0.123-0.016 0.274 0 0.401 0 0.726 0 1.397 0.266 1.968 0.729z"></path>
              </svg>
            </div>
            <div class="flex flex-col leading-none">
              <span class="text-[10px] font-bold text-blue-400">${posadaCount}</span>
              <span class="text-[8px] font-black text-blue-200/50 uppercase tracking-tighter">Posada</span>
            </div>
          </div>

          <div class="flex items-center gap-2 group cursor-help" title="Sancionado">
            <div class="flex-shrink-0 flex items-center justify-center w-6 h-6 bg-red-500/10 rounded-full border border-red-500/30 shadow-[0_0_10px_rgba(239,68,68,0.2)]">
              <svg class="w-3.5 h-3.5 text-red-400 drop-shadow-[0_0_5px_rgba(239,68,68,0.8)]" fill="currentColor" viewBox="0 0 32 32">
                <path d="M31.155 18.938c0-6.615-2.188-14.287-7.774-17.897l-0-0-1.472 2.277c1.418 0.873 2.163 1.681 2.882 3.109-0.497 0.689-0.87 1.521-1.182 2.46 0.254 0.566 0.438 1.576 0.439 2.245l-2.24-0.366-1.934 2.123-1.555-3.185c-2.045 2.515-2.658 3.571-5.821 3.356l-0.894-2.757-3.188 0.618c0 0-0.581-3.176-1.557-3.887 0.274-1.145 1.090-2.159 2.579-3.071l-1.414-2.619c-5.176 3.629-7.281 10.84-7.281 17.594 5.797 2.916 7.527 6.229 7.205 9.745 0.864 0.487 1.758 0.97 2.806 1.251 1.433 0.384 2.97 0.569 4.55 0.569s3.199-0.184 4.702-0.569c1.361-0.348 2.595-0.892 3.716-1.555-0.050-3.421 1.814-6.8 7.432-9.441zM11.72 20.697c-1.763 1.018-3.823 0.757-4.585-0.563-0.435-0.754-0.341-1.688 0.134-2.547l-0-0c0.801-0.014 1.745-0.175 2.762-0.563 0.969-0.37 1.876-0.877 2.601-1.421 0.374 0.197 0.701 0.493 0.912 0.858 0.762 1.32-0.060 3.218-1.823 4.236zM13.42 27.085c0.616-2.254 1.356-4.509 2.529-6.763 0-0-0-0-0-0h0c0 0-0 0-0 0 1.156 2.254 2.074 4.509 2.529 6.763-1.686-0.514-3.372-0.583-5.058 0zM24.757 20.134c-0.762 1.32-2.822 1.581-4.585 0.563s-2.586-2.916-1.823-4.236c0.211-0.365 0.537-0.661 0.912-0.858 0.724 0.544 1.632 1.051 2.601 1.421 1.017 0.389 1.961 0.549 2.762 0.563l-0 0c0.475 0.859 0.569 1.793 0.134 2.547zM6.584 7.391c0.33-0.871 0.554-1.926 1.621-2.612zM25.137 6.748c-0.363-0.688-0.965-1.891-1.689-2.431z"></path>
              </svg>
            </div>
            <div class="flex flex-col leading-none">
              <span class="text-[10px] font-bold text-red-400">${sancionadoCount}</span>
              <span class="text-[8px] font-black text-red-200/50 uppercase tracking-tighter">Sancionado</span>
            </div>
          </div>
        </div>
      `;
    }

    modal.classList.remove('hidden');
  }

  function closeRaidLeadersModal() {
    document.getElementById('raid-leaders-modal')?.classList.add('hidden');
  }

  function closeRegularPlayersModal() {
    document.getElementById('regular-players-modal')?.classList.add('hidden');
  }
  // Función para manejar el clic en el botón "Unirse al Raid"
  function handleJoinRaid(button) {
    const raidName = button.getAttribute('data-raid-name');
    const minGearScore = button.getAttribute('data-min-gear-score');
    const raidId = button.getAttribute('data-raid-id');

    // Actualizar el título y los campos del formulario
    document.getElementById('raid-title').textContent = raidName;
    document.getElementById('gear-score').min = minGearScore;
    document.getElementById('gear-score').value = minGearScore;
    document.getElementById('min-gear-score').textContent = minGearScore;

    // Almacenar el ID de la raid en una variable global
    window.currentRaidId = raidId;

    // Mostrar el formulario
    document.getElementById('register-section').classList.remove('hidden');

    // Desplazarse suavemente al formulario
    button.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
  }

  document.addEventListener('DOMContentLoaded', () => {
    const form = document.getElementById('registration-form');
    const formErrors = document.getElementById('form-errors');
    const errorMessage = document.getElementById('error-message');
    const raidTitle = document.getElementById('raid-title');
    let currentRaidId = null; // Variable para almacenar el ID de la raid actual

    // Función para mostrar mensajes de éxito
    function showSuccess(message) {
      formErrors.className =
        'bg-green-900/50 border border-green-700 text-green-200 p-4 rounded mb-4';
      errorMessage.textContent = message;
      formErrors.classList.remove('hidden');

      // Ocultar el mensaje después de 5 segundos
      setTimeout(() => {
        formErrors.classList.add('hidden');
      }, 5000);
    }

    // Función para mostrar errores
    function showError(message) {
      formErrors.className = 'bg-red-900/50 border border-red-700 text-red-200 p-4 rounded mb-4';
      errorMessage.textContent = message;
      formErrors.classList.remove('hidden');

      // Hacer scroll al formulario de error
      formErrors.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }

    // Función para ocultar mensajes
    function hideErrors() {
      formErrors.classList.add('hidden');
    }

    // Helper function to get form data as object
    function getFormData(formElement) {
      const formData = new FormData(formElement);
      const data = {};

      for (let [key, value] of formData.entries()) {
        // Convert string 'true'/'false' to boolean
        if (value === 'true') value = true;
        if (value === 'false') value = false;

        // Handle multiple values for the same key (like checkboxes)
        if (data[key] !== undefined) {
          if (!Array.isArray(data[key])) {
            data[key] = [data[key]];
          }
          data[key].push(value);
        } else {
          data[key] = value;
        }
      }

      return data;
    }

    // Form submission handler
    if (form) {
      form.addEventListener('submit', async (e) => {
        e.preventDefault();
        hideErrors();

        const submitButton = form.querySelector('button[type="submit"]');
        const formData = new FormData(form);

        // Agregar el ID de la raid al formulario si no está presente
        if (!formData.get('raid_id')) {
          if (window.currentRaidId) {
            formData.append('raid_id', window.currentRaidId);
          } else {
            throw new Error('No se ha seleccionado ninguna raid. Por favor, inténtalo de nuevo.');
          }
        }
        const originalButtonText = submitButton?.innerHTML || 'Enviar';

        try {
          // Deshabilitar botón de envío y mostrar estado de carga
          if (submitButton) {
            submitButton.disabled = true;
            submitButton.innerHTML = `
                <svg class="animate-spin -ml-1 mr-2 h-5 w-5 text-white inline-block" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                  <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                  <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                Enviando...
              `;
          }

          // Enviar datos del formulario
          const response = await fetch(window.location.pathname, {
            method: 'POST',
            body: formData,
            headers: {
              Accept: 'application/json',
            },
          });

          const result = await response.json();

          if (!response.ok) {
            throw new Error(result.error || 'Error al procesar la solicitud');
          }

          // Mostrar mensaje de éxito
          showSuccess('¡Registro exitoso! Tu solicitud ha sido enviada para revisión.');

          // Limpiar el formulario
          form.reset();

          // Cerrar el modal después de 2 segundos
          setTimeout(() => {
            const modal = document.getElementById('register-section');
            if (modal) {
              modal.classList.add('hidden');
            }
          }, 2000);
        } catch (error) {
          console.error('Error al enviar el formulario:', error);
          showError(
            error instanceof Error
              ? error.message
              : 'No se pudo enviar la solicitud. Por favor, inténtalo de nuevo.'
          );
        } finally {
          // Restaurar el botón de envío
          if (submitButton) {
            submitButton.disabled = false;
            submitButton.innerHTML = 'Enviar solicitud';
          }
        }
      });
    }
  });

  // Modal functions
  // Modal functions
  window.openRegistrationModal = function (source) {
    const modal = document.getElementById('register-modal');
    const form = document.getElementById('registration-form');

    if (!modal || !form) return;

    let raidName, raidId, day, time, role, playerClass, playerName;

    // Check if source is a button (DOM element) or a data object
    if (source instanceof Element) {
      // Get data from button dataset
      raidName = source.dataset.raidName;
      raidId = source.dataset.raidId;
      day = source.dataset.day;
      time = source.dataset.time;
      role = source.dataset.role;
      // Clear player specific fields if coming from generic button
      playerClass = '';
      playerName = '';
    } else {
      // Get data from object
      raidName = source.raidName;
      raidId = source.raidId;
      day = source.day;
      time = source.time;
      role = source.role;
      playerClass = source.playerClass || '';
      playerName = source.playerName || '';
    }

    // Update modal UI
    document.getElementById('modal-raid-name').textContent = raidName || 'Raid';
    let scheduleText = `${day} - ${time} hora server`;
    if (day === 'Sin día' || time === 'Sin hora') {
      scheduleText = 'Sin día y/o hora definida';
    }
    document.getElementById('modal-schedule-info').textContent = scheduleText;
    document.getElementById('modal-role-display').textContent = role;

    // Set hidden form fields
    document.getElementById('modal-raid-id').value = raidId?.toUpperCase();
    document.getElementById('modal-day').value = day;
    document.getElementById('modal-time').value = time;
    document.getElementById('modal-player-role').value = role;

    // Pre-fill player name and class if provided (and if fields exist)
    const nameInput = document.getElementById('player-name');
    const classSelect = document.getElementById('player-class');

    if (nameInput && playerName) {
      nameInput.value = playerName;
      // Trigger input event to ensure any validation runs
      nameInput.dispatchEvent(new Event('input'));
    }

    // Filter classes based on role
    filterClassesByRole(role);

    if (classSelect && playerClass) {
      // Try to match class name
      const classMap = {
        Guerrero: 'warrior',
        Paladín: 'paladin',
        Paladin: 'paladin',
        Cazador: 'hunter',
        Pícaro: 'rogue',
        Picaro: 'rogue',
        Sacerdote: 'priest',
        'Caballero de la Muerte': 'death-knight',
        Chamán: 'shaman',
        Chaman: 'shaman',
        Mago: 'mage',
        Brujo: 'warlock',
        Druida: 'druid',
      };

      const mappedClass = classMap[playerClass] || playerClass.toLowerCase();
      classSelect.value = mappedClass;
    }

    // Show modal
    modal.classList.remove('hidden');

    // Reset form errors (but not the form itself if we just filled it)
    document.getElementById('form-errors').classList.add('hidden');
  };

  window.filterClassesByRole = function (role) {
    const classSelect = document.getElementById('player-class');
    if (!classSelect) return;

    const options = classSelect.options;
    const validClasses = {
      tank: ['death-knight', 'druid', 'paladin', 'warrior'],
      healer: ['druid', 'paladin', 'priest', 'shaman'],
      melee: ['death-knight', 'druid', 'paladin', 'rogue', 'shaman', 'warrior'],
      ranged: ['druid', 'hunter', 'mage', 'priest', 'shaman', 'warlock'],
    };

    const allowed = validClasses[role] || [];

    // If no specific restriction (e.g. generic 'dps' or unknown), enable all
    // But if we have a list, filter.

    for (let i = 0; i < options.length; i++) {
      const opt = options[i];
      if (opt.value === '') continue; // Skip placeholder

      if (allowed.length > 0 && !allowed.includes(opt.value)) {
        opt.disabled = true;
        opt.hidden = true; // Hide it visually if supported
      } else {
        opt.disabled = false;
        opt.hidden = false;
      }
    }

    // If currently selected option is disabled, reset
    if (classSelect.selectedOptions.length > 0 && classSelect.selectedOptions[0].disabled) {
      classSelect.value = '';
    }
  };

  window.closeRegistrationModal = function () {
    const modal = document.getElementById('register-modal');
    const form = document.getElementById('registration-form');

    if (modal) {
      modal.classList.add('hidden');
    }

    if (form) {
      form.reset();
      // Reset any disabled/hidden options in class select
      const classSelect = document.getElementById('player-class');
      if (classSelect) {
        Array.from(classSelect.options).forEach((opt) => {
          opt.disabled = false;
          opt.hidden = false;
        });
      }
    }

    const errorDiv = document.getElementById('form-errors');
    if (errorDiv) {
      errorDiv.classList.add('hidden');
    }
  };

  // Close modal when clicking outside
  window.onclick = function (event) {
    const modal = document.getElementById('register-modal');
    if (event.target == modal) {
      window.closeRegistrationModal();
    }

    const rosterModal = document.getElementById('roster-modal');
    if (event.target == rosterModal) {
      window.closeRosterModal();
    }
  };
</script>

<script
  define:vars={{ raidEligibleMembers, raidEligibleMembersRange, raids: JSON.stringify(allAvailableRaids) }}
>
  // Pass server-side data to client
  window.raidEligibleMembers = raidEligibleMembers;
  window.raidEligibleMembersRange = raidEligibleMembersRange;
  const wotlkRaids = JSON.parse(raids);
  window.wotlkRaids = wotlkRaids;

  window.openRosterModal = function (raidId, day = null, time = null, raidName = null) {
    // Normalizar raidId para que coincida con las claves de los objetos de miembros elegibles
    // No usamos toUpperCase() aquí porque las claves se generan a partir de raid.id, que es core.raid original
    const modal = document.getElementById('roster-modal');
    const content = document.getElementById('roster-modal-content');
    const raidNameEl = document.getElementById('roster-modal-raid-name');

    // If raidName is not provided, try to get it from the raid data
    if (!raidName) {
      const raid = wotlkRaids.find((r) => r.id === raidId);
      raidName = raid ? raid.name : `Raid ${raidId}`;
    }

    // Determine which list to use based on context
    // If day/time provided (Schedule context) -> Use ALL eligible members (Min GS only)
    // If NO day/time (General context) -> Use RANGE filtered members (Min GS <= GS < Next Raid Min GS)
    const membersList =
      day && time ? window.raidEligibleMembers[raidId] : window.raidEligibleMembersRange[raidId];

    if (!modal || !content || !membersList) return;

    const members = membersList;
    // Sort members: Tank > Healer > DPS, then by GS desc
    const roleOrder = { T: 1, H: 2, D: 3 };

    members.sort((a, b) => {
      const roleDiff = (roleOrder[a.role] || 99) - (roleOrder[b.role] || 99);
      if (roleDiff !== 0) return roleDiff;
      return b.gearScore - a.gearScore;
    });

    // Group by role with dual role support and GS validation
    const raid = wotlkRaids.find((r) => r.id === raidId);
    const minGS = raid ? raid.minGearScore : 0;

    // Helper to check if a member is eligible for a specific role
    const isEligibleForRole = (member, targetRole) => {
      // Check main role
      if (member.role === targetRole && member.gearScore >= minGS) return true;
      // Check dual role
      if (member.dualRole === targetRole && member.dualGearScore >= minGS) return true;
      return false;
    };

    // Helper to get the effective GS for a specific role
    const getEffectiveGS = (member, targetRole) => {
      if (member.role === targetRole && member.gearScore >= minGS) return member.gearScore;
      if (member.dualRole === targetRole && member.dualGearScore >= minGS)
        return member.dualGearScore;
      return member.gearScore; // Fallback
    };

    const tanks = members
      .filter((m) => isEligibleForRole(m, 'T'))
      .map((m) => ({ ...m, displayGS: getEffectiveGS(m, 'T') }));

    const healers = members
      .filter((m) => isEligibleForRole(m, 'H'))
      .map((m) => ({ ...m, displayGS: getEffectiveGS(m, 'H') }));

    const dps = members
      .filter((m) => isEligibleForRole(m, 'D'))
      .map((m) => ({ ...m, displayGS: getEffectiveGS(m, 'D') }));

    // Helper to render member list
    const renderList = (list, title, colorClass, iconPath, id, roleCode) => {
      if (list.length === 0) return '';

      return `
        <div class="mb-4 last:mb-0 border border-gray-700/50 rounded-md overflow-hidden bg-gray-800/20">
          <button 
            type="button"
            class="w-full flex items-center justify-between p-3 bg-gray-800/50 hover:bg-gray-800 transition-colors"
            onclick="document.getElementById('${id}-content').classList.toggle('hidden'); document.getElementById('${id}-chevron').classList.toggle('rotate-180');"
          >
            <div class="flex items-center">
              <div class="p-1.5 rounded-md ${colorClass} bg-opacity-20 mr-3">
                <svg class="w-4 h-4 ${colorClass.replace('bg-', 'text-')}" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  ${iconPath}
                </svg>
              </div>
              <h4 class="text-sm font-bold text-gray-200 uppercase tracking-wide">${title} <span class="text-xs text-gray-500 ml-1">(${list.length})</span></h4>
            </div>
            <svg id="${id}-chevron" class="w-5 h-5 text-gray-500 transform transition-transform duration-200" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
            </svg>
          </button>
          
          <div id="${id}-content" class="hidden p-3 border-t border-gray-700/50 bg-gray-900/20">
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-2">
              ${list
                .map((m) => {
                  // Determine interaction
                  const isClickable = !!day && !!time;
                  const cursorClass = isClickable ? 'cursor-pointer hover:bg-gray-700/60' : '';
                  const clickHandler = isClickable
                    ? `onclick="selectMemberForRegistration('${m.name}', '${m.class}', '${roleCode}', '${raidId}', '${day}', '${time}')"`
                    : '';

                  return `
                  <div 
                    class="flex items-center justify-between bg-gray-800/40 p-2 rounded border border-gray-700/30 transition-colors ${cursorClass}"
                    ${clickHandler}
                  >
                    <div class="flex items-center overflow-hidden">
                      <img src="/images/avatars/class_${m.class}.jpg" class="w-6 h-6 rounded-full mr-2 object-cover" onerror="this.src='/images/avatars/default.png'" />
                      <span class="text-sm font-medium text-gray-200 truncate">${m.name}</span>
                    </div>
                    <div class="flex items-center ml-2">
                      <span class="text-xs font-mono text-amber-400 bg-amber-900/20 px-1.5 py-0.5 rounded border border-amber-700/30">
                        ${((m.displayGS || m.gearScore) / 1000).toFixed(1)}k
                      </span>
                      ${
                        isClickable
                          ? `
                      <svg class="w-4 h-4 text-gray-500 ml-2 opacity-0 group-hover:opacity-100 transition-opacity" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                      </svg>
                      `
                          : ''
                      }
                    </div>
                  </div>
                `;
                })
                .join('')}
            </div>
          </div>
        </div>
      `;
    };

    const tankIcon =
      '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z" />';
    const healIcon =
      '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z" />';
    const dpsIcon =
      '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" />';

    let html = '';

    if (day && time) {
      html += `<div class="mb-4 p-2 bg-indigo-900/20 border border-indigo-500/30 rounded text-sm text-indigo-200 text-center">
          Selecciona un personaje para invitarlo a la raid del <strong>${day} ${time}</strong>
        </div>`;
    }

    html += renderList(tanks, 'Tanques', 'bg-blue-500', tankIcon, 'tanks', 'T');
    html += renderList(healers, 'Sanadores', 'bg-green-500', healIcon, 'healers', 'H');
    html += renderList(dps, 'DPS', 'bg-red-500', dpsIcon, 'dps', 'D');

    if (html === '') {
      html =
        '<div class="text-center text-gray-400 py-8">No hay miembros elegibles para esta raid.</div>';
    }

    content.innerHTML = html;

    // Set title with raid name
    let title = raidName ? `Personajes en etapa ${raidName}` : '';
    if (day && time) {
      title = 'Invitar personaje de la hermandad';
    }
    raidNameEl.textContent = title;

    modal.classList.remove('hidden');
  };

  window.selectMemberForRegistration = function (name, className, roleCode, raidId, day, time) {
    // Close roster modal
    window.closeRosterModal();

    // Determine refined role based on class if generic DPS
    let finalRole = 'dps';

    if (roleCode === 'T') finalRole = 'tank';
    else if (roleCode === 'H') finalRole = 'healer';
    else if (roleCode === 'D') {
      // Refine DPS to melee or ranged using normalization
      const normalized = normalizeClassName(className);
      
      const meleeClasses = ['warrior', 'paladin', 'deathknight', 'rogue'];
      const rangedClasses = ['mage', 'warlock', 'priest', 'hunter'];

      if (meleeClasses.includes(normalized)) {
        finalRole = 'melee';
      } else if (rangedClasses.includes(normalized)) {
        finalRole = 'ranged';
      } else {
        // Druid/Shaman/Default
        finalRole = 'ranged';
      }
    }

    // Open registration modal with data
    window.openRegistrationModal({
      raidId: raidId,
      day: day,
      time: time,
      role: finalRole,
      playerName: name,
      playerClass: className,
      raidName: document.querySelector(`[data-raid-id="${raidId}"] h3`)?.textContent || 'Raid',
    });
  };

  window.closeRosterModal = function () {
    const modal = document.getElementById('roster-modal');
    if (modal) {
      modal.classList.add('hidden');
    }
  };
</script>

<script is:inline>
  document.addEventListener('DOMContentLoaded', () => {
    const slider = document.querySelector('.slider-container');
    const track = document.querySelector('.slider-track');
    const slides = document.querySelectorAll('.swiper-slide');
    const prevBtn = document.getElementById('slider-prev');
    const nextBtn = document.getElementById('slider-next');
    const dots = document.querySelectorAll('.pagination-dot');

    if (!slider || !track || slides.length === 0 || !prevBtn || !nextBtn) {
      console.error('Slider elements not found');
      return;
    }

    let currentSlide = 0;
    let slideWidth = 0;

    function initSlider() {
      // Set initial slide width
      updateSlideWidth();

      // Set initial positions
      updateSlider();

      // Add event listeners
      addEventListeners();
    }

    function updateSlideWidth() {
      // Get the width of the visible area
      const containerWidth = slider.offsetWidth;
      // Set slide width to 100% of container width
      slideWidth = containerWidth;

      // Set width for each slide
      slides.forEach((slide) => {
        slide.style.width = `${slideWidth}px`;
        slide.style.flexShrink = '0';
      });

      // Set track width to fit all slides
      track.style.width = `${slideWidth * slides.length}px`;
    }

    function updateSlider() {
      // Update track position
      track.style.transform = `translateX(-${currentSlide * slideWidth}px)`;

      // Adjust track height to active slide
      const activeSlide = slides[currentSlide];
      if (activeSlide) {
        // Force a layout recalculation for the active slide height
        const contentHeight = activeSlide.scrollHeight;
        track.style.height = `${contentHeight}px`;
      }

      // Update active dot
      updateDots();

      // Update button states
      updateButtons();
    }

    function updateDots() {
      dots.forEach((dot, index) => {
        dot.classList.toggle('active', index === currentSlide);
      });
    }

    function updateButtons() {
      prevBtn.disabled = currentSlide === 0;
      nextBtn.disabled = currentSlide === slides.length - 1;
    }

    function goToSlide(index) {
      if (index >= 0 && index < slides.length) {
        currentSlide = index;
        updateSlider();
      }
    }

    function addEventListeners() {
      // Listen for image loads to update height
      const sliderImages = track.querySelectorAll('img');
      sliderImages.forEach((img) => {
        img.addEventListener('load', () => {
          if (slides[currentSlide].contains(img)) {
            updateSlider();
          }
        });
      });

      // Navigation buttons
      prevBtn.addEventListener('click', () => {
        if (currentSlide > 0) {
          currentSlide--;
          updateSlider();
        }
      });

      nextBtn.addEventListener('click', () => {
        if (currentSlide < slides.length - 1) {
          currentSlide++;
          updateSlider();
        }
      });

      // Dots navigation - Handle clicks on pagination items
      const paginationItems = document.querySelectorAll('.pagination-item');
      paginationItems.forEach((item, index) => {
        item.addEventListener('click', (e) => {
          e.preventDefault();
          goToSlide(index);
        });
      });

      // Keyboard navigation
      document.addEventListener('keydown', (e) => {
        if (e.key === 'ArrowLeft' && currentSlide > 0) {
          currentSlide--;
          updateSlider();
        } else if (e.key === 'ArrowRight' && currentSlide < slides.length - 1) {
          currentSlide++;
          updateSlider();
        }
      });

      // Handle window resize
      let resizeTimer;
      window.addEventListener('resize', () => {
        clearTimeout(resizeTimer);
        resizeTimer = setTimeout(() => {
          updateSlideWidth();
          updateSlider();
        }, 100);
      });
    }

    // Make updateSlider globally accessible
    window.updateSlider = updateSlider;

    // Initialize the slider
    initSlider();
  });
</script>

<style>
  /* Slider container */
  .swiper-container {
    width: 100%;
    padding: 40px 60px 80px;
    position: relative;
    max-width: 1400px;
    margin: 0 auto;
  }

  /* Slide styles */
  .swiper-slide {
    box-sizing: border-box;
    width: calc(100% - 40px); /* Adjust width to account for padding */
  }

  /* Navigation buttons */
  .swiper-button-next,
  .swiper-button-prev {
    color: #f59e0b;
    width: 44px;
    height: 44px;
    background: rgba(31, 41, 55, 0.9);
    border-radius: 50%;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    top: 50%;
    margin-top: -22px;
    z-index: 10;
  }

  .swiper-button-next {
    right: 0;
  }

  .swiper-button-prev {
    left: 0;
  }

  .swiper-button-next:before,
  .swiper-button-prev:before {
    content: '';
    width: 12px;
    height: 12px;
    border-top: 2px solid #f59e0b;
    border-right: 2px solid #f59e0b;
    position: absolute;
  }

  .swiper-button-next:before {
    transform: rotate(45deg);
    margin-left: -4px;
  }

  .swiper-button-prev:before {
    transform: rotate(-135deg);
    margin-right: -4px;
  }

  .swiper-button-next:hover,
  .swiper-button-prev:hover {
    background: rgba(55, 65, 81, 0.8);
    transform: scale(1.1);
  }

  .swiper-button-next:after,
  .swiper-button-prev:after {
    font-size: 1.2rem;
  }

  .slider-track {
    display: flex;
    align-items: flex-start;
    transition: transform 0.4s ease, height 0.4s ease;
    will-change: transform, height;
  }

  .swiper-slide {
    flex-shrink: 0;
    width: 100%;
    box-sizing: border-box;
  }

  .slider-nav {
    position: absolute;
    top: 63%;
    width: 3rem;
    height: 3rem;
    border-radius: 50%;
    background: rgba(31, 41, 55, 0.9);
    color: #f59e0b;
    border: none;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 10;
    transition: all 0.3s ease;
  }

  .slider-nav:hover {
    background: #1f2937;
  }

  .slider-nav:disabled {
    opacity: 0.3;
    cursor: not-allowed;
  }

  .slider-nav.prev {
    left: 0rem;
  }

  .slider-nav.next {
    right: 0rem;
  }

  .slider-nav svg {
    width: 1.5rem;
    height: 1.5rem;
  }

  .slider-pagination {
    display: flex;
    justify-content: center;
    align-items: center;
    padding: 0.5rem;
    padding-top: 2rem;
    gap: 2rem;
    position: relative;
    z-index: 10;
    margin-bottom: 1rem;
    flex-wrap: wrap;
  }

  .pagination-item {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 0.5rem;
    cursor: pointer;
    transition: all 0.2s ease;
    background: none;
    border: none;
    color: inherit;
    padding: 0.5rem;
    margin: 0;
    font: inherit;
    outline: inherit;
  }

  .pagination-item:focus {
    outline: 2px solid #fbbf24;
    outline-offset: 2px;
    border-radius: 0.25rem;
  }

  .pagination-item:hover .pagination-dot {
    transform: scale(1.1);
  }

  .pagination-item:hover .pagination-label {
    color: #fbbf24; /* amber-400 */
  }

  .pagination-label {
    color: #ffffff; /* white */
    font-size: 0.875rem; /* text-sm */
    font-weight: 700; /* bold */
    transition: color 0.2s ease;
    text-align: center;
    white-space: nowrap;
  }

  .pagination-dot {
    width: 2.5rem;
    height: 0.5rem;
    border-radius: 0.25rem;
    background: #4b5563;
    border: none;
    cursor: pointer;
    padding: 0;
    transition: all 0.3s ease;
  }

  .pagination-dot.active {
    background: #f59e0b;
    transform: scale(1.1);
  }

  .pagination-dot:not(.active):hover {
    background: #6b7280;
  }

  @media (min-width: 768px) {
  }
</style>

<style>
  /* Slider container styles */
  .swiper-container {
    width: 100%;
    overflow: hidden;
    margin-top: 1.5rem;
    gap: 0.5rem;
    padding: 0.5rem 0;
  }

  #pagination button {
    transition: all 0.3s ease;
    border-radius: 9999px;
    cursor: pointer;
    outline: none;
    border: 2px solid transparent;
  }

  #pagination button:hover,
  #pagination button:focus-visible {
    background-color: #f59e0b !important;
    border-color: rgba(245, 158, 11, 0.5);
    transform: scale(1.1);
  }

  #pagination button:active {
    transform: scale(0.95);
  }

  #pagination button {
    transition: all 0.3s ease;
    border-radius: 0.5rem;
  }

  /* Animations */
  @keyframes fadeIn {
    from {
      opacity: 0;
      transform: translateY(10px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .fade-in {
    animation: fadeIn 0.5s ease-out forwards;
  }

  /* Custom scrollbar */
  ::-webkit-scrollbar {
    width: 8px;
    height: 8px;
  }

  ::-webkit-scrollbar-track {
    background: rgba(255, 255, 255, 0.05);
    border-radius: 4px;
  }

  ::-webkit-scrollbar-thumb {
    background: rgba(180, 83, 9, 0.5);
    border-radius: 4px;
  }

  ::-webkit-scrollbar-thumb:hover {
    background: rgba(217, 119, 6, 0.7);
  }

  /* Responsive adjustments */
  @media (max-width: 768px) {
    .container {
      padding-left: 1rem;
      padding-right: 1rem;
    }
  }
</style>
